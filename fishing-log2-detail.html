<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>é‡£æœè©³ç´° - AbyssAtlas</title>
    <link
      rel="icon"
      href="data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22abyss%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 style=%22stop-color:%231a1413;stop-opacity:1%22 /><stop offset=%2250%25%22 style=%22stop-color:%2316191e;stop-opacity:1%22 /><stop offset=%22100%25%22 style=%22stop-color:%230d0a0a;stop-opacity:1%22 /></linearGradient><linearGradient id=%22metalGrad%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 style=%22stop-color:%23ffd700;stop-opacity:0.9%22 /><stop offset=%2250%25%22 style=%22stop-color:%23d4af8c;stop-opacity:1%22 /><stop offset=%22100%25%22 style=%22stop-color:%238b7500;stop-opacity:0.9%22 /></linearGradient></defs><rect width=%22100%22 height=%22100%22 fill=%22url(%23abyss)%22/><polygon points=%2250,20 65,70 50,88 35,70%22 fill=%22url(%23metalGrad)%22 stroke=%22%23ffd700%22 stroke-width=%221.5%22/><polygon points=%2250,25 60,65 50,80 40,65%22 fill=%22none%22 stroke=%22%23ffffff%22 stroke-width=%220.8%22 opacity=%220.6%22/><path d=%22M20 50 Q50 40 80 50 Q50 55 20 50%22 stroke=%22%238b7500%22 stroke-width=%221.5%22 fill=%22none%22 opacity=%220.6%22/><path d=%22M15 60 Q50 50 85 60 Q50 65 15 60%22 stroke=%22%238b7500%22 stroke-width=%221%22 fill=%22none%22 opacity=%220.4%22/></svg>"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="stylesheet-darksoul.css" />
    <script src="scripts/header.js" defer></script>
  </head>
  <body>
    <header role="banner" aria-label="ã‚µã‚¤ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼">
      <div class="container">
        <div class="header-left">
          <a
            class="logo"
            href="index.html"
            aria-label="ãƒ›ãƒ¼ãƒ "
            title="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹"
          >
            <svg
              width="40"
              height="40"
              viewBox="0 0 100 100"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              focusable="false"
            >
              <defs>
                <linearGradient
                  id="abyss-logo3"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #1a1413; stop-opacity: 1"
                  />
                  <stop
                    offset="50%"
                    style="stop-color: #16191e; stop-opacity: 1"
                  />
                  <stop
                    offset="100%"
                    style="stop-color: #0d0a0a; stop-opacity: 1"
                  />
                </linearGradient>
                <linearGradient
                  id="metalGrad-logo3"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #c4d8f0; stop-opacity: 0.9"
                  />
                  <stop
                    offset="50%"
                    style="stop-color: #8099b8; stop-opacity: 1"
                  />
                  <stop
                    offset="100%"
                    style="stop-color: #506080; stop-opacity: 0.9"
                  />
                </linearGradient>
              </defs>
              <polygon
                points="50,20 65,70 50,88 35,70"
                fill="url(#metalGrad-logo3)"
                stroke="#c4d8f0"
                stroke-width="1.5"
              />
              <polygon
                points="50,25 60,65 50,80 40,65"
                fill="none"
                stroke="#ffffff"
                stroke-width="0.8"
                opacity="0.6"
              />
              <path
                d="M20 50 Q50 40 80 50 Q50 55 20 50"
                stroke="#8099b8"
                stroke-width="1.5"
                fill="none"
                opacity="0.6"
              />
            </svg>
          </a>
          <h1
            style="
              color: #c4d8f0;
              font-size: 1.2rem;
              margin: 0;
              text-shadow: 0 0 8px rgba(180, 200, 220, 0.3);
            "
          >
            é‡£æœè©³ç´°
          </h1>
        </div>
        <div
          class="header-right"
          role="navigation"
          aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
        >
          <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
          <a href="fishing-log2.html">é‡£æœä¸€è¦§</a>
          <a href="fishing-log.html">ç™»éŒ²</a>
          <div class="nav-tools">
            <button
              class="tools-btn"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="tools-submenu"
            >
              ãƒ„ãƒ¼ãƒ« â–¾
            </button>
            <div
              id="tools-submenu"
              class="submenu"
              role="menu"
              aria-hidden="true"
            >
              <a role="menuitem" href="pe-converter.html">PEå¤‰æ›</a>
              <a role="menuitem" href="index.html">ãã®ä»–</a>
            </div>
          </div>
          <a href="profile.html">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
        </div>
        <button
          class="menu-icon"
          id="menuIcon"
          aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
          aria-expanded="false"
        >
          <svg
            class="hamburger"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            focusable="false"
          >
            <path
              class="bar bar1"
              d="M4 6h16"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
            />
            <path
              class="bar bar2"
              d="M4 12h16"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
            />
            <path
              class="bar bar3"
              d="M4 18h16"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
    </header>

    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#3a4d6b"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>

    <main class="container">
      <div id="fishinglogs">èª­ã¿è¾¼ã¿ä¸­...</div>
    </main>

    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#3a4d6b"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>

    <button
      id="homeBtn"
      class="home-btn"
      title="ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹"
      aria-label="ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹"
    >
      <svg
        width="22"
        height="22"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        focusable="false"
      >
        <path
          d="M3 10.5L12 4l9 6.5"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M5 10.5v7a1 1 0 0 0 1 1h3v-5h6v5h3a1 1 0 0 0 1-1v-7"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>

    <script type="module">
      import {
        db,
        configValid,
        doc,
        getDoc,
        collection,
        query,
        where,
        getDocs,
        updateDoc,
      } from "./firebase-init.js";

      const urlParams = new URLSearchParams(window.location.search);
      const logId = urlParams.get("id");
      const imgParam = urlParams.get("img");
      const fishinglogsDiv = document.getElementById("fishinglogs");

      // If firebase config is not set, provide a local demo/fallback to aid
      // development. This avoids a blank page when firebase-config.js is
      // a placeholder. Click "ãƒ‡ãƒ¢è¡¨ç¤º" to render sample data.
      if (!configValid) {
        fishinglogsDiv.innerHTML = `
          <div class="site-card">
            <p>Firebase ãŒæœªæ§‹æˆã§ã™ã€‚å®Ÿãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚</p>
            <p>ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ç¢ºèªç”¨ã«ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</p>
            <div style="margin-top:8px"><button id="loadDemo" class="btn">ãƒ‡ãƒ¢è¡¨ç¤º</button></div>
          </div>`;

        document.getElementById("loadDemo").addEventListener("click", () => {
          const demo = {
            catch: {
              imageUrl: "",
              fish: "ã‚·ãƒ­ã‚®ã‚¹",
              date: new Date().toISOString().slice(0, 10),
              size: 23,
              location: "è¿‘æ‰€ã®æ¸¯",
              memo: "æœã¾ãšã‚ã«è‰¯ãé‡£ã‚Œã¾ã—ãŸã€‚",
              rod: "Test Rod",
              reel: "Test Reel",
              line: "PE 0.6",
              lure: "ãƒ¯ãƒ¼ãƒ ",
            },
          };
          showFishingLogData(demo);
        });

        // Mark demo-only mode so the rest of the script doesn't attempt
        // to fetch from Firestore (top-level `return` is invalid in modules).
        window.__fishingLogDetailDemoMode = true;
      }

      function renderError(msg) {
        fishinglogsDiv.innerHTML = `<div class="site-card">${msg}</div>`;
      }

      function getPlaceholderDataUri() {
        const placeholderSvg = `
          <svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
            <rect width='100%' height='100%' fill='#e0e0e0'/>
            <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='32' fill='#666'>No Image</text>
          </svg>`;
        return "data:image/svg+xml;utf8," + encodeURIComponent(placeholderSvg);
      }

      async function showFishingLogData(data) {
        if (!data || !data.catch) return renderError("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™");
        const placeholder = getPlaceholderDataUri();
        const imageUrl = data.catch.imageUrl || placeholder;
        const safeImage = `<img src="${imageUrl}" alt="Catch Image" loading="lazy" onerror="this.onerror=null;this.src='${placeholder}'"/>`;

        // æµ·æ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®è¡¨ç¤º
        let oceanDataHtml = "";
        if (data.catch.oceanData) {
          const od = data.catch.oceanData;
          oceanDataHtml = `
            <div style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95)); border: 2px solid #3a4d6b; border-radius: 2px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);">
              <h4 style="margin: 0 0 8px 0; color: #4db8ff; letter-spacing: 1px; font-weight: 600;">ç™»éŒ²æ™‚ã®æµ·æ³ãƒ‡ãƒ¼ã‚¿</h4>
              <p style="margin: 4px 0; font-size: 0.9rem; color: #8099b8;">
                <strong style="color: #4db8ff;">æ°—æ¸©:</strong> ${
                  od.temperature
                }Â°C | 
                <strong style="color: #4db8ff;">æ°´æ¸©:</strong> ${
                  od.waterTemperature
                }Â°C | 
                <strong style="color: #4db8ff;">é¢¨:</strong> ${
                  od.windSpeed
                }m/s | 
                <strong style="color: #4db8ff;">æ°—åœ§:</strong> ${od.pressure}hPa
              </p>
              <p style="margin: 4px 0; font-size: 0.9rem; color: #8099b8;">
                <strong style="color: #4db8ff;">æ½®ä½:</strong> ${(
                  od.tideHeight * 100
                ).toFixed(0)}cm | 
                <strong style="color: #4db8ff;">æ³¢é«˜:</strong> ${
                  od.waveHeight
                }m | 
                <strong style="color: #4db8ff;">å‘¨æœŸ:</strong> ${od.wavePeriod}s
              </p>
            </div>
            <div id="tideGraphContainer" style="margin-top: 12px; background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95)); border: 2px solid #3a4d6b; border-radius: 2px; padding: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);">
              <p id="tideGraphPlaceholder" style="text-align: center; color: #8099b8; margin: 40px 0;">æ½®ä½ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
              <svg id="tideGraphSvg" style="width: 100%; height: auto; display: none; background: linear-gradient(135deg, rgba(5, 4, 4, 0.9) 0%, rgba(15, 20, 35, 0.85) 100%);"></svg>
            </div>
          `;
        }

        const html = `
          <div class="site-card catch-item">
            <div class="img-wrap"> ${safeImage}</div>
            <div class="meta">
              <h2 style="margin:0 0 8px 0;color:#4db8ff">${
                data.catch.fish || "ä¸æ˜"
              } <small style="color:#6b7b82">${
                data.catch.date || ""
              }</small></h2>
              <p><strong>ã‚µã‚¤ã‚º:</strong> ${data.catch.size || ""} cm${
                data.catch.weight ? " / " + data.catch.weight + " g" : ""
              }</p>
              <p><strong>å ´æ‰€:</strong> ${data.catch.location || ""}</p>
              <p><strong>ãƒ¡ãƒ¢:</strong> ${data.catch.memo || ""}</p>
              ${oceanDataHtml}
              <button id="addOceanDataBtn" class="btn" style="margin-top: 8px; background: linear-gradient(135deg, #6b8fb0, #8099b8); color: white; border: 2px solid #c4d8f0; font-weight: 600; padding: 0.5rem 1rem; border-radius: 2px; cursor: pointer; font-size: 0.9rem;">
                ğŸŒŠ æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ç·¨é›†
              </button>
              <hr />
              <p><strong>ãƒ­ãƒƒãƒ‰:</strong> ${data.catch.rod || ""}</p>
              <p><strong>ãƒªãƒ¼ãƒ«:</strong> ${data.catch.reel || ""}</p>
              <p><strong>ãƒ©ã‚¤ãƒ³:</strong> ${data.catch.line || ""}</p>
              <p><strong>ä»•æ›ã‘/ãƒ«ã‚¢ãƒ¼:</strong> ${data.catch.lure || ""}</p>
            </div>
          </div>`;
        fishinglogsDiv.innerHTML = html;

        // styling fixes for hr and paragraphs
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
          .site-card hr {
            border: none;
            border-top: 1px solid #506080;
            margin: 1rem 0;
          }
          .site-card p {
            color: #c4d8f0;
          }
          .site-card strong {
            color: #a89560;
          }
        `;
        document.head.appendChild(styleSheet);

        // æµ·æ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€æ½®ä½ã‚°ãƒ©ãƒ•ã‚’æç”»
        if (data.catch.oceanData) {
          drawTideGraph(data.catch.oceanData);
        }

        // æµ·æ³ãƒ‡ãƒ¼ã‚¿è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        const addOceanDataBtn = document.getElementById("addOceanDataBtn");
        if (addOceanDataBtn) {
          addOceanDataBtn.addEventListener("click", () => {
            showOceanDataModal(data);
          });
        }
      }

      async function fetchFishingLogById(id) {
        try {
          const docRef = doc(db, "fishinglogs", id);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            data.id = id; // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’è¿½åŠ 
            showFishingLogData(data);
          } else {
            renderError("è©²å½“ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          }
        } catch (err) {
          console.error(err);
          renderError("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
      }

      async function fetchFishingLogByImageUrl(imageUrl) {
        try {
          const q = query(
            collection(db, "fishinglogs"),
            where("catch.imageUrl", "==", imageUrl),
          );
          const querySnapshot = await getDocs(q);
          if (!querySnapshot.empty) {
            showFishingLogData(querySnapshot.docs[0].data());
          } else {
            renderError("ç”»åƒURLã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
          }
        } catch (err) {
          console.error(err);
          renderError("ç”»åƒURLæ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
      }

      // If demo mode is active, do not attempt Firestore calls.
      if (window.__fishingLogDetailDemoMode) {
        // demo UI already rendered above via the button; nothing further.
      } else {
        if (!db) {
          renderError(
            "Firestore ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚firebase-config.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
          );
        } else if (logId) {
          fetchFishingLogById(logId);
        } else if (imgParam) {
          fetchFishingLogByImageUrl(imgParam);
        } else {
          renderError("URLã«idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯imgãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
      }

      // Ensure the home button navigates back to the index page
      try {
        const hb = document.getElementById("homeBtn");
        if (hb)
          hb.addEventListener(
            "click",
            () => (window.location.href = "index.html"),
          );
      } catch (e) {
        console.warn("homeBtn handler failed", e);
      }

      // ================== é‡£æœè©³ç´°ã®æµ·æ³ãƒ‡ãƒ¼ã‚¿æ©Ÿèƒ½ ==================

      // é‡£ã‚Šå ´ãƒ‡ãƒ¼ã‚¿
      const fishingLocations = [
        { name: "å‚æ°´", lat: 34.73, lon: 135.03 },
        { name: "æ˜çŸ³æ¸¯", lat: 34.67, lon: 135.1 },
        { name: "æ±Ÿå´", lat: 34.69, lon: 135.14 },
        { name: "é­šä½", lat: 34.66, lon: 135.21 },
        { name: "å²©å±‹", lat: 34.78, lon: 135.35 },
        { name: "æ³‰å—", lat: 34.38, lon: 135.36 },
        { name: "ç”°å°»", lat: 34.33, lon: 135.37 },
        { name: "æ³‰ä½é‡", lat: 34.37, lon: 135.41 },
        { name: "å‹ãƒ¶å³¶", lat: 34.26, lon: 135.44 },
        { name: "åŠ å¤ª", lat: 34.21, lon: 135.36 },
        { name: "ç”±è‰¯", lat: 33.72, lon: 135.15 },
        { name: "ç™½æµœ", lat: 33.68, lon: 135.36 },
        { name: "ã™ã•ã¿", lat: 33.6, lon: 135.55 },
        { name: "ä¸²æœ¬", lat: 33.48, lon: 135.76 },
        { name: "å°¾é·²", lat: 34.06, lon: 136.23 },
        { name: "ç†Šé‡", lat: 33.9, lon: 136.24 },
        { name: "é³¥ç¾½", lat: 34.48, lon: 136.83 },
        { name: "å¿—æ‘©", lat: 34.31, lon: 136.82 },
        { name: "é–“äºº", lat: 35.67, lon: 135.14 },
        { name: "ä¼Šæ ¹", lat: 35.68, lon: 135.31 },
        { name: "èˆé¶´", lat: 35.48, lon: 135.37 },
        { name: "å°æµœ", lat: 35.53, lon: 135.76 },
      ];

      // é¢¨å‘ã‚’æ—¥æœ¬èªã«å¤‰æ›
      function getWindDirStr(degree) {
        const dirs = [
          "åŒ—",
          "åŒ—åŒ—æ±",
          "åŒ—æ±",
          "æ±åŒ—æ±",
          "æ±",
          "æ±å—æ±",
          "å—æ±",
          "å—å—è¥¿",
          "å—",
          "å—å—è¥¿",
          "å—è¥¿",
          "è¥¿å—è¥¿",
          "è¥¿",
          "è¥¿åŒ—è¥¿",
          "åŒ—è¥¿",
          "åŒ—åŒ—è¥¿",
        ];
        const idx = Math.round(degree / 22.5) % 16;
        return dirs[idx] || "ä¸å®š";
      }

      // æ½®ä½ã‚°ãƒ©ãƒ•ã®æç”»é–¢æ•°
      async function drawTideGraph(oceanData) {
        const container = document.getElementById("tideGraphContainer");
        const placeholder = document.getElementById("tideGraphPlaceholder");
        const svg = document.getElementById("tideGraphSvg");

        if (!oceanData || !oceanData.location) {
          placeholder.textContent = "æ½®ä½ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“";
          return;
        }

        try {
          // Open-Meteo Marine API ã‹ã‚‰1æ—¥é–“ã®æ½®ä½ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const lat = oceanData.location.lat;
          const lon = oceanData.location.lon;
          const api = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=sea_level_height_msl&timezone=Asia/Tokyo&forecast_days=1`;

          const response = await fetch(api);
          if (!response.ok) throw new Error("æ½®ä½ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼");

          const json = await response.json();
          const tideData = json.hourly.sea_level_height_msl;

          if (!tideData || tideData.length === 0) {
            placeholder.textContent = "æ½®ä½ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
            return;
          }

          // ã‚°ãƒ©ãƒ•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          const width = 340;
          const height = 160;
          const padding = { top: 30, right: 15, bottom: 25, left: 35 };
          const graphWidth = width - padding.left - padding.right;
          const graphHeight = height - padding.top - padding.bottom;

          // æ½®ä½ã®æœ€å¤§ãƒ»æœ€å°ã‚’è¨ˆç®—
          const minTide = Math.min(...tideData);
          const maxTide = Math.max(...tideData);
          const rangeTide = maxTide - minTide || 1;

          // SVGåˆæœŸåŒ–
          svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
          svg.innerHTML = "";

          // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
          const gridGroup = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g",
          );
          gridGroup.setAttribute("stroke", "#6b5d3f");
          gridGroup.setAttribute("stroke-width", "0.5");

          for (let i = 0; i <= 4; i++) {
            const y = padding.top + (graphHeight / 4) * i;
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line",
            );
            line.setAttribute("x1", padding.left);
            line.setAttribute("x2", width - padding.right);
            line.setAttribute("y1", y);
            line.setAttribute("y2", y);
            gridGroup.appendChild(line);
          }
          svg.appendChild(gridGroup);

          // æ½®ä½æ›²ç·šã‚’æç”»
          let pathData = `M ${padding.left} ${padding.top + graphHeight}`;
          for (let i = 0; i < tideData.length; i++) {
            const x = padding.left + (graphWidth / (tideData.length - 1)) * i;
            const normalizedHeight = (tideData[i] - minTide) / rangeTide;
            const y =
              padding.top + graphHeight - normalizedHeight * graphHeight;
            pathData += ` L ${x} ${y}`;
          }

          const path = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path",
          );
          path.setAttribute("d", pathData);
          path.setAttribute("fill", "none");
          path.setAttribute("stroke", "#d4af8c");
          path.setAttribute("stroke-width", "2");
          svg.appendChild(path);

          // ç™»éŒ²æ™‚åˆ»ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”»
          if (oceanData.date && oceanData.time) {
            // APIã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç›´æ¥ãƒ‘ãƒ¼ã‚¹ã—ã¦æ™‚åˆ»ã‚’æŠ½å‡º
            const apiStartStr = json.hourly.time[0]; // "2025-12-13T00:00"å½¢å¼
            const apiStartMatch = apiStartStr.match(/T(\d{2}):(\d{2})/);
            const apiStartHour = parseInt(apiStartMatch[1], 10);
            const apiStartMinute = parseInt(apiStartMatch[2], 10);
            const apiStartHours = apiStartHour + apiStartMinute / 60;

            // ç™»éŒ²æ™‚åˆ»ã‚’æ™‚é–“å€¤ã«å¤‰æ›
            const [hourStr, minuteStr] = oceanData.time.split(":");
            const captureHours =
              parseInt(hourStr, 10) + parseInt(minuteStr, 10) / 60;

            // æ™‚é–“å·®ã‚’è¨ˆç®—
            let hoursDiff = captureHours - apiStartHours;
            if (hoursDiff < 0) {
              hoursDiff += 24;
            }

            if (hoursDiff >= 0 && hoursDiff < tideData.length) {
              const idx = Math.round(hoursDiff);
              if (idx >= 0 && idx < tideData.length) {
                const x =
                  padding.left + (graphWidth / (tideData.length - 1)) * idx;
                const normalizedHeight = (tideData[idx] - minTide) / rangeTide;
                const y =
                  padding.top + graphHeight - normalizedHeight * graphHeight;

                const circle = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "circle",
                );
                circle.setAttribute("cx", x);
                circle.setAttribute("cy", y);
                circle.setAttribute("r", "4");
                circle.setAttribute("fill", "#ff6f00");
                circle.setAttribute("stroke", "#fff");
                circle.setAttribute("stroke-width", "2");
                svg.appendChild(circle);

                // æ™‚åˆ»ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                const timeLabel = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "text",
                );
                timeLabel.setAttribute("x", x);
                timeLabel.setAttribute("y", y - 10);
                timeLabel.setAttribute("font-size", "10");
                timeLabel.setAttribute("fill", "#ff6f00");
                timeLabel.setAttribute("font-weight", "bold");
                timeLabel.setAttribute("text-anchor", "middle");
                timeLabel.textContent = oceanData.time;
                svg.appendChild(timeLabel);
              }
            }
          }

          // Yè»¸ãƒ©ãƒ™ãƒ«
          const minLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          minLabel.setAttribute("x", "2");
          minLabel.setAttribute("y", padding.top + graphHeight + 4);
          minLabel.setAttribute("font-size", "10");
          minLabel.setAttribute("fill", "#a89560");
          minLabel.setAttribute("text-anchor", "start");
          minLabel.textContent = `${minTide.toFixed(1)}m`;
          svg.appendChild(minLabel);

          const maxLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          maxLabel.setAttribute("x", "2");
          maxLabel.setAttribute("y", padding.top + 12);
          maxLabel.setAttribute("font-size", "10");
          maxLabel.setAttribute("fill", "#a89560");
          maxLabel.setAttribute("text-anchor", "start");
          maxLabel.textContent = `${maxTide.toFixed(1)}m`;
          svg.appendChild(maxLabel);

          // Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ï¼‰
          const startLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          startLabel.setAttribute("x", padding.left);
          startLabel.setAttribute("y", height - 8);
          startLabel.setAttribute("font-size", "11");
          startLabel.setAttribute("fill", "#a89560");
          startLabel.setAttribute("text-anchor", "middle");
          startLabel.textContent = "0h";
          svg.appendChild(startLabel);

          const endLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          endLabel.setAttribute("x", width - padding.right);
          endLabel.setAttribute("y", height - 8);
          endLabel.setAttribute("font-size", "11");
          endLabel.setAttribute("fill", "#a89560");
          endLabel.setAttribute("text-anchor", "middle");
          endLabel.textContent = "24h";
          svg.appendChild(endLabel);

          // SVGã‚’è¡¨ç¤º
          placeholder.style.display = "none";
          svg.style.display = "block";
        } catch (error) {
          console.error("æ½®ä½ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒ©ãƒ¼:", error);
          placeholder.textContent = `ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ${error.message}`;
        }
      }

      // æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
      async function showOceanDataModal(currentData) {
        const modal = document.createElement("div");
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
          z-index: 9999;
        `;

        const content = document.createElement("div");
        content.style.cssText = `
          background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95));
          border: 2px solid #3a4d6b;
          padding: 24px;
          border-radius: 2px;
          max-width: 450px;
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8);
          max-height: 80vh;
          overflow-y: auto;
          color: #c4d8f0;
        `;

        content.innerHTML = `
          <h3 style="margin-top: 0; color: #4db8ff; text-shadow: 0 0 10px rgba(77, 184, 255, 0.3);">æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ç·¨é›†</h3>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; color: #c4d8f0; font-weight: 600;">é‡£ã‚Šå ´:</label>
            <select id="modalLocation" style="width: 100%; padding: 8px; border: 1px solid #506080; border-radius: 2px; background: rgba(5, 4, 4, 0.6); color: #c4d8f0;">
              ${fishingLocations
                .map(
                  (loc) =>
                    `<option value="${loc.lat},${loc.lon}" ${
                      currentData.catch.location === loc.name ? "selected" : ""
                    }>${loc.name}</option>`,
                )
                .join("")}
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; color: #c4d8f0; font-weight: 600;">æ—¥ä»˜:</label>
            <input type="date" id="modalDate" style="width: 100%; padding: 8px; border: 1px solid #506080; border-radius: 2px; background: rgba(5, 4, 4, 0.6); color: #c4d8f0;" value="${
              currentData.catch.date || ""
            }">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; color: #c4d8f0; font-weight: 600;">æ™‚åˆ» (HH:MM):</label>
            <input type="time" id="modalTime" style="width: 100%; padding: 8px; border: 1px solid #506080; border-radius: 2px; background: rgba(5, 4, 4, 0.6); color: #c4d8f0;" value="12:00">
          </div>
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(5, 4, 4, 0.6); border: 1px solid #506080; border-radius: 2px; min-height: 60px; display: none;" id="oceanDataResult">
            <p id="oceanDataText" style="margin: 0; color: #4db8ff; font-size: 0.9rem;"></p>
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="modalFetch" class="btn" style="flex: 1; background: linear-gradient(135deg, #6b8fb0, #8099b8); color: white; border: 2px solid #c4d8f0; font-weight: 600; padding: 0.75rem; border-radius: 2px; cursor: pointer;">å–å¾—</button>
            <button id="modalAdd" class="btn" style="flex: 1; background: linear-gradient(135deg, #6b8fb0, #8099b8); color: white; border: 2px solid #c4d8f0; font-weight: 600; padding: 0.75rem; border-radius: 2px; cursor: pointer; display: none;">ãƒ¡ãƒ¢ã«è¿½åŠ </button>
            <button id="modalCancel" class="btn secondary" style="flex: 1; background: rgba(0, 0, 0, 0.3); color: #8099b8; border: 1px solid #506080; border-radius: 2px; padding: 0.75rem; cursor: pointer; font-weight: 600;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);

        let oceanDataText = "";

        // å–å¾—ãƒœã‚¿ãƒ³
        document
          .getElementById("modalFetch")
          .addEventListener("click", async () => {
            const locValue = document.getElementById("modalLocation").value;
            const dateStr = document.getElementById("modalDate").value;
            const timeStr = document.getElementById("modalTime").value;

            if (!locValue || !dateStr || !timeStr) {
              alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
              return;
            }

            const [lat, lon] = locValue.split(",").map(Number);

            try {
              const resultDiv = document.getElementById("oceanDataResult");
              const resultText = document.getElementById("oceanDataText");
              resultDiv.style.display = "block";
              resultText.textContent = "å–å¾—ä¸­...";

              // Open-Meteo Weather APIã‹ã‚‰æ°—è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—
              const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,pressure_msl,cloud_cover&timezone=Asia/Tokyo`;
              const weatherRes = await fetch(weatherUrl);
              const weatherData = await weatherRes.json();

              // Open-Meteo Marine APIã‹ã‚‰æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—
              const marineUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=sea_level_height_msl,wave_height,wave_period&start_date=${dateStr}&end_date=${dateStr}&timezone=UTC`;
              const marineRes = await fetch(marineUrl);
              const marineData = await marineRes.json();

              const current = weatherData.current;
              const temp = current.temperature_2m;
              const wind = current.wind_speed_10m;
              const windDir = current.wind_direction_10m;
              const pressure = current.pressure_msl;
              const cloud = current.cloud_cover;
              const waterTemp =
                marineData.current?.sea_surface_temperature || "-";

              let tideHeight = "-";
              let waveHeight = "-";
              let wavePeriod = "-";

              if (marineData.hourly && marineData.hourly.time) {
                const times = marineData.hourly.time;
                const heights = marineData.hourly.sea_level_height_msl;
                const waves = marineData.hourly.wave_height;
                const periods = marineData.hourly.wave_period;

                const targetMs = new Date(
                  `${dateStr}T${timeStr}:00Z`,
                ).getTime();
                let closestIdx = 0;
                let minDiff = Infinity;

                for (let i = 0; i < times.length; i++) {
                  const diff = Math.abs(
                    new Date(times[i]).getTime() - targetMs,
                  );
                  if (diff < minDiff) {
                    minDiff = diff;
                    closestIdx = i;
                  }
                }

                tideHeight = heights[closestIdx]
                  ? (heights[closestIdx] * 100).toFixed(0) + " cm"
                  : "-";
                waveHeight = waves[closestIdx]
                  ? waves[closestIdx].toFixed(1) + " m"
                  : "-";
                wavePeriod = periods[closestIdx]
                  ? periods[closestIdx].toFixed(1) + " s"
                  : "-";
              }

              oceanDataText = `æ°—æ¸©:${temp}Â°C é¢¨:${wind}m/s(${getWindDirStr(
                windDir,
              )}) æ°—åœ§:${pressure}hPa æ°´æ¸©:${waterTemp}Â°C æ½®ä½:${tideHeight} æ³¢:${waveHeight} å‘¨æœŸ:${wavePeriod}`;

              resultText.innerHTML = `
              <strong>å–å¾—æ¸ˆã¿æµ·æ³ãƒ‡ãƒ¼ã‚¿ (${dateStr} ${timeStr}):</strong><br>
              æ°—æ¸©: ${temp}Â°C | é¢¨é€Ÿ: ${wind}m/s (${getWindDirStr(
                windDir,
              )}) | æ°—åœ§: ${pressure}hPa<br>
              æ°´æ¸©: ${waterTemp}Â°C | æ½®ä½: ${tideHeight} | æ³¢é«˜: ${waveHeight} | å‘¨æœŸ: ${wavePeriod}
            `;

              document.getElementById("modalAdd").style.display = "block";
            } catch (err) {
              console.error("Ocean data fetch error:", err);
              document.getElementById("oceanDataText").textContent =
                "æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message;
            }
          });

        // ãƒ¡ãƒ¢ã«è¿½åŠ ãƒœã‚¿ãƒ³
        document
          .getElementById("modalAdd")
          .addEventListener("click", async () => {
            if (!oceanDataText) return;

            try {
              const currentMemo = currentData.catch.memo || "";
              const newMemo = currentMemo
                ? currentMemo + " / " + oceanDataText
                : oceanDataText;

              // Firestoreã‚’æ›´æ–°
              const docRef = doc(db, "fishinglogs", currentData.id);
              await updateDoc(docRef, {
                "catch.memo": newMemo,
              });

              alert("ãƒ¡ãƒ¢ã«æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
              modal.remove();

              // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ 
              location.reload();
            } catch (err) {
              console.error("Update error:", err);
              alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
            }
          });

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        document.getElementById("modalCancel").addEventListener("click", () => {
          modal.remove();
        });
      }
    </script>
  </body>
</html>
