<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ·æ³ãƒã‚§ãƒƒã‚«ãƒ¼ - AbyssAtlas</title>
    <link rel="stylesheet" href="stylesheet.css" />
    <link rel="stylesheet" href="stylesheet-darksoul.css" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        background: #050404 !important;
        background-image:
          radial-gradient(
            ellipse at 50% 0%,
            rgba(100, 150, 200, 0.05) 0%,
            transparent 50%
          ),
          linear-gradient(to bottom, rgba(30, 50, 80, 0.1) 0%, transparent 50%) !important;
        color: #8099b8;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
      }

      .ocean-checker-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 900px) {
        .ocean-checker-container {
          grid-template-columns: 1fr;
        }
      }

      .section {
        background: linear-gradient(
          135deg,
          rgba(5, 4, 4, 0.95),
          rgba(15, 25, 45, 0.95)
        );
        border: 2px solid #506080;
        border-radius: 4px;
        padding: 20px;
        box-shadow:
          0 8px 30px rgba(0, 0, 0, 0.9),
          inset 0 0 20px rgba(128, 153, 184, 0.02);
      }

      .section h2 {
        color: #c4d8f0;
        text-shadow: 0 0 8px rgba(180, 200, 220, 0.3);
        margin-top: 0;
        border-bottom: 2px solid #506080;
        padding-bottom: 10px;
      }

      #mapContainer {
        width: 100%;
        height: 500px;
        border: 2px solid #506080;
        border-radius: 4px;
        background: #1a1a1a;
      }

      .weather-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .weather-card {
        background: rgba(30, 50, 80, 0.5);
        border: 1px solid #506080;
        border-radius: 4px;
        padding: 12px;
        text-align: center;
      }

      .weather-card .label {
        color: #a89560;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .weather-card .value {
        color: #4db8ff;
        font-size: 1.3rem;
        font-weight: bold;
        text-shadow: 0 0 6px rgba(77, 184, 255, 0.3);
      }

      .recommendation-box {
        background: linear-gradient(
          135deg,
          rgba(100, 150, 200, 0.1),
          rgba(50, 80, 120, 0.1)
        );
        border: 2px solid #506080;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        font-size: 1rem;
        line-height: 1.6;
        color: #c4d8f0;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        background: linear-gradient(135deg, #506080, #6b8fb0);
        color: #c4d8f0;
        border: 2px solid #8099b8;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      button:hover {
        background: linear-gradient(135deg, #6b8fb0, #8099b8);
        box-shadow: 0 4px 12px rgba(128, 153, 184, 0.3);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .fishing-spots {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .spot-button {
        background: rgba(50, 80, 120, 0.6);
        border: 1px solid #506080;
        padding: 10px;
        border-radius: 4px;
        text-align: left;
        color: #8099b8;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
      }

      .spot-button:hover {
        background: rgba(70, 100, 140, 0.8);
        border-color: #8099b8;
      }

      .spot-button strong {
        display: block;
        color: #4db8ff;
        margin-bottom: 2px;
      }

      .spot-button small {
        color: #6b7b82;
      }

      .error-message {
        background: rgba(255, 100, 100, 0.2);
        border: 1px solid #ff6b6b;
        color: #ff8787;
        padding: 12px;
        border-radius: 4px;
        margin-top: 10px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(77, 184, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4db8ff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .location-info {
        background: rgba(30, 50, 80, 0.5);
        border: 1px solid #506080;
        border-radius: 4px;
        padding: 12px;
        margin-top: 10px;
        font-size: 0.9rem;
      }

      .location-info p {
        margin: 5px 0;
        color: #8099b8;
      }

      .location-info strong {
        color: #4db8ff;
      }

      .loading-spinner {
        text-align: center;
        padding: 20px;
      }

      .no-data {
        text-align: center;
        color: #6b7b82;
        padding: 20px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="ocean-checker-container">
      <!-- åœ°å›³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>é‡£ã‚Šå ´ã‚’é¸æŠ</h2>
        <p style="color: #8099b8; font-size: 0.9rem; margin: 0 0 10px 0">
          ãƒãƒƒãƒ—ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã€ã¾ãŸã¯ä¸‹ã‹ã‚‰æœ‰åé‡£ã‚Šå ´ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </p>
        <div id="mapContainer"></div>

        <div
          class="section"
          style="margin-top: 20px; border: 1px solid #506080"
        >
          <h3 style="color: #c4d8f0; margin-top: 0; font-size: 1rem">
            æœ‰åé‡£ã‚Šå ´
          </h3>
          <div class="fishing-spots" id="fishingSpots"></div>
        </div>
      </div>

      <!-- æµ·æ³æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>ğŸŒŠ æµ·æ³æƒ…å ±</h2>
        <div id="oceanDataContainer">
          <div class="no-data">
            åœ°ç‚¹ã‚’é¸æŠã—ã¦ã€ãã®åœ°ç‚¹ã®æµ·æ³æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        initializeMap,
        addFishingSpotMarkers,
        getSelectedLocation,
      } from "./google-maps-integration.js";
      import {
        getOceanWeather,
        FAMOUS_FISHING_SPOTS,
      } from "./ocean-weather.js";
      import {
        getTideData,
        getWaveData,
        evaluateOverallCondition,
      } from "./stormglass-integration.js";

      // Googleãƒãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•çš„èª­ã¿è¾¼ã¿
      async function loadGoogleMapsAPI() {
        try {
          // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’å–å¾—
          const response = await fetch("/api/google-maps-key");
          if (!response.ok) {
            throw new Error("Failed to get Google Maps API key");
          }
          const { apiKey } = await response.json();

          return new Promise((resolve) => {
            // callback ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ API èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å‘¼ã³å‡ºã™
            window.initGoogleMapsCallback = resolve;
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=maps,marker&language=ja&loading=async&callback=initGoogleMapsCallback`;
            script.async = true;
            document.head.appendChild(script);
          });
        } catch (error) {
          console.error("Google Maps API loading failed:", error);
          throw error;
        }
      }

      // åˆæœŸåŒ–
      async function init() {
        try {
          // Googleãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–
          await loadGoogleMapsAPI();
          await initializeMap("mapContainer", 36.2048, 138.2529, 6);

          // æœ‰åé‡£ã‚Šå ´ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ 
          await addFishingSpotMarkers(FAMOUS_FISHING_SPOTS);
          renderFishingSpots();

          // åœ°ç‚¹é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
          window.addEventListener("locationSelected", async (e) => {
            const { latitude, longitude } = e.detail;
            await fetchOceanData(latitude, longitude);
          });
        } catch (error) {
          console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          showError(
            "ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
          );
        }
      }

      /**
       * æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
       */
      async function fetchOceanData(latitude, longitude) {
        const container = document.getElementById("oceanDataContainer");
        container.innerHTML =
          '<div class="loading-spinner"><div class="loading"></div>æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>';

        try {
          // æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const oceanData = await getOceanWeather(latitude, longitude);

          // StormGlass APIã‹ã‚‰æ½®æ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆè©¦ã¿ã‚‹ï¼‰
          let tideData = null;
          let waveData = null;

          try {
            tideData = await getTideData(latitude, longitude);
            waveData = await getWaveData(latitude, longitude);
          } catch (stormglassError) {
            console.warn(
              "StormGlass APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰:",
              stormglassError,
            );
            // StormGlass APIãŒå¤±æ•—ã—ã¦ã‚‚OpenWeatherMapã®ãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ
          }

          displayOceanData(oceanData, tideData, waveData);
        } catch (error) {
          console.error("æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);

          // ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          let errorMessage = "æµ·æ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

          if (error.message && error.message.includes("404")) {
            errorMessage =
              "ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚<br>" +
              "<strong>Vercel é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼š</strong><br>" +
              "1. <code>npm install -g vercel</code> ã§Vercel CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«<br>" +
              "2. <code>.env.local</code> ã« API ã‚­ãƒ¼ã‚’è¨­å®š<br>" +
              "3. <code>vercel dev</code> ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•";
          } else if (error.message && error.message.includes("503")) {
            errorMessage =
              "API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>" +
              "<strong>.env.local ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</strong>";
          } else if (error.message && error.message.includes("401")) {
            errorMessage =
              "API ã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚<br>" +
              "<strong>.env.local ã®APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„</strong>";
          }

          showError(errorMessage);
        }
      }

      /**
       * æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’UIã«è¡¨ç¤º
       */
      function displayOceanData(oceanData, tideData, waveData) {
        const container = document.getElementById("oceanDataContainer");

        const html = `
          <div class="location-info">
            <p><strong>åœ°ç‚¹:</strong> ${escapeHtml(oceanData.location.name)}</p>
            <p><strong>åº§æ¨™:</strong> ${oceanData.location.latitude.toFixed(4)}, ${oceanData.location.longitude.toFixed(4)}</p>
            <p><strong>å–å¾—æ™‚åˆ»:</strong> ${oceanData.timestamp.toLocaleString("ja-JP")}</p>
          </div>

          <div class="weather-info">
            <div class="weather-card">
              <div class="label">ğŸŒ¡ï¸ æ°—æ¸©</div>
              <div class="value">${oceanData.weather.temperature.toFixed(1)}Â°C</div>
            </div>
            <div class="weather-card">
              <div class="label">ğŸ’¨ é¢¨é€Ÿ</div>
              <div class="value">${oceanData.weather.windSpeed.toFixed(1)} m/s</div>
            </div>
            <div class="weather-card">
              <div class="label">ğŸ’§ æ¹¿åº¦</div>
              <div class="value">${oceanData.weather.humidity}%</div>
            </div>
            <div class="weather-card">
              <div class="label">ğŸŒŠ æ¨å®šæ³¢é«˜</div>
              <div class="value">${oceanData.waves.estimatedHeight.max.toFixed(1)}m</div>
            </div>
            <div class="weather-card">
              <div class="label">ğŸŒªï¸ é¢¨å‘ã</div>
              <div class="value">${getWindDirection(oceanData.weather.windDirection)}</div>
            </div>
            <div class="weather-card">
              <div class="label">â˜ï¸ é›²é‡</div>
              <div class="value">${oceanData.weather.cloudiness}%</div>
            </div>
            <div class="weather-card">
              <div class="label">ğŸŒ…  æ—¥å‡º</div>
              <div class="value">${oceanData.sunrise.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
            </div>
            <div class="weather-card">
              <div class="label">ğŸŒ… æ—¥æ²¡</div>
              <div class="value">${oceanData.sunset.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
            </div>
          </div>

          ${
            tideData
              ? `
          <div style="margin-top: 15px; padding: 15px; background: rgba(100, 180, 255, 0.1); border: 2px solid #4db8ff; border-radius: 4px;">
            <h3 style="color: #4db8ff; margin-top: 0; margin-bottom: 12px;">ğŸŒŠ æ½®æ±æƒ…å ±ï¼ˆStormGlassï¼‰</h3>

            ${
              tideData.current
                ? `
            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">ç¾åœ¨ã®æ½®ä½</div>
              <div class="value">${tideData.current.height.toFixed(2)}m</div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${tideData.current.type === "High" ? "æº€æ½®" : "å¹²æ½®"}</small>
            </div>
            `
                : ""
            }

            ${
              tideData.next
                ? `
            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">æ¬¡ã®æ½®æ™‚</div>
              <div class="value">${tideData.next.time.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${tideData.next.type === "High" ? "æº€æ½® (é«˜ã•: " : "å¹²æ½® (é«˜ã•: "}${tideData.next.height.toFixed(2)}m)</small>
            </div>
            `
                : ""
            }

            ${
              tideData.range
                ? `
            <div class="weather-card">
              <div class="label">æ½®ä½ãƒ¬ãƒ³ã‚¸</div>
              <div class="value">${tideData.range.max.toFixed(2)}m / ${tideData.range.min.toFixed(2)}m</div>
            </div>
            `
                : ""
            }
          </div>
          `
              : ""
          }

          ${
            waveData
              ? `
          <div style="margin-top: 15px; padding: 15px; background: rgba(255, 150, 100, 0.1); border: 2px solid #ff8c00; border-radius: 4px;">
            <h3 style="color: #ff8c00; margin-top: 0; margin-bottom: 12px;">ğŸ„ æ³¢æµªæƒ…å ±ï¼ˆStormGlassï¼‰</h3>

            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">æ³¢é«˜</div>
              <div class="value">${waveData.current.waveHeight.toFixed(2)}m</div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${waveData.quality.emoji} ${waveData.quality.rating} - ${waveData.quality.description}</small>
            </div>

            ${
              waveData.current.wavePeriod
                ? `
            <div class="weather-card">
              <div class="label">æ³¢å‘¨æœŸ</div>
              <div class="value">${waveData.current.wavePeriod.toFixed(1)}s</div>
            </div>
            `
                : ""
            }
          </div>
          `
              : ""
          }

          <div class="recommendation-box">
            <strong>ğŸ£ é‡£ã‚Šã®æ¨å¥¨åº¦:</strong><br/>
            ${oceanData.waves.recommendation}
          </div>

          <div class="button-group">
            <button onclick="copyLocationToClipboard()">ğŸ“‹ åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼</button>
            <button onclick="saveFishingLocation()">ğŸ’¾ é‡£è¡Œè¨˜éŒ²ã«ä½¿ç”¨</button>
          </div>
        `;

        container.innerHTML = html;

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦æ©Ÿèƒ½ã‚’è¨­å®š
        window.copyLocationToClipboard = function () {
          const text = `${oceanData.location.latitude.toFixed(6)}, ${oceanData.location.longitude.toFixed(6)}`;
          navigator.clipboard.writeText(text).then(() => {
            alert("åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          });
        };

        window.saveFishingLocation = function () {
          // fishing-log.html ã¸ã®é·ç§»æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
          sessionStorage.setItem(
            "oceanData",
            JSON.stringify({
              location: {
                lat: oceanData.location.latitude,
                lng: oceanData.location.longitude,
              },
              date: new Date().toISOString().split("T")[0],
              temperature: oceanData.weather.temperature,
              waterTemperature: oceanData.weather.temperature, // è¿‘ä¼¼å€¤
              windSpeed: oceanData.weather.windSpeed,
              windDirection: oceanData.weather.windDirection,
              humidity: oceanData.weather.humidity,
              cloudiness: oceanData.weather.cloudiness,
              pressure: oceanData.weather.pressure,
              sunrise: oceanData.sunrise.toISOString(),
              sunset: oceanData.sunset.toISOString(),
              tideHeight: tideData?.current?.height || null,
              waveHeight: waveData?.current?.waveHeight || null,
              wavePeriod: waveData?.current?.wavePeriod || null,
            }),
          );
          window.location.href = "fishing-log.html";
        };
      }

      /**
       * æœ‰åé‡£ã‚Šå ´ã‚’UIã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
       */
      function renderFishingSpots() {
        const container = document.getElementById("fishingSpots");
        container.innerHTML = FAMOUS_FISHING_SPOTS.map((spot) => {
          return `
            <button class="spot-button" onclick="selectSpot(${spot.latitude}, ${spot.longitude})">
              <strong>${escapeHtml(spot.name)}</strong>
              <small>${escapeHtml(spot.region)}</small>
            </button>
          `;
        }).join("");

        window.selectSpot = function (lat, lng) {
          fetchOceanData(lat, lng);
        };
      }

      /**
       * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
       */
      function showError(message) {
        const container = document.getElementById("oceanDataContainer");
        // message ã« HTML ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãŸã‚å®‰å…¨ï¼‰
        container.innerHTML = `<div class="error-message" style="padding: 15px; border-radius: 4px; line-height: 1.6;">
          <strong style="display: block; margin-bottom: 10px; color: #ff6b6b;">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong>
          <div style="color: #ff8787; font-size: 0.95rem;">${message}</div>
        </div>`;
      }

      /**
       * é¢¨å‘ãã‚’æ—¥æœ¬èªã§å–å¾—
       */
      function getWindDirection(degrees) {
        const directions = [
          "N",
          "NNE",
          "NE",
          "ENE",
          "E",
          "ESE",
          "SE",
          "SSE",
          "S",
          "SSW",
          "SW",
          "WSW",
          "W",
          "WNW",
          "NW",
          "NNW",
        ];
        const index = Math.round(degrees / 22.5) % 16;
        return directions[index];
      }

      /**
       * XSSå¯¾ç­–: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
       */
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return String(text).replace(/[&<>"']/g, (m) => map[m]);
      }

      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
      window.addEventListener("load", init);
    </script>
  </body>
</html>
