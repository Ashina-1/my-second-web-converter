<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ·æ³ãƒã‚§ãƒƒã‚«ãƒ¼ - AbyssAtlas</title>
    <link rel="stylesheet" href="stylesheet.css" />
    <link rel="stylesheet" href="stylesheet-darksoul.css" />
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        background: #050404 !important;
        background-image:
          radial-gradient(
            ellipse at 50% 0%,
            rgba(100, 150, 200, 0.05) 0%,
            transparent 50%
          ),
          linear-gradient(to bottom, rgba(30, 50, 80, 0.1) 0%, transparent 50%) !important;
        color: #8099b8;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
      }

      .ocean-checker-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 900px) {
        .ocean-checker-container {
          grid-template-columns: 1fr;
        }
      }

      .section {
        background: linear-gradient(
          135deg,
          rgba(5, 4, 4, 0.95),
          rgba(15, 25, 45, 0.95)
        );
        border: 2px solid #506080;
        border-radius: 4px;
        padding: 20px;
        box-shadow:
          0 8px 30px rgba(0, 0, 0, 0.9),
          inset 0 0 20px rgba(128, 153, 184, 0.02);
      }

      .section h2 {
        color: #c4d8f0;
        text-shadow: 0 0 8px rgba(180, 200, 220, 0.3);
        margin-top: 0;
        border-bottom: 2px solid #506080;
        padding-bottom: 10px;
      }

      #mapContainer {
        width: 100%;
        height: 500px;
        border: 2px solid #506080;
        border-radius: 4px;
        background: #1a1a1a;
      }

      .weather-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .weather-card {
        background: rgba(30, 50, 80, 0.5);
        border: 1px solid #506080;
        border-radius: 4px;
        padding: 12px;
        text-align: center;
      }

      .weather-card .label {
        color: #a89560;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .weather-card .value {
        color: #4db8ff;
        font-size: 1.3rem;
        font-weight: bold;
        text-shadow: 0 0 6px rgba(77, 184, 255, 0.3);
      }

      .recommendation-box {
        background: linear-gradient(
          135deg,
          rgba(100, 150, 200, 0.1),
          rgba(50, 80, 120, 0.1)
        );
        border: 2px solid #506080;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        font-size: 1rem;
        line-height: 1.6;
        color: #c4d8f0;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        background: linear-gradient(135deg, #506080, #6b8fb0);
        color: #c4d8f0;
        border: 2px solid #8099b8;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      button:hover {
        background: linear-gradient(135deg, #6b8fb0, #8099b8);
        box-shadow: 0 4px 12px rgba(128, 153, 184, 0.3);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .fishing-spots {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .spot-button {
        background: rgba(50, 80, 120, 0.6);
        border: 1px solid #506080;
        padding: 10px;
        border-radius: 4px;
        text-align: left;
        color: #8099b8;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
      }

      .spot-button:hover {
        background: rgba(70, 100, 140, 0.8);
        border-color: #8099b8;
      }

      .spot-button strong {
        display: block;
        color: #4db8ff;
        margin-bottom: 2px;
      }

      .spot-button small {
        color: #6b7b82;
      }

      .error-message {
        background: rgba(255, 100, 100, 0.2);
        border: 1px solid #ff6b6b;
        color: #ff8787;
        padding: 12px;
        border-radius: 4px;
        margin-top: 10px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(77, 184, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4db8ff;
        animation: spin 1s ease-in-out infinite;
      }

      .lucide-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        margin-right: 4px;
        vertical-align: middle;
      }

      .lucide-icon svg {
        width: 100%;
        height: 100%;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      /* Lucideã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
      i[data-lucide] {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1em;
        height: 1em;
        margin-right: 0.25em;
        vertical-align: middle;
        color: currentColor;
      }

      i[data-lucide] svg {
        width: 100%;
        height: 100%;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      .weather-card .label i[data-lucide] {
        width: 1.2em;
        height: 1.2em;
      }

      button i[data-lucide] {
        width: 1em;
        height: 1em;
        margin-right: 0.5em;
      }

      strong i[data-lucide] {
        width: 1.2em;
        height: 1.2em;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .location-info {
        background: rgba(30, 50, 80, 0.5);
        border: 1px solid #506080;
        border-radius: 4px;
        padding: 12px;
        margin-top: 10px;
        font-size: 0.9rem;
      }

      .location-info p {
        margin: 5px 0;
        color: #8099b8;
      }

      .location-info strong {
        color: #4db8ff;
      }

      .loading-spinner {
        text-align: center;
        padding: 20px;
      }

      .no-data {
        text-align: center;
        color: #6b7b82;
        padding: 20px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="ocean-checker-container">
      <!-- åœ°å›³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>é‡£ã‚Šå ´ã‚’é¸æŠ</h2>
        <p style="color: #8099b8; font-size: 0.9rem; margin: 0 0 10px 0">
          ãƒãƒƒãƒ—ä¸Šã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã€ã¾ãŸã¯ä¸‹ã‹ã‚‰æœ‰åé‡£ã‚Šå ´ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        </p>
        <div id="mapContainer"></div>

        <div
          class="section"
          style="margin-top: 20px; border: 1px solid #506080"
        >
          <h3 style="color: #c4d8f0; margin-top: 0; font-size: 1rem">
            æœ‰åé‡£ã‚Šå ´
          </h3>
          <div class="fishing-spots" id="fishingSpots"></div>
        </div>
      </div>

      <!-- æµ·æ³æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2 id="oceanInfoTitle">ğŸŒŠ æµ·æ³æƒ…å ±</h2>
        <div id="oceanDataContainer">
          <div class="no-data">
            åœ°ç‚¹ã‚’é¸æŠã—ã¦ã€ãã®åœ°ç‚¹ã®æµ·æ³æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        initializeMap,
        addFishingSpotMarkers,
        getSelectedLocation,
      } from "./google-maps-integration.js";
      import {
        getOceanWeather,
        FAMOUS_FISHING_SPOTS,
      } from "./ocean-weather.js";
      import {
        getTideData,
        getWaveData,
        evaluateOverallCondition,
      } from "./stormglass-integration.js";

      // Googleãƒãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•çš„èª­ã¿è¾¼ã¿
      async function loadGoogleMapsAPI() {
        try {
          // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’å–å¾—
          const response = await fetch("/api/google-maps-key");
          if (!response.ok) {
            throw new Error("Failed to get Google Maps API key");
          }
          const { apiKey } = await response.json();

          return new Promise((resolve) => {
            // callback ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ API èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å‘¼ã³å‡ºã™
            window.initGoogleMapsCallback = resolve;
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=maps,marker&language=ja&loading=async&callback=initGoogleMapsCallback`;
            script.async = true;
            document.head.appendChild(script);
          });
        } catch (error) {
          console.error("Google Maps API loading failed:", error);
          throw error;
        }
      }

      // åˆæœŸåŒ–
      async function init() {
        try {
          // Googleãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–
          await loadGoogleMapsAPI();
          await initializeMap("mapContainer", 36.2048, 138.2529, 6);

          // æœ‰åé‡£ã‚Šå ´ã‚’ãƒãƒƒãƒ—ã«è¿½åŠ 
          await addFishingSpotMarkers(FAMOUS_FISHING_SPOTS);
          renderFishingSpots();

          // åœ°ç‚¹é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
          window.addEventListener("locationSelected", async (e) => {
            const { latitude, longitude } = e.detail;
            await fetchOceanData(latitude, longitude);
          });
        } catch (error) {
          console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          showError(
            "ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
          );
        }
      }

      /**
       * æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
       */
      async function fetchOceanData(latitude, longitude) {
        const container = document.getElementById("oceanDataContainer");
        container.innerHTML =
          '<div class="loading-spinner"><div class="loading"></div>æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>';

        try {
          // æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const oceanData = await getOceanWeather(latitude, longitude);

          // StormGlass APIã‹ã‚‰æ½®æ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆè©¦ã¿ã‚‹ï¼‰
          let tideData = null;
          let waveData = null;

          try {
            tideData = await getTideData(latitude, longitude);
            waveData = await getWaveData(latitude, longitude);
          } catch (stormglassError) {
            console.warn(
              "StormGlass APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰:",
              stormglassError,
            );
            // StormGlass APIãŒå¤±æ•—ã—ã¦ã‚‚OpenWeatherMapã®ãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ
          }

          displayOceanData(oceanData, tideData, waveData);
        } catch (error) {
          console.error("æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);

          // ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          let errorMessage = "æµ·æ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

          if (error.message && error.message.includes("404")) {
            errorMessage =
              "ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚<br>" +
              "<strong>Vercel é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼š</strong><br>" +
              "1. <code>npm install -g vercel</code> ã§Vercel CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«<br>" +
              "2. <code>.env.local</code> ã« API ã‚­ãƒ¼ã‚’è¨­å®š<br>" +
              "3. <code>vercel dev</code> ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•";
          } else if (error.message && error.message.includes("503")) {
            errorMessage =
              "API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>" +
              "<strong>.env.local ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</strong>";
          } else if (error.message && error.message.includes("401")) {
            errorMessage =
              "API ã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚<br>" +
              "<strong>.env.local ã®APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„</strong>";
          }

          showError(errorMessage);
        }
      }

      /**
       * æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’UIã«è¡¨ç¤º
       */
      function displayOceanData(oceanData, tideData, waveData) {
        const container = document.getElementById("oceanDataContainer");

        const html = `
          <div class="location-info">
            <p><strong>åœ°ç‚¹:</strong> ${escapeHtml(oceanData.location.name)}</p>
            <p><strong>åº§æ¨™:</strong> ${oceanData.location.latitude.toFixed(4)}, ${oceanData.location.longitude.toFixed(4)}</p>
            <p><strong>å–å¾—æ™‚åˆ»:</strong> ${oceanData.timestamp.toLocaleString("ja-JP")}</p>
          </div>

          <div class="weather-info">
            <div class="weather-card">
              <div class="label"><i data-lucide="thermometer"></i> æ°—æ¸©</div>
              <div class="value">${oceanData.weather.temperature.toFixed(1)}Â°C</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="wind"></i> é¢¨é€Ÿ</div>
              <div class="value">${oceanData.weather.windSpeed.toFixed(1)} m/s</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="droplets"></i> æ¹¿åº¦</div>
              <div class="value">${oceanData.weather.humidity}%</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="waves"></i> æ¨å®šæ³¢é«˜</div>
              <div class="value">${oceanData.waves.estimatedHeight.max.toFixed(1)}m</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="compass"></i> é¢¨å‘ã</div>
              <div class="value">${getWindDirection(oceanData.weather.windDirection)}</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="cloud"></i> é›²é‡</div>
              <div class="value">${oceanData.weather.cloudiness}%</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="sun"></i> æ—¥å‡º</div>
              <div class="value">${oceanData.sunrise.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="moon"></i> æ—¥æ²¡</div>
              <div class="value">${oceanData.sunset.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
            </div>
          </div>

          ${
            tideData
              ? `
          <div style="margin-top: 15px; padding: 15px; background: rgba(100, 180, 255, 0.1); border: 2px solid #4db8ff; border-radius: 4px;">
            <h3 style="color: #4db8ff; margin-top: 0; margin-bottom: 12px;"><i data-lucide="waves"></i> æ½®æ±æƒ…å ±ï¼ˆStormGlassï¼‰</h3>

            ${
              tideData.current
                ? `
            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">ç¾åœ¨ã®æ½®ä½</div>
              <div class="value" style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">${tideData.current.emoji}</span>
                <div>
                  <div>${tideData.current.label}</div>
                  <small style="color: #8099b8;">${tideData.current.height.toFixed(2)}m</small>
                </div>
              </div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${tideData.current.description}</small>
            </div>
            `
                : ""
            }

            ${
              tideData.next
                ? `
              <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">æ¬¡ã®æ½®æ™‚</div>
              <div class="value" style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">${tideData.next.emoji}</span>
                <div>
                  <div>${tideData.next.label}</div>
                  <small style="color: #8099b8;">${tideData.next.time.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })} (é«˜ã•: ${tideData.next.height.toFixed(2)}m)</small>
                </div>
              </div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${tideData.next.description}</small>
            </div>
            `
                : ""
            }

            ${
              tideData.range
                ? `
            <div class="weather-card">
              <div class="label">æ½®ä½ãƒ¬ãƒ³ã‚¸</div>
              <div class="value">${tideData.range.max.toFixed(2)}m / ${tideData.range.min.toFixed(2)}m</div>
            </div>
            `
                : ""
            }
          </div>
          `
              : ""
          }

          ${
            waveData
              ? `
          <div style="margin-top: 15px; padding: 15px; background: rgba(255, 150, 100, 0.1); border: 2px solid #ff8c00; border-radius: 4px;">
            <h3 style="color: #ff8c00; margin-top: 0; margin-bottom: 12px;"><i data-lucide="waves"></i> æ³¢æµªæƒ…å ±ï¼ˆStormGlassï¼‰</h3>

            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">æ³¢é«˜</div>
              <div class="value">${waveData.current.waveHeight.toFixed(2)}m</div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${waveData.quality.emoji} ${waveData.quality.rating} - ${waveData.quality.description}</small>
            </div>

            ${
              waveData.current.wavePeriod
                ? `
            <div class="weather-card">
              <div class="label">æ³¢å‘¨æœŸ</div>
              <div class="value">${waveData.current.wavePeriod.toFixed(1)}s</div>
            </div>
            `
                : ""
            }

            <div id="waveGraphContainer" style="margin-top: 15px; background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95)); border: 2px solid #3a4d6b; border-radius: 2px; padding: 12px;">
              <p id="waveGraphPlaceholder" style="text-align: center; color: #8099b8; margin: 20px 0;">æ³¢é«˜ã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
              <svg id="waveGraphSvg" style="width: 100%; height: auto; display: none; background: linear-gradient(135deg, rgba(5, 4, 4, 0.9) 0%, rgba(15, 20, 35, 0.85) 100%);"></svg>
            </div>

            <div id="windGraphContainer" style="margin-top: 12px; background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95)); border: 2px solid #3a4d6b; border-radius: 2px; padding: 12px;">
              <p id="windGraphPlaceholder" style="text-align: center; color: #8099b8; margin: 20px 0;">é¢¨é€Ÿã‚°ãƒ©ãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
              <svg id="windGraphSvg" style="width: 100%; height: auto; display: none; background: linear-gradient(135deg, rgba(5, 4, 4, 0.9) 0%, rgba(15, 20, 35, 0.85) 100%);"></svg>
            </div>
          </div>
          `
              : ""
          }

          <div class="recommendation-box">
            <strong><i data-lucide="target"></i> é‡£ã‚Šã®æ¨å¥¨åº¦:</strong><br/>
            ${oceanData.waves.recommendation}
          </div>

          <div class="button-group">
            <button onclick="copyLocationToClipboard()"><i data-lucide="copy"></i> åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼</button>
            <button onclick="saveFishingLocation()"><i data-lucide="save"></i> é‡£è¡Œè¨˜éŒ²ã«ä½¿ç”¨</button>
          </div>
        `;

        container.innerHTML = html;

        // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆæœŸåŒ–
        if (window.lucide) {
          window.lucide.createIcons();
        }

        // ã‚°ãƒ©ãƒ•ã‚’æç”»ï¼ˆwaveDataãŒã‚ã‚‹å ´åˆï¼‰
        if (waveData && waveData.trend24h) {
          drawWaveGraph(waveData);
          drawWindGraph(oceanData);
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦æ©Ÿèƒ½ã‚’è¨­å®š
        window.copyLocationToClipboard = function () {
          const text = `${oceanData.location.latitude.toFixed(6)}, ${oceanData.location.longitude.toFixed(6)}`;
          navigator.clipboard.writeText(text).then(() => {
            alert("åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
          });
        };

        window.saveFishingLocation = function () {
          // fishing-log.html ã¸ã®é·ç§»æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
          sessionStorage.setItem(
            "oceanData",
            JSON.stringify({
              location: {
                lat: oceanData.location.latitude,
                lng: oceanData.location.longitude,
              },
              date: new Date().toISOString().split("T")[0],
              temperature: oceanData.weather.temperature,
              waterTemperature: oceanData.weather.temperature, // è¿‘ä¼¼å€¤
              windSpeed: oceanData.weather.windSpeed,
              windDirection: oceanData.weather.windDirection,
              humidity: oceanData.weather.humidity,
              cloudiness: oceanData.weather.cloudiness,
              pressure: oceanData.weather.pressure,
              sunrise: oceanData.sunrise.toISOString(),
              sunset: oceanData.sunset.toISOString(),
              tideHeight: tideData?.current?.height || null,
              waveHeight: waveData?.current?.waveHeight || null,
              wavePeriod: waveData?.current?.wavePeriod || null,
            }),
          );
          window.location.href = "fishing-log.html";
        };
      }

      /**
       * æœ‰åé‡£ã‚Šå ´ã‚’UIã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
       */
      function renderFishingSpots() {
        const container = document.getElementById("fishingSpots");
        container.innerHTML = FAMOUS_FISHING_SPOTS.map((spot) => {
          return `
            <button class="spot-button" onclick="selectSpot(${spot.latitude}, ${spot.longitude})">
              <strong>${escapeHtml(spot.name)}</strong>
              <small>${escapeHtml(spot.region)}</small>
            </button>
          `;
        }).join("");

        window.selectSpot = function (lat, lng) {
          fetchOceanData(lat, lng);
        };
      }

      /**
       * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
       */
      function showError(message) {
        const container = document.getElementById("oceanDataContainer");
        // message ã« HTML ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤ºï¼ˆå†…éƒ¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãŸã‚å®‰å…¨ï¼‰
        container.innerHTML = `<div class="error-message" style="padding: 15px; border-radius: 4px; line-height: 1.6;">
          <strong style="display: block; margin-bottom: 10px; color: #ff6b6b;">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong>
          <div style="color: #ff8787; font-size: 0.95rem;">${message}</div>
        </div>`;
      }

      /**
       * é¢¨å‘ãã‚’æ—¥æœ¬èªã§å–å¾—
       */
      function getWindDirection(degrees) {
        const directions = [
          "N",
          "NNE",
          "NE",
          "ENE",
          "E",
          "ESE",
          "SE",
          "SSE",
          "S",
          "SSW",
          "SW",
          "WSW",
          "W",
          "WNW",
          "NW",
          "NNW",
        ];
        const index = Math.round(degrees / 22.5) % 16;
        return directions[index];
      }

      /**
       * XSSå¯¾ç­–: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
       */
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return String(text).replace(/[&<>"']/g, (m) => map[m]);
      }

      /**
       * æ³¢é«˜ã®24æ™‚é–“æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’æç”»
       */
      function drawWaveGraph(waveData) {
        const container = document.getElementById("waveGraphContainer");
        const placeholder = document.getElementById("waveGraphPlaceholder");
        const svg = document.getElementById("waveGraphSvg");

        if (!waveData || !waveData.trend24h || waveData.trend24h.length === 0) {
          placeholder.textContent = "æ³¢é«˜ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
          return;
        }

        const width = 340;
        const height = 150;
        const padding = { top: 20, right: 15, bottom: 25, left: 35 };
        const graphWidth = width - padding.left - padding.right;
        const graphHeight = height - padding.top - padding.bottom;

        // æ³¢é«˜ã®æœ€å¤§ãƒ»æœ€å°ã‚’è¨ˆç®—
        const waveHeights = waveData.trend24h.map((d) => d.waveHeight);
        const minWave = Math.min(...waveHeights);
        const maxWave = Math.max(...waveHeights);
        const rangeWave = maxWave - minWave || 1;

        // SVGåˆæœŸåŒ–
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.innerHTML = "";

        // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
        const gridGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g",
        );
        gridGroup.setAttribute("stroke", "#6b5d3f");
        gridGroup.setAttribute("stroke-width", "0.5");

        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (graphHeight / 4) * i;
          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line",
          );
          line.setAttribute("x1", padding.left);
          line.setAttribute("x2", width - padding.right);
          line.setAttribute("y1", y);
          line.setAttribute("y2", y);
          gridGroup.appendChild(line);
        }
        svg.appendChild(gridGroup);

        // æ³¢é«˜æ›²ç·šã‚’æç”»
        let pathData = `M ${padding.left} ${padding.top + graphHeight}`;
        for (let i = 0; i < waveData.trend24h.length; i++) {
          const x =
            padding.left +
            (graphWidth / (waveData.trend24h.length - 1 || 1)) * i;
          const normalizedHeight =
            (waveData.trend24h[i].waveHeight - minWave) / rangeWave;
          const y = padding.top + graphHeight - normalizedHeight * graphHeight;
          pathData += ` L ${x} ${y}`;
        }

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        path.setAttribute("d", pathData);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#ff9944");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);

        // è»¸ãƒ©ãƒ™ãƒ«
        const yAxisLabel = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabel.setAttribute("x", 5);
        yAxisLabel.setAttribute("y", padding.top + 10);
        yAxisLabel.setAttribute("font-size", "10");
        yAxisLabel.setAttribute("fill", "#8099b8");
        yAxisLabel.textContent = `${maxWave.toFixed(1)}m`;
        svg.appendChild(yAxisLabel);

        const yAxisLabelMin = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabelMin.setAttribute("x", 5);
        yAxisLabelMin.setAttribute("y", padding.top + graphHeight + 10);
        yAxisLabelMin.setAttribute("font-size", "10");
        yAxisLabelMin.setAttribute("fill", "#8099b8");
        yAxisLabelMin.textContent = `${minWave.toFixed(1)}m`;
        svg.appendChild(yAxisLabelMin);

        placeholder.style.display = "none";
        svg.style.display = "block";
      }

      /**
       * é¢¨é€Ÿã®24æ™‚é–“æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’æç”»
       */
      function drawWindGraph(oceanData) {
        const container = document.getElementById("windGraphContainer");
        const placeholder = document.getElementById("windGraphPlaceholder");
        const svg = document.getElementById("windGraphSvg");

        if (!oceanData || !oceanData.windTrend24h) {
          placeholder.textContent = "é¢¨é€Ÿãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
          return;
        }

        const windData = oceanData.windTrend24h;
        if (windData.length === 0) {
          placeholder.textContent = "é¢¨é€Ÿãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
          return;
        }

        const width = 340;
        const height = 150;
        const padding = { top: 20, right: 15, bottom: 25, left: 35 };
        const graphWidth = width - padding.left - padding.right;
        const graphHeight = height - padding.top - padding.bottom;

        // é¢¨é€Ÿã®æœ€å¤§ãƒ»æœ€å°ã‚’è¨ˆç®—
        const windSpeeds = windData.map((d) => d.windSpeed);
        const minWind = Math.min(...windSpeeds);
        const maxWind = Math.max(...windSpeeds);
        const rangeWind = maxWind - minWind || 1;

        // SVGåˆæœŸåŒ–
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.innerHTML = "";

        // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
        const gridGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g",
        );
        gridGroup.setAttribute("stroke", "#6b5d3f");
        gridGroup.setAttribute("stroke-width", "0.5");

        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (graphHeight / 4) * i;
          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line",
          );
          line.setAttribute("x1", padding.left);
          line.setAttribute("x2", width - padding.right);
          line.setAttribute("y1", y);
          line.setAttribute("y2", y);
          gridGroup.appendChild(line);
        }
        svg.appendChild(gridGroup);

        // é¢¨é€Ÿæ›²ç·šã‚’æç”»
        let pathData = `M ${padding.left} ${padding.top + graphHeight}`;
        for (let i = 0; i < windData.length; i++) {
          const x =
            padding.left + (graphWidth / (windData.length - 1 || 1)) * i;
          const normalizedSpeed = (windData[i].windSpeed - minWind) / rangeWind;
          const y = padding.top + graphHeight - normalizedSpeed * graphHeight;
          pathData += ` L ${x} ${y}`;
        }

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        path.setAttribute("d", pathData);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#6fb8ff");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);

        // è»¸ãƒ©ãƒ™ãƒ«
        const yAxisLabel = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabel.setAttribute("x", 5);
        yAxisLabel.setAttribute("y", padding.top + 10);
        yAxisLabel.setAttribute("font-size", "10");
        yAxisLabel.setAttribute("fill", "#8099b8");
        yAxisLabel.textContent = `${maxWind.toFixed(1)}m/s`;
        svg.appendChild(yAxisLabel);

        const yAxisLabelMin = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabelMin.setAttribute("x", 5);
        yAxisLabelMin.setAttribute("y", padding.top + graphHeight + 10);
        yAxisLabelMin.setAttribute("font-size", "10");
        yAxisLabelMin.setAttribute("fill", "#8099b8");
        yAxisLabelMin.textContent = `${minWind.toFixed(1)}m/s`;
        svg.appendChild(yAxisLabelMin);

        placeholder.style.display = "none";
        svg.style.display = "block";
      }

      /**
       * Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºï¼ˆIDã§æŒ‡å®šï¼‰
       * @param {string} iconName - Lucideã‚¢ã‚¤ã‚³ãƒ³å
       * @param {number} size - ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ24ï¼‰
       * @returns {string} SVGã‚¢ã‚¤ã‚³ãƒ³HTMLæ–‡å­—åˆ—
       */
      function getLucideIcon(iconName, size = 24) {
        // ã‚¢ã‚¤ã‚³ãƒ³åã‚’ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã«å¤‰æ›
        const camelCase = iconName
          .split("-")
          .map((word, i) =>
            i === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1),
          )
          .join("");

        // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        if (window.lucide && window.lucide[camelCase]) {
          const icon = window.lucide[camelCase];
          const svg = icon.toSvg();
          svg.setAttribute("width", size);
          svg.setAttribute("height", size);
          svg.setAttribute("stroke", "currentColor");
          svg.setAttribute("fill", "none");
          svg.setAttribute("stroke-width", "2");
          svg.style.display = "inline";
          svg.style.verticalAlign = "middle";
          svg.style.marginRight = "4px";
          return svg.outerHTML;
        }
        return `<span style="font-size: ${size}px; vertical-align: middle; margin-right: 4px;">?</span>`;
      }

      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
      window.addEventListener("load", () => {
        init();
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œã«Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆæœŸåŒ–
        if (window.lucide) {
          window.lucide.createIcons();
        }
      });
    </script>
  </body>
</html>
