<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>海況チェッカー - AbyssAtlas</title>
    <link rel="stylesheet" href="stylesheet.css" />
    <link rel="stylesheet" href="stylesheet-darksoul.css" />
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        background: #050404 !important;
        background-image:
          radial-gradient(
            ellipse at 50% 0%,
            rgba(100, 150, 200, 0.05) 0%,
            transparent 50%
          ),
          linear-gradient(to bottom, rgba(30, 50, 80, 0.1) 0%, transparent 50%) !important;
        color: #8099b8;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
      }

      .ocean-checker-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 900px) {
        .ocean-checker-container {
          grid-template-columns: 1fr;
        }
      }

      .section {
        background: linear-gradient(
          135deg,
          rgba(5, 4, 4, 0.95),
          rgba(15, 25, 45, 0.95)
        );
        border: 2px solid #506080;
        border-radius: 4px;
        padding: 20px;
        box-shadow:
          0 8px 30px rgba(0, 0, 0, 0.9),
          inset 0 0 20px rgba(128, 153, 184, 0.02);
      }

      .section h2 {
        color: #c4d8f0;
        text-shadow: 0 0 8px rgba(180, 200, 220, 0.3);
        margin-top: 0;
        border-bottom: 2px solid #506080;
        padding-bottom: 10px;
      }

      #mapContainer {
        width: 100%;
        height: 500px;
        border: 2px solid #506080;
        border-radius: 4px;
        background: #1a1a1a;
      }

      .weather-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .weather-card {
        background: rgba(30, 50, 80, 0.5);
        border: 1px solid #506080;
        border-radius: 4px;
        padding: 12px;
        text-align: center;
      }

      .weather-card .label {
        color: #a89560;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .weather-card .value {
        color: #4db8ff;
        font-size: 1.3rem;
        font-weight: bold;
        text-shadow: 0 0 6px rgba(77, 184, 255, 0.3);
      }

      .recommendation-box {
        background: linear-gradient(
          135deg,
          rgba(100, 150, 200, 0.1),
          rgba(50, 80, 120, 0.1)
        );
        border: 2px solid #506080;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        font-size: 1rem;
        line-height: 1.6;
        color: #c4d8f0;
      }

      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        background: linear-gradient(135deg, #506080, #6b8fb0);
        color: #c4d8f0;
        border: 2px solid #8099b8;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      button:hover {
        background: linear-gradient(135deg, #6b8fb0, #8099b8);
        box-shadow: 0 4px 12px rgba(128, 153, 184, 0.3);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .fishing-spots {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .spot-button {
        background: rgba(50, 80, 120, 0.6);
        border: 1px solid #506080;
        padding: 10px;
        border-radius: 4px;
        text-align: left;
        color: #8099b8;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
      }

      .spot-button:hover {
        background: rgba(70, 100, 140, 0.8);
        border-color: #8099b8;
      }

      .spot-button strong {
        display: block;
        color: #4db8ff;
        margin-bottom: 2px;
      }

      .spot-button small {
        color: #6b7b82;
      }

      .error-message {
        background: rgba(255, 100, 100, 0.2);
        border: 1px solid #ff6b6b;
        color: #ff8787;
        padding: 12px;
        border-radius: 4px;
        margin-top: 10px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(77, 184, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4db8ff;
        animation: spin 1s ease-in-out infinite;
      }

      .lucide-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        margin-right: 4px;
        vertical-align: middle;
      }

      .lucide-icon svg {
        width: 100%;
        height: 100%;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      /* Lucideアイコンのインラインスタイル */
      i[data-lucide] {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1em;
        height: 1em;
        margin-right: 0.25em;
        vertical-align: middle;
        color: currentColor;
      }

      i[data-lucide] svg {
        width: 100%;
        height: 100%;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
      }

      .weather-card .label i[data-lucide] {
        width: 1.2em;
        height: 1.2em;
      }

      button i[data-lucide] {
        width: 1em;
        height: 1em;
        margin-right: 0.5em;
      }

      strong i[data-lucide] {
        width: 1.2em;
        height: 1.2em;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .location-info {
        background: rgba(30, 50, 80, 0.5);
        border: 1px solid #506080;
        border-radius: 4px;
        padding: 12px;
        margin-top: 10px;
        font-size: 0.9rem;
      }

      .location-info p {
        margin: 5px 0;
        color: #8099b8;
      }

      .location-info strong {
        color: #4db8ff;
      }

      .loading-spinner {
        text-align: center;
        padding: 20px;
      }

      .no-data {
        text-align: center;
        color: #6b7b82;
        padding: 20px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="ocean-checker-container">
      <!-- 地図セクション -->
      <div class="section">
        <h2>釣り場を選択</h2>
        <p style="color: #8099b8; font-size: 0.9rem; margin: 0 0 10px 0">
          マップ上をクリックして地点を選択、または下から有名釣り場を選択してください。
        </p>
        <div id="mapContainer"></div>

        <div
          class="section"
          style="margin-top: 20px; border: 1px solid #506080"
        >
          <h3 style="color: #c4d8f0; margin-top: 0; font-size: 1rem">
            有名釣り場
          </h3>
          <div class="fishing-spots" id="fishingSpots"></div>
        </div>

        <!-- 海況チェック履歴セクション -->
        <div
          class="section"
          style="margin-top: 20px; border: 1px solid #506080"
        >
          <h3 style="color: #c4d8f0; margin-top: 0; font-size: 1rem">
            <i data-lucide="history"></i> 過去のチェック履歴
          </h3>
          <div id="historyContainer" class="no-data" style="padding: 10px">
            ログインして地点をチェックすると、履歴が保存されます
          </div>
        </div>
      </div>

      <!-- 海況情報セクション -->
      <div class="section">
        <h2 id="oceanInfoTitle"><i data-lucide="waves"></i> 海況情報</h2>
        <div id="oceanDataContainer">
          <div class="no-data">
            地点を選択して、その地点の海況情報を取得してください。
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        initializeMap,
        addFishingSpotMarkers,
        getSelectedLocation,
      } from "./google-maps-integration.js";
      import {
        getOceanWeather,
        FAMOUS_FISHING_SPOTS,
      } from "./ocean-weather.js";
      import {
        getTideData,
        getWaveData,
        evaluateOverallCondition,
      } from "./stormglass-integration.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        getDocs,
        deleteDoc,
        doc,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
      import { firebaseConfig } from "./firebase-config.js";

      // Googleマップスクリプトの動的読み込み
      async function loadGoogleMapsAPI() {
        try {
          // バックエンド関数からAPIキーを取得
          const response = await fetch("/api/google-maps-key");
          if (!response.ok) {
            throw new Error("Failed to get Google Maps API key");
          }
          const { apiKey } = await response.json();

          return new Promise((resolve) => {
            // callback パラメータで API 読み込み完了時に呼び出す
            window.initGoogleMapsCallback = resolve;
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=maps,marker&language=ja&loading=async&callback=initGoogleMapsCallback`;
            script.async = true;
            document.head.appendChild(script);
          });
        } catch (error) {
          console.error("Google Maps API loading failed:", error);
          throw error;
        }
      }

      // Firebase初期化とグローバル変数
      let firebaseApp;
      let auth;
      let db;
      let currentUser = null;

      // 初期化
      async function init() {
        try {
          // Firebase初期化
          firebaseApp = initializeApp(firebaseConfig);
          auth = getAuth(firebaseApp);
          db = getFirestore(firebaseApp);

          // ユーザー認証状態を監視
          onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
              loadOceanCheckerHistory();
            } else {
              document.getElementById("historyContainer").innerHTML =
                '<div class="no-data" style="padding: 10px;">ログインして海況チェックを保存してください</div>';
            }
          });

          // Googleマップの読み込みと初期化
          await loadGoogleMapsAPI();
          await initializeMap("mapContainer", 36.2048, 138.2529, 6);

          // 有名釣り場をマップに追加
          await addFishingSpotMarkers(FAMOUS_FISHING_SPOTS);
          renderFishingSpots();

          // 地点選択イベントをリッスン
          window.addEventListener("locationSelected", async (e) => {
            const { latitude, longitude } = e.detail;
            await fetchOceanData(latitude, longitude);
          });
        } catch (error) {
          console.error("初期化エラー:", error);
          showError(
            "マップの初期化に失敗しました。APIキーを確認してください。",
          );
        }
      }

      /**
       * 海況データを取得して表示
       */
      async function fetchOceanData(latitude, longitude) {
        const container = document.getElementById("oceanDataContainer");
        container.innerHTML =
          '<div class="loading-spinner"><div class="loading"></div>海況データを取得中...</div>';

        try {
          // 気象データを取得
          const oceanData = await getOceanWeather(latitude, longitude);

          // StormGlass APIから潮汐データを取得（試みる）
          let tideData = null;
          let waveData = null;

          try {
            tideData = await getTideData(latitude, longitude);
            waveData = await getWaveData(latitude, longitude);
          } catch (stormglassError) {
            console.warn(
              "StormGlass APIからのデータ取得に失敗（オプション機能）:",
              stormglassError,
            );
            // StormGlass APIが失敗してもOpenWeatherMapのデータで続行
          }

          // グローバル変数に保存（履歴保存用）
          window.currentOceanData = oceanData;
          window.currentTideData = tideData;
          window.currentWaveData = waveData;

          displayOceanData(oceanData, tideData, waveData);
        } catch (error) {
          console.error("海況データ取得エラー:", error);

          // エラーの原因を特定してユーザーフレンドリーなメッセージを表示
          let errorMessage = "海況データの取得に失敗しました。";

          if (error.message && error.message.includes("404")) {
            errorMessage =
              "ローカル開発環境ではバックエンド API が利用できません。<br>" +
              "<strong>Vercel 開発サーバーを起動してください：</strong><br>" +
              "1. <code>npm install -g vercel</code> でVercel CLIをインストール<br>" +
              "2. <code>.env.local</code> に API キーを設定<br>" +
              "3. <code>vercel dev</code> でサーバーを起動";
          } else if (error.message && error.message.includes("503")) {
            errorMessage =
              "API キーが設定されていません。<br>" +
              "<strong>.env.local ファイルを確認してください</strong>";
          } else if (error.message && error.message.includes("401")) {
            errorMessage =
              "API キーが無効です。<br>" +
              "<strong>.env.local のAPIキーを確認してください</strong>";
          }

          showError(errorMessage);
        }
      }

      /**
       * 海況データをUIに表示
       */
      function displayOceanData(oceanData, tideData, waveData) {
        const container = document.getElementById("oceanDataContainer");

        const html = `
          <div class="location-info">
            <p><strong>地点:</strong> ${escapeHtml(oceanData.location.name)}</p>
            <p><strong>座標:</strong> ${oceanData.location.latitude.toFixed(4)}, ${oceanData.location.longitude.toFixed(4)}</p>
            <p><strong>取得時刻:</strong> ${oceanData.timestamp.toLocaleString("ja-JP")}</p>
          </div>

          <div class="weather-info">
            <div class="weather-card">
              <div class="label"><i data-lucide="thermometer"></i> 気温</div>
              <div class="value">${oceanData.weather.temperature.toFixed(1)}°C</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="wind"></i> 風速</div>
              <div class="value">${oceanData.weather.windSpeed.toFixed(1)} m/s</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="droplets"></i> 湿度</div>
              <div class="value">${oceanData.weather.humidity}%</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="waves"></i> 推定波高</div>
              <div class="value">${oceanData.waves.estimatedHeight.max.toFixed(1)}m</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="compass"></i> 風向き</div>
              <div class="value">${getWindDirection(oceanData.weather.windDirection)}</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="cloud"></i> 雲量</div>
              <div class="value">${oceanData.weather.cloudiness}%</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="sun"></i> 日出</div>
              <div class="value">${oceanData.sunrise.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
            </div>
            <div class="weather-card">
              <div class="label"><i data-lucide="moon"></i> 日没</div>
              <div class="value">${oceanData.sunset.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })}</div>
            </div>
          </div>

          ${
            tideData
              ? `
          <div style="margin-top: 15px; padding: 15px; background: rgba(100, 180, 255, 0.1); border: 2px solid #4db8ff; border-radius: 4px;">
            <h3 style="color: #4db8ff; margin-top: 0; margin-bottom: 12px;"><i data-lucide="waves"></i> 潮汐情報（StormGlass）</h3>

            ${
              tideData.current
                ? `
            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">現在の潮位</div>
              <div class="value" style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">${tideData.current.emoji}</span>
                <div>
                  <div>${tideData.current.label}</div>
                  <small style="color: #8099b8;">${tideData.current.height.toFixed(2)}m</small>
                </div>
              </div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${tideData.current.description}</small>
            </div>
            `
                : ""
            }

            ${
              tideData.next
                ? `
              <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">次の潮時</div>
              <div class="value" style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">${tideData.next.emoji}</span>
                <div>
                  <div>${tideData.next.label}</div>
                  <small style="color: #8099b8;">${tideData.next.time.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" })} (高さ: ${tideData.next.height.toFixed(2)}m)</small>
                </div>
              </div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${tideData.next.description}</small>
            </div>
            `
                : ""
            }

            ${
              tideData.range
                ? `
            <div class="weather-card">
              <div class="label">潮位レンジ</div>
              <div class="value">${tideData.range.max.toFixed(2)}m / ${tideData.range.min.toFixed(2)}m</div>
            </div>
            `
                : ""
            }
          </div>
          `
              : ""
          }

          ${
            waveData
              ? `
          <div style="margin-top: 15px; padding: 15px; background: rgba(255, 150, 100, 0.1); border: 2px solid #ff8c00; border-radius: 4px;">
            <h3 style="color: #ff8c00; margin-top: 0; margin-bottom: 12px;"><i data-lucide="waves"></i> 波浪情報（StormGlass）</h3>

            <div class="weather-card" style="margin-bottom: 10px;">
              <div class="label">波高</div>
              <div class="value">${waveData.current.waveHeight.toFixed(2)}m</div>
              <small style="color: #8099b8; display: block; margin-top: 5px;">${waveData.quality.emoji} ${waveData.quality.rating} - ${waveData.quality.description}</small>
            </div>

            ${
              waveData.current.wavePeriod
                ? `
            <div class="weather-card">
              <div class="label">波周期</div>
              <div class="value">${waveData.current.wavePeriod.toFixed(1)}s</div>
            </div>
            `
                : ""
            }

            <div id="waveGraphContainer" style="margin-top: 15px; background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95)); border: 2px solid #3a4d6b; border-radius: 2px; padding: 12px;">
              <p id="waveGraphPlaceholder" style="text-align: center; color: #8099b8; margin: 20px 0;">波高グラフを読み込み中...</p>
              <svg id="waveGraphSvg" style="width: 100%; height: auto; display: none; background: linear-gradient(135deg, rgba(5, 4, 4, 0.9) 0%, rgba(15, 20, 35, 0.85) 100%);"></svg>
            </div>

            <div id="windGraphContainer" style="margin-top: 12px; background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95)); border: 2px solid #3a4d6b; border-radius: 2px; padding: 12px;">
              <p id="windGraphPlaceholder" style="text-align: center; color: #8099b8; margin: 20px 0;">風速グラフを読み込み中...</p>
              <svg id="windGraphSvg" style="width: 100%; height: auto; display: none; background: linear-gradient(135deg, rgba(5, 4, 4, 0.9) 0%, rgba(15, 20, 35, 0.85) 100%);"></svg>
            </div>
          </div>
          `
              : ""
          }

          <div class="recommendation-box">
            <strong><i data-lucide="target"></i> 釣りの推奨度:</strong><br/>
            ${oceanData.waves.recommendation}
          </div>

          <div class="button-group">
            <button onclick="copyLocationToClipboard()"><i data-lucide="copy"></i> 座標をコピー</button>
            <button onclick="saveToHistory()"><i data-lucide="bookmark"></i> 履歴に保存</button>
            <button onclick="saveFishingLocation()"><i data-lucide="save"></i> 釣行記録に使用</button>
          </div>
        `;

        container.innerHTML = html;

        // Lucideアイコンを初期化
        if (window.lucide) {
          window.lucide.createIcons();
        }

        // グラフを描画（waveDataがある場合）
        if (waveData && waveData.trend24h) {
          drawWaveGraph(waveData);
          drawWindGraph(oceanData);
        }

        // グローバル関数として機能を設定
        window.copyLocationToClipboard = function () {
          const text = `${oceanData.location.latitude.toFixed(6)}, ${oceanData.location.longitude.toFixed(6)}`;
          navigator.clipboard.writeText(text).then(() => {
            alert("座標をコピーしました");
          });
        };

        window.saveFishingLocation = function () {
          // fishing-log.html への遷移時にデータを渡す
          sessionStorage.setItem(
            "oceanData",
            JSON.stringify({
              location: {
                lat: oceanData.location.latitude,
                lng: oceanData.location.longitude,
              },
              date: new Date().toISOString().split("T")[0],
              temperature: oceanData.weather.temperature,
              waterTemperature: oceanData.weather.temperature, // 近似値
              windSpeed: oceanData.weather.windSpeed,
              windDirection: oceanData.weather.windDirection,
              humidity: oceanData.weather.humidity,
              cloudiness: oceanData.weather.cloudiness,
              pressure: oceanData.weather.pressure,
              sunrise: oceanData.sunrise.toISOString(),
              sunset: oceanData.sunset.toISOString(),
              tideHeight: tideData?.current?.height || null,
              waveHeight: waveData?.current?.waveHeight || null,
              wavePeriod: waveData?.current?.wavePeriod || null,
            }),
          );
          window.location.href = "fishing-log.html";
        };
      }

      /**
       * 有名釣り場をUIにレンダリング
       */
      function renderFishingSpots() {
        const container = document.getElementById("fishingSpots");
        container.innerHTML = FAMOUS_FISHING_SPOTS.map((spot) => {
          return `
            <button class="spot-button" onclick="selectSpot(${spot.latitude}, ${spot.longitude})">
              <strong>${escapeHtml(spot.name)}</strong>
              <small>${escapeHtml(spot.region)}</small>
            </button>
          `;
        }).join("");

        window.selectSpot = function (lat, lng) {
          fetchOceanData(lat, lng);
        };
      }

      /**
       * エラー表示
       */
      function showError(message) {
        const container = document.getElementById("oceanDataContainer");
        // message に HTML が含まれている場合はそのまま表示（内部エラーメッセージのため安全）
        container.innerHTML = `<div class="error-message" style="padding: 15px; border-radius: 4px; line-height: 1.6;">
          <strong style="display: block; margin-bottom: 10px; color: #ff6b6b;">⚠️ エラーが発生しました</strong>
          <div style="color: #ff8787; font-size: 0.95rem;">${message}</div>
        </div>`;
      }

      /**
       * 風向きを日本語で取得
       */
      function getWindDirection(degrees) {
        const directions = [
          "N",
          "NNE",
          "NE",
          "ENE",
          "E",
          "ESE",
          "SE",
          "SSE",
          "S",
          "SSW",
          "SW",
          "WSW",
          "W",
          "WNW",
          "NW",
          "NNW",
        ];
        const index = Math.round(degrees / 22.5) % 16;
        return directions[index];
      }

      /**
       * XSS対策: HTMLエスケープ
       */
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return String(text).replace(/[&<>"']/g, (m) => map[m]);
      }

      /**
       * 波高の24時間推移グラフを描画
       */
      function drawWaveGraph(waveData) {
        const container = document.getElementById("waveGraphContainer");
        const placeholder = document.getElementById("waveGraphPlaceholder");
        const svg = document.getElementById("waveGraphSvg");

        if (!waveData || !waveData.trend24h || waveData.trend24h.length === 0) {
          placeholder.textContent = "波高データが利用できません";
          return;
        }

        const width = 340;
        const height = 150;
        const padding = { top: 20, right: 15, bottom: 25, left: 35 };
        const graphWidth = width - padding.left - padding.right;
        const graphHeight = height - padding.top - padding.bottom;

        // 波高の最大・最小を計算
        const waveHeights = waveData.trend24h.map((d) => d.waveHeight);
        const minWave = Math.min(...waveHeights);
        const maxWave = Math.max(...waveHeights);
        const rangeWave = maxWave - minWave || 1;

        // SVG初期化
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.innerHTML = "";

        // 背景グリッド
        const gridGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g",
        );
        gridGroup.setAttribute("stroke", "#6b5d3f");
        gridGroup.setAttribute("stroke-width", "0.5");

        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (graphHeight / 4) * i;
          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line",
          );
          line.setAttribute("x1", padding.left);
          line.setAttribute("x2", width - padding.right);
          line.setAttribute("y1", y);
          line.setAttribute("y2", y);
          gridGroup.appendChild(line);
        }
        svg.appendChild(gridGroup);

        // 波高曲線を描画
        let pathData = `M ${padding.left} ${padding.top + graphHeight}`;
        for (let i = 0; i < waveData.trend24h.length; i++) {
          const x =
            padding.left +
            (graphWidth / (waveData.trend24h.length - 1 || 1)) * i;
          const normalizedHeight =
            (waveData.trend24h[i].waveHeight - minWave) / rangeWave;
          const y = padding.top + graphHeight - normalizedHeight * graphHeight;
          pathData += ` L ${x} ${y}`;
        }

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        path.setAttribute("d", pathData);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#ff9944");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);

        // 軸ラベル
        const yAxisLabel = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabel.setAttribute("x", 5);
        yAxisLabel.setAttribute("y", padding.top + 10);
        yAxisLabel.setAttribute("font-size", "10");
        yAxisLabel.setAttribute("fill", "#8099b8");
        yAxisLabel.textContent = `${maxWave.toFixed(1)}m`;
        svg.appendChild(yAxisLabel);

        const yAxisLabelMin = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabelMin.setAttribute("x", 5);
        yAxisLabelMin.setAttribute("y", padding.top + graphHeight + 10);
        yAxisLabelMin.setAttribute("font-size", "10");
        yAxisLabelMin.setAttribute("fill", "#8099b8");
        yAxisLabelMin.textContent = `${minWave.toFixed(1)}m`;
        svg.appendChild(yAxisLabelMin);

        placeholder.style.display = "none";
        svg.style.display = "block";
      }

      /**
       * 風速の24時間推移グラフを描画
       */
      function drawWindGraph(oceanData) {
        const container = document.getElementById("windGraphContainer");
        const placeholder = document.getElementById("windGraphPlaceholder");
        const svg = document.getElementById("windGraphSvg");

        if (!oceanData || !oceanData.windTrend24h) {
          placeholder.textContent = "風速データが利用できません";
          return;
        }

        const windData = oceanData.windTrend24h;
        if (windData.length === 0) {
          placeholder.textContent = "風速データが利用できません";
          return;
        }

        const width = 340;
        const height = 150;
        const padding = { top: 20, right: 15, bottom: 25, left: 35 };
        const graphWidth = width - padding.left - padding.right;
        const graphHeight = height - padding.top - padding.bottom;

        // 風速の最大・最小を計算
        const windSpeeds = windData.map((d) => d.windSpeed);
        const minWind = Math.min(...windSpeeds);
        const maxWind = Math.max(...windSpeeds);
        const rangeWind = maxWind - minWind || 1;

        // SVG初期化
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.innerHTML = "";

        // 背景グリッド
        const gridGroup = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "g",
        );
        gridGroup.setAttribute("stroke", "#6b5d3f");
        gridGroup.setAttribute("stroke-width", "0.5");

        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (graphHeight / 4) * i;
          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line",
          );
          line.setAttribute("x1", padding.left);
          line.setAttribute("x2", width - padding.right);
          line.setAttribute("y1", y);
          line.setAttribute("y2", y);
          gridGroup.appendChild(line);
        }
        svg.appendChild(gridGroup);

        // 風速曲線を描画
        let pathData = `M ${padding.left} ${padding.top + graphHeight}`;
        for (let i = 0; i < windData.length; i++) {
          const x =
            padding.left + (graphWidth / (windData.length - 1 || 1)) * i;
          const normalizedSpeed = (windData[i].windSpeed - minWind) / rangeWind;
          const y = padding.top + graphHeight - normalizedSpeed * graphHeight;
          pathData += ` L ${x} ${y}`;
        }

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path",
        );
        path.setAttribute("d", pathData);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#6fb8ff");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);

        // 軸ラベル
        const yAxisLabel = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabel.setAttribute("x", 5);
        yAxisLabel.setAttribute("y", padding.top + 10);
        yAxisLabel.setAttribute("font-size", "10");
        yAxisLabel.setAttribute("fill", "#8099b8");
        yAxisLabel.textContent = `${maxWind.toFixed(1)}m/s`;
        svg.appendChild(yAxisLabel);

        const yAxisLabelMin = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        yAxisLabelMin.setAttribute("x", 5);
        yAxisLabelMin.setAttribute("y", padding.top + graphHeight + 10);
        yAxisLabelMin.setAttribute("font-size", "10");
        yAxisLabelMin.setAttribute("fill", "#8099b8");
        yAxisLabelMin.textContent = `${minWind.toFixed(1)}m/s`;
        svg.appendChild(yAxisLabelMin);

        placeholder.style.display = "none";
        svg.style.display = "block";
      }

      /**
       * Lucideアイコンを表示（IDで指定）
       * @param {string} iconName - Lucideアイコン名
       * @param {number} size - アイコンサイズ（デフォルト24）
       * @returns {string} SVGアイコンHTML文字列
       */
      function getLucideIcon(iconName, size = 24) {
        // アイコン名をキャメルケースに変換
        const camelCase = iconName
          .split("-")
          .map((word, i) =>
            i === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1),
          )
          .join("");

        // Lucideアイコンを取得して表示
        if (window.lucide && window.lucide[camelCase]) {
          const icon = window.lucide[camelCase];
          const svg = icon.toSvg();
          svg.setAttribute("width", size);
          svg.setAttribute("height", size);
          svg.setAttribute("stroke", "currentColor");
          svg.setAttribute("fill", "none");
          svg.setAttribute("stroke-width", "2");
          svg.style.display = "inline";
          svg.style.verticalAlign = "middle";
          svg.style.marginRight = "4px";
          return svg.outerHTML;
        }
        return `<span style="font-size: ${size}px; vertical-align: middle; margin-right: 4px;">?</span>`;
      }

      /**
       * オブジェクトから未定義フィールドを除外
       */
      function cleanUndefinedFields(obj) {
        if (obj === null || obj === undefined) {
          return null;
        }
        if (typeof obj !== "object") {
          return obj;
        }
        if (Array.isArray(obj)) {
          return obj.map((item) => cleanUndefinedFields(item));
        }

        const cleaned = {};
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            const value = obj[key];
            if (value !== undefined && value !== null) {
              cleaned[key] =
                typeof value === "object" ? cleanUndefinedFields(value) : value;
            }
          }
        }
        return cleaned;
      }

      /**
       * 海況情報をFirebaseの履歴に保存
       */
      window.saveToHistory = async function () {
        if (!currentUser) {
          alert("ログインして履歴を保存してください");
          return;
        }

        if (!window.currentOceanData) {
          alert("海況データを取得してから保存してください");
          return;
        }

        try {
          const historyCollection = collection(db, "oceanCheckerHistory");

          // 未定義フィールドをフィルタリング
          const historyData = cleanUndefinedFields({
            uid: currentUser.uid,
            location: window.currentOceanData.location,
            weather: window.currentOceanData.weather,
            waves: window.currentOceanData.waves,
            windTrend24h: window.currentOceanData.windTrend24h,
            sunrise: window.currentOceanData.sunrise.toISOString(),
            sunset: window.currentOceanData.sunset.toISOString(),
            tideData: window.currentTideData || null,
            waveData: window.currentWaveData || null,
            savedAt: new Date().toISOString(),
          });

          const docRef = await addDoc(historyCollection, historyData);

          alert("履歴に保存しました");
          loadOceanCheckerHistory();
        } catch (error) {
          console.error("履歴保存エラー:", error);
          if (
            error.message &&
            error.message.includes("Unsupported field value: undefined")
          ) {
            alert(
              "データにエラーがあります。ページをリロードして再度試してください。",
            );
          } else if (error.code === "permission-denied") {
            alert(
              "保存権限がありません。管理者に Firestore ルールの設定を確認してもらってください。",
            );
          } else {
            alert("履歴の保存に失敗しました: " + error.message);
          }
        }
      };

      /**
       * Firebaseから海況チェック履歴を取得して表示
       */
      async function loadOceanCheckerHistory() {
        if (!currentUser || !db) return;

        try {
          const historyCollection = collection(db, "oceanCheckerHistory");
          // インデックス不要のシンプルなクエリ（uidのみで絞り込み）
          const q = query(
            historyCollection,
            where("uid", "==", currentUser.uid),
          );
          const snapshot = await getDocs(q);

          // クライアント側でソート（新しい順）
          const docs = snapshot.docs.sort((a, b) => {
            const dateA = new Date(a.data().savedAt);
            const dateB = new Date(b.data().savedAt);
            return dateB - dateA;
          });

          const historyContainer = document.getElementById("historyContainer");

          if (snapshot.empty) {
            historyContainer.innerHTML =
              '<div class="no-data" style="padding: 10px;">保存された履歴がありません</div>';
            return;
          }

          let historyHtml =
            '<div style="display: flex; flex-direction: column; gap: 8px;">';
          docs.forEach((doc) => {
            const data = doc.data();
            const savedDate = new Date(data.savedAt).toLocaleString("ja-JP");
            const locationName = data.location.name || "不明な地点";

            historyHtml += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(30, 50, 80, 0.5); border: 1px solid #506080; border-radius: 4px;">
                <div style="cursor: pointer; flex: 1;" onclick="loadHistoryData('${doc.id}')">
                  <div style="color: #4db8ff; font-weight: 600; margin-bottom: 4px;">${escapeHtml(locationName)}</div>
                  <small style="color: #8099b8; display: block;">${escapeHtml(data.location.latitude.toFixed(4))}, ${escapeHtml(data.location.longitude.toFixed(4))}</small>
                  <small style="color: #6b7b82;">${savedDate}</small>
                </div>
                <button onclick="deleteHistoryData('${doc.id}')" style="padding: 6px 10px; background: rgba(255, 100, 100, 0.2); border: 1px solid #ff6b6b; color: #ff8787; border-radius: 2px; cursor: pointer; margin-left: 10px;">削除</button>
              </div>
            `;
          });
          historyHtml += "</div>";

          historyContainer.innerHTML = historyHtml;

          // Lucideアイコンを再初期化
          if (window.lucide) {
            window.lucide.createIcons();
          }
        } catch (error) {
          console.error("履歴読み込みエラー:", error);
          const historyContainer = document.getElementById("historyContainer");
          if (error.code === "permission-denied") {
            historyContainer.innerHTML =
              '<div class="no-data" style="padding: 10px; color: #ff8787;">Firestore ルールの設定を確認してください。管理者に連絡してください。</div>';
          } else {
            historyContainer.innerHTML =
              '<div class="no-data" style="padding: 10px;">履歴の読み込みに失敗しました</div>';
          }
        }
      }

      /**
       * 保存されたtideDataを復元（日付をDateオブジェクトに変換）
       */
      function restoreTideData(tideData) {
        if (!tideData) return null;

        return {
          current: tideData.current
            ? {
                ...tideData.current,
                time: new Date(tideData.current.time),
              }
            : null,
          next: tideData.next
            ? {
                ...tideData.next,
                time: new Date(tideData.next.time),
              }
            : null,
          range: tideData.range || null,
          predictions: tideData.predictions
            ? tideData.predictions.map((p) => ({
                ...p,
                time: new Date(p.time),
              }))
            : [],
        };
      }

      /**
       * Firebaseから履歴データを読み込んで表示
       */
      window.loadHistoryData = async function (docId) {
        try {
          const docRef = doc(db, "oceanCheckerHistory", docId);
          const snapshot = await getDocs(
            query(
              collection(db, "oceanCheckerHistory"),
              where("uid", "==", currentUser.uid),
            ),
          );

          let historyData = null;
          snapshot.forEach((d) => {
            if (d.id === docId) {
              historyData = d.data();
            }
          });

          if (!historyData) {
            alert("履歴データが見つかりません");
            return;
          }

          // グローバル変数に保存
          window.currentOceanData = {
            location: historyData.location,
            weather: historyData.weather,
            waves: historyData.waves,
            windTrend24h: historyData.windTrend24h,
            sunrise: new Date(historyData.sunrise),
            sunset: new Date(historyData.sunset),
            timestamp: new Date(historyData.savedAt),
          };

          // tideData と waveData を復元（日付をDateオブジェクトに変換）
          window.currentTideData = restoreTideData(historyData.tideData);
          window.currentWaveData = historyData.waveData;

          // UIに表示
          displayOceanData(
            window.currentOceanData,
            window.currentTideData,
            window.currentWaveData,
          );
        } catch (error) {
          console.error("履歴データ読み込みエラー:", error);
          alert("履歴データの読み込みに失敗しました");
        }
      };

      /**
       * Firebaseから履歴データを削除
       */
      window.deleteHistoryData = async function (docId) {
        if (!confirm("この履歴を削除しますか？")) return;

        try {
          await deleteDoc(doc(db, "oceanCheckerHistory", docId));
          loadOceanCheckerHistory();
          alert("履歴を削除しました");
        } catch (error) {
          console.error("履歴削除エラー:", error);
          alert("履歴の削除に失敗しました");
        }
      };

      // ページロード時に初期化
      window.addEventListener("load", () => {
        init();
        // ページロード後にLucideアイコンを初期化
        if (window.lucide) {
          window.lucide.createIcons();
        }
      });
    </script>
  </body>
</html>
