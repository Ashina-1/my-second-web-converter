<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>釣果記録アプリ</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #a2d4f7 0%, #0e6ba8 100%);
        position: relative;
        overflow-x: hidden;
      }
      h1 {
        color: #fff;
        text-align: center;
        margin-top: 40px;
        text-shadow: 0 2px 8px #0e6ba8cc;
        letter-spacing: 2px;
      }
      #catchForm {
        margin: 32px auto 0 auto;
        display: none;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 18px 18px 30px 30px;
        padding: 24px 18px 32px 18px;
        max-width: 500px;
        box-shadow: 0 4px 16px 0 #0e6ba84d;
        border-bottom: 8px solid #4fc3f7;
        border-top: 2px solid #b3e5fc;
        position: relative;
        z-index: 1;
      }
      #catchForm label {
        display: block;
        margin-bottom: 10px;
      }
      #catchForm input[type="text"],
      #catchForm input[type="number"],
      #catchForm input[type="date"] {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        box-sizing: border-box;
        border-radius: 6px;
        border: 1px solid #b3e5fc;
        background: #e1f5fe;
      }
      #catchForm button {
        margin-top: 10px;
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
      }
      #catchForm button:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #loginBtn {
        display: block;
        margin: 32px auto 0 auto;
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
      }
      #loginBtn:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 18px 18px 30px 30px;
        max-width: 500px;
        box-shadow: 0 4px 16px 0 #0e6ba84d;
        border-bottom: 8px solid #4fc3f7;
        border-top: 2px solid #b3e5fc;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        z-index: 1;
      }
      #footer button {
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
      }
      #footer button:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #footer p {
        margin-top: 10px;
        color: #555;
      }
      /* 波の装飾 */
      .wave {
        position: absolute;
        left: 0;
        width: 100%;
        height: 120px;
        pointer-events: none;
        z-index: 0;
      }
      .wave.top {
        top: 0;
        transform: rotate(180deg);
      }
      .wave.bottom {
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <h1>釣果記録アプリ</h1>
    <button id="loginBtn">Googleでログイン</button>

    <form id="catchForm">
      <h2
        style="
          text-align: center;
          color: #0288d1;
          text-shadow: 0 2px 8px #b3e5fc;
        "
      >
        釣果入力
      </h2>
      <label>魚の名称：<input type="text" id="fish" /></label><br />
      <label>サイズ(cm)：<input type="number" id="size" /></label><br />
      <label>場所：<input type="text" id="location" /></label><br />
      <label>日付：<input type="date" id="date" /></label><br />
      <input type="file" id="catch-image" accept="image/*" /><br />
      <label>使用したタックル</label><br />
      <label
        >ロッド：<input
          type="text"
          id="rod"
          placeholder="例：シマノ コルトスナイパーS100MH" /></label
      ><br />
      <label
        >リール：<input
          type="text"
          id="reel"
          placeholder="例：シマノ ステラ4000XG" /></label
      ><br />
      <label
        >ライン：<input
          type="text"
          id="line"
          placeholder="例：PE 1.5号" /></label
      ><br />
      <label
        >仕掛け or ルアー等：<input
          type="text"
          id="lure"
          placeholder="例：メジャークラフト ジグパラ40g" /></label
      ><br />
      <label
        >メモ：<input
          type="text"
          id="memo"
          placeholder="例：晴れ、風弱、潮止まり" /></label
      ><br />
      <button type="submit">記録</button>
    </form>
    <footer id="footer">
      <button>釣果一覧へ</button><br />
      <p>&copy; 2025 釣果記録アプリ</p>
    </footer>
    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        updateDoc,
        getDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBk4qQ8E0qDUHcsLXcvjIVtJCAruSUuOwM",
        authDomain: "fishing-log-app-5bea9.firebaseapp.com",
        projectId: "fishing-log-app-5bea9",
        storageBucket: "fishing-log-app-5bea9.firebasestorage.app",
        messagingSenderId: "730868295976",
        appId: "1:730868295976:web:430b3435d68ad122c7c81d",
        measurementId: "G-GT36TCEJPM",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const provider = new GoogleAuthProvider();
      const auth = getAuth();
      //
      const loginBtn = document.getElementById("loginBtn");
      const catchForm = document.getElementById("catchForm");
      const db = getFirestore(app);
      const storage = getStorage(app);
      //ページ読み込み時にログイン状態を確認
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("ログイン中:", user);
          loginBtn.textContent = "ログアウト";
          catchForm.style.display = "block"; // フォームを表示
          // ユーザー情報を users コレクションに保存/更新（upsert）
          (async () => {
            try {
              await setDoc(
                doc(db, "users", user.uid),
                {
                  uid: user.uid,
                  email: user.email || "",
                  displayName: user.displayName || "",
                  photoURL: user.photoURL || "",
                  lastSeen: serverTimestamp(),
                },
                { merge: true }
              );
            } catch (err) {
              console.error("users collection upsert failed:", err);
            }
          })();
          loadMyCatches(user.uid); // ユーザーの釣果を読み込む関数を呼び出し
        } else {
          console.log("ログアウト中");
          loginBtn.textContent = "Googleでログイン";
          catchForm.style.display = "none"; // フォームを非表示
        }
        // ログインボタンのクリックイベント
        loginBtn.addEventListener("click", async () => {
          if (auth.currentUser) {
            // ログアウト処理
            await signOut(auth);
            alert("ログアウトしました");
          } else {
            // ログイン処理
            try {
              const result = await signInWithPopup(auth, provider);
              const user = result.user;
              alert("ログインしました: " + user.displayName);
            } catch (error) {
              console.error("Error during sign-in:", error);
              alert("ログインに失敗しました");
            }
          }
        });
      });
      //釣果を登録するボタンのイベント
      document
        .getElementById("catchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const user = auth.currentUser; // 現在のログインユーザーを取得
          if (!user) {
            alert("ログインしてください");
            return;
          }
          const fish = document.getElementById("fish").value;
          const size = document.getElementById("size").value;
          const location = document.getElementById("location").value;
          const date = document.getElementById("date").value;
          //ファイル未選択時の処理
          const imageFile = document.getElementById("catch-image").files[0];
          if (!imageFile) {
            alert("画像を選択してください");
            return;
          }
          let imageUrl = "";

          if (imageFile) {
            // 画像をFirebase Storageにアップロード
            const storageRef = ref(
              storage,
              `catch-images/${user.uid}/${Date.now()}_${imageFile.name}`
            );
            await uploadBytes(storageRef, imageFile);
            imageUrl = await getDownloadURL(storageRef);
            try {
              await addDoc(collection(db, "fishinglogs"), {
                uid: user.uid,
                catch: {
                  fish: fish,
                  size: size,
                  location: location,
                  date: date,
                  imageUrl: imageUrl,
                  rod: document.getElementById("rod").value,
                  reel: document.getElementById("reel").value,
                  line: document.getElementById("line").value,
                  lure: document.getElementById("lure").value,
                  memo: "", // メモ欄は空で初期化
                },
              });
              alert("釣果が保存されました！");
              // フォームをリセット
              catchForm.reset();
            } catch (error) {
              console.error("Error adding document: ", error);
              alert("釣果の保存に失敗しました");
            }
          }
        });

      // ユーザーの釣果を読み込む関数
      async function loadMyCatches(uid) {
        const querySnapshot = await getDocs(collection(db, "fishinglogs"));
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.uid === uid) {
            console.log("釣果:", data.catch);
            // ここで釣果を画面に表示する処理を追加可能
          }
        });
      }
      // 釣果一覧へボタンで一覧ページへ遷移
      document.querySelector("#footer button").addEventListener("click", () => {
        window.location.href = "fishing-log2.html";
      });
    </script>
  </body>
</html>
