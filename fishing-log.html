<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>釣果記録アプリ</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="stylesheet.css" />
  </head>
  <body>
    <header role="banner" aria-label="サイトヘッダー">
      <div class="container">
        <div class="header-left">
          <a class="logo" href="index.html" aria-label="ホーム">
            <svg
              width="40"
              height="28"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M22 12c0 0-4-2-8-2s-8 2-8 2S2 14 2 18s3 4 7 4 6-2 8-4 5-4 5-6-1-2-1-2z"
                fill="none"
                stroke="currentColor"
                stroke-width="1.2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <circle cx="7" cy="12" r="1" fill="currentColor" />
            </svg>
          </a>
          <h1
            style="margin: 0; font-size: 1.1rem; color: #fff; font-weight: 600"
          >
            釣果記録アプリ
          </h1>
        </div>
        <div
          class="header-right"
          role="navigation"
          aria-label="メインナビゲーション"
        >
          <a href="index.html">ホーム</a>
          <a href="fishing-log2.html">釣果一覧</a>
          <a href="fishing-log.html">登録</a>
          <div class="nav-tools">
            <button
              class="tools-btn"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="tools-submenu"
            >
              ツール ▾
            </button>
            <div
              id="tools-submenu"
              class="submenu"
              role="menu"
              aria-hidden="true"
            >
              <a role="menuitem" href="pe-converter.html">PE変換</a>
              <a role="menuitem" href="pe(tanatoru4)-converter.html"
                >タナトル4</a
              >
              <a role="menuitem" href="index.html">その他</a>
            </div>
          </div>
          <a href="profile.html">プロフィール</a>
        </div>
        <button
          class="menu-icon"
          id="menuIcon"
          aria-label="メニュー"
          aria-expanded="false"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M4 6h16M4 12h16M4 18h16"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
    </header>
    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <div class="container">
      <div class="site-card form-card">
        <form id="catchForm">
          <h2
            style="
              text-align: center;
              color: #0288d1;
              text-shadow: 0 2px 8px #b3e5fc;
            "
          >
            釣果入力
          </h2>

          <div class="form-row">
            <div style="flex: 1">
              <label for="fish">魚の名称</label>
              <input type="text" id="fish" />
            </div>
            <div style="width: 120px">
              <label for="size">サイズ(cm)</label>
              <input type="number" id="size" />
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="location">場所</label>
              <input type="text" id="location" />
            </div>
            <div style="width: 180px">
              <label for="date">日付</label>
              <input type="date" id="date" />
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="catch-image">画像を選択</label>
              <input type="file" id="catch-image" accept="image/*" />
              <img id="preview" class="catch-preview" alt="プレビュー表示" />
            </div>
          </div>

          <h3 style="margin-top: 12px; color: #235b72">使用したタックル</h3>
          <div class="form-row">
            <div style="flex: 1">
              <label for="rod">ロッド</label>
              <input
                type="text"
                id="rod"
                placeholder="例：シマノ コルトスナイパーS100MH"
              />
            </div>
            <div style="flex: 1">
              <label for="reel">リール</label>
              <input
                type="text"
                id="reel"
                placeholder="例：シマノ ステラ4000XG"
              />
            </div>
          </div>
          <div class="form-row">
            <div style="flex: 1">
              <label for="line">ライン</label>
              <input type="text" id="line" placeholder="例：PE 1.5号" />
            </div>
            <div style="flex: 1">
              <label for="lure">仕掛け / ルアー</label>
              <input
                type="text"
                id="lure"
                placeholder="例：メジャークラフト ジグパラ40g"
              />
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="memo">メモ</label>
              <input
                type="text"
                id="memo"
                placeholder="例：晴れ、風弱、潮止まり"
              />
            </div>
          </div>

          <button type="submit" class="btn">記録</button>
        </form>
      </div>
    </div>
    <footer id="footer">
      <button>釣果一覧へ</button><br />
      <button
        id="logoutBtn"
        class="btn secondary"
        style="margin-top: 8px; display: none"
      >
        ログアウト
      </button>
      <p>&copy; 2025 釣果記録アプリ</p>
    </footer>
    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <!-- ホームへ戻るボタン -->
    <button
      id="homeBtn"
      class="home-btn"
      title="ホームへ戻る"
      aria-label="ホームへ戻る"
    >
      <svg
        width="22"
        height="22"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        focusable="false"
      >
        <path
          d="M3 10.5L12 4l9 6.5"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M5 10.5v7a1 1 0 0 0 1 1h3v-5h6v5h3a1 1 0 0 0 1-1v-7"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
    <!-- home button styling moved to stylesheet.css -->
    <script>
      document.getElementById("homeBtn").addEventListener("click", () => {
        window.location.href = "index.html";
      });
    </script>
    <script>
      // image preview for catch image
      (function () {
        const fileInput = document.getElementById("catch-image");
        const preview = document.getElementById("preview");
        if (!fileInput || !preview) return;
        fileInput.addEventListener("change", () => {
          const f = fileInput.files && fileInput.files[0];
          if (!f) {
            preview.src = "";
            preview.style.display = "none";
            return;
          }
          const reader = new FileReader();
          reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(f);
        });
      })();
    </script>
    <script src="scripts/header.js"></script>

    <script type="module">
      // Use centralized initializer module (firebase-init.js) which sets up
      // the Firebase app (v12) and exports auth, db, storage and common helpers.
      import {
        auth,
        db,
        storage,
        analytics,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult,
        onAuthStateChanged,
        signOut,
        configValid,
      } from "./firebase-init.js";

      import {
        collection,
        addDoc,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        updateDoc,
        getDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

      const provider = new GoogleAuthProvider();
      // If firebase-config.js is not filled, show a visible banner and stop.
      if (!configValid) {
        const banner = document.createElement("div");
        banner.style.cssText =
          "position:fixed;left:0;right:0;top:0;background:#ff5252;color:#fff;padding:12px;text-align:center;z-index:99999;font-weight:700;";
        banner.textContent =
          "Firebase 設定が未完です。firebase-config.js を作成して正しい値を入れてください (README を参照)。";
        document.body.appendChild(banner);
        console.error(
          "Firebase config invalid — halting firebase usage on page."
        );
        // stop further initialization
        throw new Error("Firebase config invalid");
      }
      const catchForm = document.getElementById("catchForm");
      //ページ読み込み時にログイン状態を確認
      // If the app returned from a redirect sign-in, process the result first
      (async () => {
        try {
          const redirectResult = await getRedirectResult(auth);
          if (redirectResult && redirectResult.user) {
            console.log("signInWithRedirect result:", redirectResult.user);
          }
        } catch (err) {
          // missing initial state errors may surface here; we'll log and continue
          console.warn(
            "getRedirectResult error (may be missing state in some browsers):",
            err
          );
        }
      })();

      onAuthStateChanged(auth, (user) => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (user) {
          console.log("ログイン中:", user);
          if (logoutBtn) logoutBtn.style.display = "inline-block";
          if (catchForm) catchForm.style.display = "block"; // フォームを表示
          // ユーザー情報を users コレクションに保存/更新（upsert）
          (async () => {
            try {
              await setDoc(
                doc(db, "users", user.uid),
                {
                  uid: user.uid,
                  email: user.email || "",
                  displayName: user.displayName || "",
                  photoURL: user.photoURL || "",
                  lastSeen: serverTimestamp(),
                },
                { merge: true }
              );
            } catch (err) {
              console.error("users collection upsert failed:", err);
            }
          })();
          loadMyCatches(user.uid); // ユーザーの釣果を読み込む関数を呼び出し
        } else {
          console.log("ログアウト中");
          if (logoutBtn) logoutBtn.style.display = "none";
          if (catchForm) catchForm.style.display = "none"; // フォームを非表示
        }
      });

      //釣果を登録するボタンのイベント
      document
        .getElementById("catchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const user = auth.currentUser; // 現在のログインユーザーを取得
          if (!user) {
            alert("ログインしてください");
            return;
          }
          const fish = document.getElementById("fish").value;
          const sizeRaw = document.getElementById("size").value;
          const size = Number(sizeRaw);
          if (Number.isNaN(size) || size < 0 || size > 2000) {
            alert("サイズは0〜2000の数値で入力してください");
            return;
          }
          const location = document.getElementById("location").value;
          const date = document.getElementById("date").value;
          //ファイル未選択時の処理
          const imageFile = document.getElementById("catch-image").files[0];
          if (!imageFile) {
            alert("画像を選択してください");
            return;
          }
          let imageUrl = "";

          if (imageFile) {
            // 画像をFirebase Storageにアップロード
            const storageRef = ref(
              storage,
              `catch-images/${user.uid}/${Date.now()}_${imageFile.name}`
            );
            await uploadBytes(storageRef, imageFile);
            imageUrl = await getDownloadURL(storageRef);
            try {
              await addDoc(collection(db, "fishinglogs"), {
                uid: user.uid,
                catch: {
                  fish: fish,
                  size: size,
                  location: location,
                  date: date,
                  imageUrl: imageUrl,
                  rod: document.getElementById("rod").value,
                  reel: document.getElementById("reel").value,
                  line: document.getElementById("line").value,
                  lure: document.getElementById("lure").value,
                  memo: "", // メモ欄は空で初期化
                },
              });
              alert("釣果が保存されました！");
              // フォームをリセット
              catchForm.reset();
            } catch (error) {
              console.error("Error adding document: ", error);
              alert("釣果の保存に失敗しました");
            }
          }
        });

      // ユーザーの釣果を読み込む関数
      async function loadMyCatches(uid) {
        try {
          // render a minimal list on the registration page for feedback
          const container = document.querySelector(".site-card.form-card");
          const q = query(
            collection(db, "fishinglogs"),
            where("uid", "==", uid)
          );
          const snaps = await getDocs(q);
          const list = document.createElement("div");
          list.style.marginTop = "12px";
          if (snaps.empty) {
            list.innerHTML = "<p>あなたの釣果はまだ登録されていません。</p>";
          } else {
            snaps.forEach((s) => {
              const d = s.data();
              const el = document.createElement("div");
              el.className = "mini-catch";
              el.style.padding = "8px 0";
              el.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="width:72px;height:54px;overflow:hidden;border-radius:8px;background:#eee">${
                d.catch.imageUrl
                  ? `<img src="${d.catch.imageUrl}" style="width:100%;height:100%;object-fit:cover"/>`
                  : ""
              }</div><div><strong style="color:#024f6f">${
                d.catch.fish || ""
              }</strong><div style="color:#666;font-size:0.9rem">${
                d.catch.date || ""
              } — ${d.catch.size || ""} cm</div></div></div>`;
              list.appendChild(el);
            });
          }
          // remove an existing summary if present
          const prev = document.querySelector(".my-catches-summary");
          if (prev) prev.remove();
          list.className = "my-catches-summary";
          container.appendChild(list);
        } catch (err) {
          console.error("loadMyCatches error", err);
        }
      }
      // 釣果一覧へボタンで一覧ページへ遷移
      document.querySelector("#footer button").addEventListener("click", () => {
        window.location.href = "fishing-log2.html";
      });

      // ログアウトボタンの処理
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await signOut(auth);
            alert("ログアウトしました");
          } catch (err) {
            console.error("Sign-out failed:", err);
            alert("ログアウトに失敗しました: " + (err.message || err));
          }
        });
      }
    </script>
  </body>
</html>
