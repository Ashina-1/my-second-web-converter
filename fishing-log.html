<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>é‡£æœè¨˜éŒ² - AbyssAtlas</title>
    <link
      rel="icon"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='abyss' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%231a1413;stop-opacity:1' /><stop offset='50%' style='stop-color:%2316191e;stop-opacity:1' /><stop offset='100%' style='stop-color:%230d0a0a;stop-opacity:1' /></linearGradient><linearGradient id='metalGrad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23ffd700;stop-opacity:0.9' /><stop offset='50%' style='stop-color:%23d4af8c;stop-opacity:1' /><stop offset='100%' style='stop-color:%238b7500;stop-opacity:0.9' /></linearGradient></defs><rect width='100' height='100' fill='url(%23abyss)'/><polygon points='50,20 65,70 50,88 35,70' fill='url(%23metalGrad)' stroke='%23ffd700' stroke-width='1.5'/><polygon points='50,25 60,65 50,80 40,65' fill='none' stroke='%23ffffff' stroke-width='0.8' opacity='0.6'/><path d='M20 50 Q50 40 80 50 Q50 55 20 50' stroke='%238b7500' stroke-width='1.5' fill='none' opacity='0.6'/><path d='M15 60 Q50 50 85 60 Q50 65 15 60' stroke='%238b7500' stroke-width='1' fill='none' opacity='0.4'/></svg>"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="stylesheet-darksoul.css" />
    <script src="scripts/header.js" defer></script>
  </head>
  <body>
    <header role="banner" aria-label="ã‚µã‚¤ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼">
      <div class="container">
        <div class="header-left">
          <a
            class="logo"
            href="index.html"
            aria-label="ãƒ›ãƒ¼ãƒ "
            title="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹"
          >
            <svg
              width="40"
              height="40"
              viewBox="0 0 100 100"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              focusable="false"
            >
              <defs>
                <linearGradient
                  id="abyss-logo"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #1a1413; stop-opacity: 1"
                  />
                  <stop
                    offset="50%"
                    style="stop-color: #16191e; stop-opacity: 1"
                  />
                  <stop
                    offset="100%"
                    style="stop-color: #0d0a0a; stop-opacity: 1"
                  />
                </linearGradient>
                <linearGradient
                  id="metalGrad-logo"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #c4d8f0; stop-opacity: 0.9"
                  />
                  <stop
                    offset="50%"
                    style="stop-color: #8099b8; stop-opacity: 1"
                  />
                  <stop
                    offset="100%"
                    style="stop-color: #506080; stop-opacity: 0.9"
                  />
                </linearGradient>
              </defs>
              <polygon
                points="50,20 65,70 50,88 35,70"
                fill="url(#metalGrad-logo)"
                stroke="#c4d8f0"
                stroke-width="1.5"
              />
              <polygon
                points="50,25 60,65 50,80 40,65"
                fill="none"
                stroke="#ffffff"
                stroke-width="0.8"
                opacity="0.6"
              />
              <path
                d="M20 50 Q50 40 80 50 Q50 55 20 50"
                stroke="#8099b8"
                stroke-width="1.5"
                fill="none"
                opacity="0.6"
              />
            </svg>
          </a>
        </div>
        <div
          class="header-right"
          role="navigation"
          aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³"
        >
          <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
          <a href="fishing-log2.html">é‡£æœä¸€è¦§</a>
          <a href="fishing-log.html">ç™»éŒ²</a>
          <div class="nav-tools">
            <button
              class="tools-btn"
              aria-haspopup="true"
              aria-expanded="false"
              aria-controls="tools-submenu"
            >
              ãƒ„ãƒ¼ãƒ« â–¾
            </button>
            <div
              id="tools-submenu"
              class="submenu"
              role="menu"
              aria-hidden="true"
            >
              <a role="menuitem" href="ocean-checker.html">ğŸŒŠ æµ·æ³ãƒã‚§ãƒƒã‚«ãƒ¼</a>
              <a role="menuitem" href="pe-converter.html">PEå¤‰æ›</a>
              <a role="menuitem" href="index.html">ãã®ä»–</a>
            </div>
          </div>
          <a href="profile.html">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
        </div>
        <button
          class="menu-icon"
          id="menuIcon"
          aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼"
          aria-expanded="false"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M4 6h16M4 12h16M4 18h16"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
    </header>
    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#3a4d6b"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <div class="container">
      <div class="site-card form-card">
        <form id="catchForm">
          <h2>é‡£æœå…¥åŠ›</h2>

          <!-- æµ·æ³ãƒ‡ãƒ¼ã‚¿é€£å‹•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div
            style="
              background: linear-gradient(
                135deg,
                rgba(107, 143, 176, 0.1),
                rgba(77, 184, 255, 0.05)
              );
              border-radius: 2px;
              padding: 12px;
              margin-bottom: 16px;
              border-left: 4px solid #6bb3e8;
            "
          >
            <h3 style="margin: 0 0 12px 0; color: #c4d8f0; font-size: 0.95rem">
              æµ·æ³ãƒ‡ãƒ¼ã‚¿é€£å‹•
            </h3>
            <div style="display: flex; gap: 8px; flex-wrap: wrap">
              <button
                type="button"
                id="quickCapture"
                class="btn"
                style="flex: 1; min-width: 150px; font-size: 0.9rem"
              >
                ğŸ“ ç¾åœ¨åœ°ã‹ã‚‰å³åº§ç™»éŒ²
              </button>
              <button
                type="button"
                id="selectCapture"
                class="btn"
                style="flex: 1; min-width: 150px; font-size: 0.9rem"
              >
                ğŸ¯ åœ°ç‚¹ã¨æ™‚åˆ»ã‚’é¸ã‚“ã§å–å¾—
              </button>
            </div>
            <div
              id="oceanDataDisplay"
              style="
                margin-top: 12px;
                padding: 16px;
                background: linear-gradient(
                  135deg,
                  rgba(15, 20, 35, 0.95),
                  rgba(10, 25, 45, 0.95)
                );
                border: 2px solid #3a4d6b;
                border-radius: 0;
                min-height: 60px;
                display: none;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
              "
            >
              <p
                id="oceanDataText"
                style="
                  margin: 0 0 12px 0;
                  color: #c4d8f0;
                  font-size: 0.9rem;
                  letter-spacing: 1px;
                "
              ></p>
              <div id="tideGraphContainer" style="margin-top: 8px">
                <svg
                  id="tideGraphSvg"
                  style="
                    width: 100%;
                    height: 200px;
                    max-width: 350px;
                    border: 1px solid #3a4d6b;
                    border-radius: 0;
                    background: linear-gradient(
                      135deg,
                      rgba(5, 4, 4, 0.8) 0%,
                      rgba(10, 20, 35, 0.8) 100%
                    );
                  "
                ></svg>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="fish">é­šã®åç§°</label>
              <input type="text" id="fish" />
            </div>
            <div style="width: 120px">
              <label for="size">ã‚µã‚¤ã‚º(cm)</label>
              <input type="number" id="size" />
            </div>
            <div style="width: 120px">
              <label for="weight">ã‚°ãƒ©ãƒ (g)</label>
              <input type="number" id="weight" />
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="locationSelect">é‡£ã‚Šå ´ã‚’é¸æŠ</label>
              <select id="locationSelect">
                <option value="">-- é‡£ã‚Šå ´ã‚’é¸æŠ --</option>
              </select>
            </div>
            <button
              type="button"
              id="fetchOceanDataBtn"
              style="
                align-self: flex-end;
                margin-bottom: 8px;
                padding: 8px 16px;
                background: #235b72;
                color: #c4d8f0;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              æµ·æ³å–å¾—
            </button>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="location">å ´æ‰€ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</label>
              <input type="text" id="location" />
            </div>
            <div style="width: 180px">
              <label for="date">æ—¥ä»˜</label>
              <input type="date" id="date" />
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="catch-image">ç”»åƒã‚’é¸æŠ</label>
              <input type="file" id="catch-image" accept="image/*" />
              <img id="preview" class="catch-preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º" />
            </div>
          </div>

          <h3 style="margin-top: 12px; color: #235b72">ä½¿ç”¨ã—ãŸã‚¿ãƒƒã‚¯ãƒ«</h3>
          <div class="form-row">
            <div style="flex: 1">
              <label for="rod">ãƒ­ãƒƒãƒ‰</label>
              <input
                type="text"
                id="rod"
                placeholder="ä¾‹ï¼šã‚·ãƒãƒ ã‚³ãƒ«ãƒˆã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼S100MH"
              />
            </div>
            <div style="flex: 1">
              <label for="reel">ãƒªãƒ¼ãƒ«</label>
              <input
                type="text"
                id="reel"
                placeholder="ä¾‹ï¼šã‚·ãƒãƒ ã‚¹ãƒ†ãƒ©4000XG"
              />
            </div>
          </div>
          <div class="form-row">
            <div style="flex: 1">
              <label for="line">ãƒ©ã‚¤ãƒ³</label>
              <input type="text" id="line" placeholder="ä¾‹ï¼šPE 1.5å·" />
            </div>
            <div style="flex: 1">
              <label for="lure">ä»•æ›ã‘ / ãƒ«ã‚¢ãƒ¼</label>
              <input
                type="text"
                id="lure"
                placeholder="ä¾‹ï¼šãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¯ãƒ©ãƒ•ãƒˆ ã‚¸ã‚°ãƒ‘ãƒ©40g"
              />
            </div>
          </div>

          <div class="form-row">
            <div style="flex: 1">
              <label for="memo">ãƒ¡ãƒ¢</label>
              <input
                type="text"
                id="memo"
                placeholder="ä¾‹ï¼šæ™´ã‚Œã€é¢¨å¼±ã€æ½®æ­¢ã¾ã‚Š"
              />
            </div>
          </div>

          <!-- Googleãƒãƒƒãƒ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <h3 style="margin-top: 1rem; color: #235b72">åœ°å›³ã‹ã‚‰åœ°ç‚¹ã‚’é¸æŠ</h3>
          <div class="map-info">
            ğŸ’¡
            ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç‚¹ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®åœ°ç‚¹ã®æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ã—ã¾ã™
          </div>
          <div id="oceanMapContainer"></div>

          <button type="submit" class="btn">è¨˜éŒ²</button>
        </form>
      </div>
    </div>
    <footer id="footer">
      <button>é‡£æœä¸€è¦§ã¸</button><br />
      <button
        id="logoutBtn"
        class="btn secondary"
        style="margin-top: 8px; display: none"
      >
        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>
      <p>&copy; 2025 AbyssAtlas</p>
    </footer>
    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#3a4d6b"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>

    <!-- home button styling moved to stylesheet.css -->
    <script>
      const homeBtn = document.getElementById("homeBtn");
      if (homeBtn) {
        homeBtn.addEventListener("click", () => {
          window.location.href = "index.html";
        });
      }
    </script>
    <script>
      // image preview for catch image
      (function () {
        const fileInput = document.getElementById("catch-image");
        const preview = document.getElementById("preview");
        if (!fileInput || !preview) return;
        fileInput.addEventListener("change", () => {
          const f = fileInput.files && fileInput.files[0];
          if (!f) {
            preview.src = "";
            preview.style.display = "none";
            return;
          }
          const reader = new FileReader();
          reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(f);
        });
      })();
    </script>

    <script type="module">
      // Use centralized initializer module (firebase-init.js) which sets up
      // the Firebase app (v12) and exports auth, db, storage and common helpers.
      import {
        auth,
        db,
        storage,
        analytics,
        GoogleAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult,
        onAuthStateChanged,
        signOut,
        configValid,
      } from "./firebase-init.js";

      import {
        collection,
        addDoc,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        updateDoc,
        getDoc,
        query,
        where,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

      const provider = new GoogleAuthProvider();
      // If firebase-config.js is not filled, show a visible banner and stop.
      if (!configValid) {
        const banner = document.createElement("div");
        banner.style.cssText =
          "position:fixed;left:0;right:0;top:0;background:#ff5252;color:#fff;padding:12px;text-align:center;z-index:99999;font-weight:700;";
        banner.textContent =
          "Firebase è¨­å®šãŒæœªå®Œã§ã™ã€‚firebase-config.js ã‚’ä½œæˆã—ã¦æ­£ã—ã„å€¤ã‚’å…¥ã‚Œã¦ãã ã•ã„ (README ã‚’å‚ç…§)ã€‚";
        document.body.appendChild(banner);
        console.error(
          "Firebase config invalid â€” halting firebase usage on page.",
        );
        // stop further initialization
        throw new Error("Firebase config invalid");
      }
      const catchForm = document.getElementById("catchForm");
      //ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
      // If the app returned from a redirect sign-in, process the result first
      (async () => {
        try {
          const redirectResult = await getRedirectResult(auth);
          if (redirectResult && redirectResult.user) {
            console.log("signInWithRedirect result:", redirectResult.user);
          }
        } catch (err) {
          // missing initial state errors may surface here; we'll log and continue
          console.warn(
            "getRedirectResult error (may be missing state in some browsers):",
            err,
          );
        }
      })();

      onAuthStateChanged(auth, (user) => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (user) {
          console.log("ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", user);
          if (logoutBtn) logoutBtn.style.display = "inline-block";
          if (catchForm) catchForm.style.display = "block"; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜/æ›´æ–°ï¼ˆupsertï¼‰
          (async () => {
            try {
              await setDoc(
                doc(db, "users", user.uid),
                {
                  uid: user.uid,
                  email: user.email || "",
                  displayName: user.displayName || "",
                  photoURL: user.photoURL || "",
                  lastSeen: serverTimestamp(),
                },
                { merge: true },
              );
            } catch (err) {
              console.error("users collection upsert failed:", err);
            }
          })();
          loadMyCatches(user.uid); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡£æœã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        } else {
          console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­");
          if (logoutBtn) logoutBtn.style.display = "none";
          if (catchForm) catchForm.style.display = "none"; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
        }
      });

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šæµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
      let currentOceanData = null;

      //é‡£æœã‚’ç™»éŒ²ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById("catchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const user = auth.currentUser; // ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
          if (!user) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            return;
          }
          const fish = document.getElementById("fish").value;
          const sizeRaw = document.getElementById("size").value;
          const size = Number(sizeRaw);
          if (Number.isNaN(size) || size < 0 || size > 2000) {
            alert("ã‚µã‚¤ã‚ºã¯0ã€œ2000ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          const location = document.getElementById("location").value;
          const date = document.getElementById("date").value;
          //ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠæ™‚ã®å‡¦ç†
          const imageFile = document.getElementById("catch-image").files[0];
          if (!imageFile) {
            alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
          }
          let imageUrl = "";

          if (imageFile) {
            // ç”»åƒã‚’Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const storageRef = ref(
              storage,
              `catch-images/${user.uid}/${Date.now()}_${imageFile.name}`,
            );
            try {
              console.log("Uploading image:", {
                fileName: imageFile.name,
                fileSize: imageFile.size,
                fileType: imageFile.type,
                uid: user.uid,
              });
              const metadata = {
                contentType: imageFile.type || "image/jpeg",
                customMetadata: {
                  uploadedBy: user.uid,
                  uploadedAt: new Date().toISOString(),
                },
              };
              await uploadBytes(storageRef, imageFile, metadata);
              imageUrl = await getDownloadURL(storageRef);
              console.log("Image uploaded successfully:", imageUrl);
            } catch (uploadErr) {
              console.error("Storage upload error:", uploadErr);
              console.error("Error code:", uploadErr.code);
              console.error("Error message:", uploadErr.message);
              console.error("Full error:", JSON.stringify(uploadErr, null, 2));
              alert(
                "ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: " +
                  uploadErr.code +
                  "\nè©³ç´°: " +
                  uploadErr.message +
                  "\n\nFirebase Console ã® Storage â†’ Rules ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
              );
              return;
            }
            try {
              const memoValue = document.getElementById("memo").value;
              const catchData = {
                fish: fish,
                size: size,
                weight: document.getElementById("weight").value || "",
                location: location,
                date: date,
                imageUrl: imageUrl,
                rod: document.getElementById("rod").value,
                reel: document.getElementById("reel").value,
                line: document.getElementById("line").value,
                lure: document.getElementById("lure").value,
                memo: memoValue,
              };

              console.log("Saving catch data:", catchData);
              console.log(
                "All keys present:",
                [
                  "fish",
                  "size",
                  "location",
                  "date",
                  "imageUrl",
                  "rod",
                  "reel",
                  "line",
                  "lure",
                  "memo",
                ].every((k) => k in catchData),
              );

              // æµ·æ³ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã¦ã„ã‚Œã°ä¿å­˜
              if (currentOceanData) {
                catchData.oceanData = currentOceanData;
              }

              const docRef = await addDoc(collection(db, "fishinglogs"), {
                uid: user.uid,
                catch: catchData,
              });
              console.log("Document saved successfully with ID:", docRef.id);
              alert("é‡£æœãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
              // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
              catchForm.reset();
              currentOceanData = null; // æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆ
            } catch (error) {
              console.error("Error adding document: ", error);
              console.error("Error code:", error.code);
              console.error("Error message:", error.message);
              alert("é‡£æœã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
          }
        });

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡£æœã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      async function loadMyCatches(uid) {
        try {
          // render a minimal list on the registration page for feedback
          const container = document.querySelector(".site-card.form-card");
          const q = query(
            collection(db, "fishinglogs"),
            where("uid", "==", uid),
          );
          const snaps = await getDocs(q);
          const list = document.createElement("div");
          list.style.marginTop = "12px";
          if (snaps.empty) {
            list.innerHTML = "<p>ã‚ãªãŸã®é‡£æœã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
          } else {
            snaps.forEach((s) => {
              const d = s.data();
              const el = document.createElement("div");
              el.className = "mini-catch";
              el.style.padding = "8px 0";
              el.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="width:72px;height:54px;overflow:hidden;border-radius:8px;background:#eee">${
                d.catch.imageUrl
                  ? `<img src="${d.catch.imageUrl}" style="width:100%;height:100%;object-fit:cover"/>`
                  : ""
              }</div><div><strong style="color:#024f6f">${
                d.catch.fish || ""
              }</strong><div style="color:#666;font-size:0.9rem">${
                d.catch.date || ""
              } â€” ${d.catch.size || ""} cm</div></div></div>`;
              list.appendChild(el);
            });
          }
          // remove an existing summary if present
          const prev = document.querySelector(".my-catches-summary");
          if (prev) prev.remove();
          list.className = "my-catches-summary";
          container.appendChild(list);
        } catch (err) {
          console.error("loadMyCatches error", err);
        }
      }
      // é‡£æœä¸€è¦§ã¸ãƒœã‚¿ãƒ³ã§ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸é·ç§»
      document.querySelector("#footer button").addEventListener("click", () => {
        window.location.href = "fishing-log2.html";
      });

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await signOut(auth);
            alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
          } catch (err) {
            console.error("Sign-out failed:", err);
            alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.message || err));
          }
        });
      }

      // ================== æµ·æ³ãƒ‡ãƒ¼ã‚¿é€£å‹•æ©Ÿèƒ½ ==================

      // é‡£ã‚Šå ´ãƒ‡ãƒ¼ã‚¿ï¼ˆindex.htmlã‹ã‚‰æŠ½å‡ºï¼‰
      const fishingLocations = [
        // ç¥æˆ¸ã€œæ˜çŸ³
        { name: "å‚æ°´", lat: 34.73, lon: 135.03 },
        { name: "æ˜çŸ³æ¸¯", lat: 34.67, lon: 135.1 },
        { name: "æ±Ÿå´", lat: 34.69, lon: 135.14 },
        { name: "é­šä½", lat: 34.66, lon: 135.21 },
        { name: "å²©å±‹", lat: 34.78, lon: 135.35 },
        // å¤§é˜ªæ¹¾
        { name: "æ³‰å—", lat: 34.38, lon: 135.36 },
        { name: "ç”°å°»", lat: 34.33, lon: 135.37 },
        { name: "æ³‰ä½é‡", lat: 34.37, lon: 135.41 },
        { name: "å‹ãƒ¶å³¶", lat: 34.26, lon: 135.44 },
        // å’Œæ­Œå±±
        { name: "åŠ å¤ª", lat: 34.21, lon: 135.36 },
        { name: "ç”±è‰¯", lat: 33.72, lon: 135.15 },
        { name: "ç™½æµœ", lat: 33.68, lon: 135.36 },
        { name: "ã™ã•ã¿", lat: 33.6, lon: 135.55 },
        { name: "ä¸²æœ¬", lat: 33.48, lon: 135.76 },
        // ä¸‰é‡
        { name: "å°¾é·²", lat: 34.06, lon: 136.23 },
        { name: "ç†Šé‡", lat: 33.9, lon: 136.24 },
        { name: "é³¥ç¾½", lat: 34.48, lon: 136.83 },
        { name: "å¿—æ‘©", lat: 34.31, lon: 136.82 },
        // äº¬ä¸¹å¾Œã€œç¦äº•
        { name: "é–“äºº", lat: 35.67, lon: 135.14 },
        { name: "ä¼Šæ ¹", lat: 35.68, lon: 135.31 },
        { name: "èˆé¶´", lat: 35.48, lon: 135.37 },
        { name: "å°æµœ", lat: 35.53, lon: 135.76 },
      ];

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
      function initLocationSelect() {
        const select = document.getElementById("locationSelect");
        fishingLocations.forEach((loc) => {
          const option = document.createElement("option");
          option.value = JSON.stringify({ lat: loc.lat, lon: loc.lon });
          option.textContent = loc.name;
          select.appendChild(option);
        });
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
      initLocationSelect();

      // åœ°ç‚¹é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById("locationSelect")
        .addEventListener("change", (e) => {
          if (e.target.value) {
            const loc = JSON.parse(e.target.value);
            const selectedName = fishingLocations.find(
              (l) => l.lat === loc.lat && l.lon === loc.lon,
            ).name;
            document.getElementById("location").value = selectedName;
          }
        });

      // æµ·æ³å–å¾—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById("fetchOceanDataBtn")
        .addEventListener("click", async () => {
          const selectValue = document.getElementById("locationSelect").value;
          if (!selectValue) {
            alert("é‡£ã‚Šå ´ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
          }

          const loc = JSON.parse(selectValue);
          const dateInput = document.getElementById("date").value;
          if (!dateInput) {
            alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }

          try {
            const [year, month, day] = dateInput.split("-");
            const dateStr = `${year}-${month}-${day}`;
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(
              2,
              "0",
            )}:${String(now.getMinutes()).padStart(2, "0")}`;

            console.log(
              `Fetching ocean data for: ${loc.lat}, ${loc.lon} on ${dateStr}`,
            );
            await fetchAndDisplayOceanData(loc.lat, loc.lon, dateStr, timeStr);
          } catch (err) {
            console.error("Error fetching ocean data:", err);
            alert("æµ·æ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
          }
        });

      // ç¾åœ¨åœ°ã‹ã‚‰æœ€ã‚‚è¿‘ã„é‡£ã‚Šå ´ã‚’æ¢ã™
      function findNearestLocation(lat, lon) {
        let nearest = fishingLocations[0];
        let minDist = Infinity;

        for (const loc of fishingLocations) {
          const dlat = loc.lat - lat;
          const dlon = loc.lon - lon;
          const dist = Math.sqrt(dlat * dlat + dlon * dlon);
          if (dist < minDist) {
            minDist = dist;
            nearest = loc;
          }
        }
        return nearest;
      }

      // æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      async function fetchAndDisplayOceanData(lat, lon, dateStr, timeStr) {
        const display = document.getElementById("oceanDataDisplay");
        const displayText = document.getElementById("oceanDataText");

        try {
          display.style.display = "block";
          displayText.textContent = "èª­ã¿è¾¼ã¿ä¸­...";

          // Open-Meteo Weather APIã‹ã‚‰æ°—è±¡ãƒ‡ãƒ¼ã‚¿å–å¾—
          const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,pressure_msl,cloud_cover&timezone=Asia/Tokyo`;
          const weatherRes = await fetch(weatherUrl);
          const weatherData = await weatherRes.json();

          // Open-Meteo Marine APIã‹ã‚‰æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæ½®ä½ã€æ³¢é«˜ã€æ°´æ¸©ã‚’å«ã‚€ï¼‰
          const marineUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=sea_level_height_msl,wave_height,wave_period&current=sea_surface_temperature&start_date=${dateStr}&end_date=${dateStr}&timezone=UTC`;
          const marineRes = await fetch(marineUrl);
          const marineData = await marineRes.json();

          // ç¾åœ¨æ™‚åˆ»ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
          const current = weatherData.current;
          const temp = current.temperature_2m;
          const wind = current.wind_speed_10m;
          const windDir = current.wind_direction_10m;
          const pressure = current.pressure_msl;
          const cloud = current.cloud_cover;
          const waterTemp = marineData.current?.sea_surface_temperature || "-";

          // æ½®ä½ã€æ³¢é«˜ã‚’å–å¾—ï¼ˆæŒ‡å®šæ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„ãƒ‡ãƒ¼ã‚¿ï¼‰
          let tideHeight = "-";
          let waveHeight = "-";
          let wavePeriod = "-";
          let tideHeightNum = 0;

          if (marineData.hourly && marineData.hourly.time) {
            const times = marineData.hourly.time;
            const heights = marineData.hourly.sea_level_height_msl;
            const waves = marineData.hourly.wave_height;
            const periods = marineData.hourly.wave_period;

            // æŒ‡å®šæ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
            const [hour, min] = timeStr.split(":");
            const targetMs = new Date(`${dateStr}T${timeStr}:00Z`).getTime();
            let closestIdx = 0;
            let minDiff = Infinity;

            for (let i = 0; i < times.length; i++) {
              const diff = Math.abs(new Date(times[i]).getTime() - targetMs);
              if (diff < minDiff) {
                minDiff = diff;
                closestIdx = i;
              }
            }

            tideHeightNum = heights[closestIdx] || 0;
            tideHeight = heights[closestIdx]
              ? (heights[closestIdx] * 100).toFixed(0) + " cm"
              : "-";
            waveHeight = waves[closestIdx]
              ? waves[closestIdx].toFixed(1) + " m"
              : "-";
            wavePeriod = periods[closestIdx]
              ? periods[closestIdx].toFixed(1) + " s"
              : "-";
          }

          // æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
          currentOceanData = {
            date: dateStr,
            time: timeStr,
            location: { lat, lon },
            temperature: temp,
            windSpeed: wind,
            windDirection: windDir,
            pressure: pressure,
            cloudCover: cloud,
            waterTemperature: waterTemp,
            tideHeight: tideHeightNum,
            waveHeight: waveHeight.replace(" m", ""),
            wavePeriod: wavePeriod.replace(" s", ""),
          };

          // ãƒ¡ãƒ¢æ¬„ã«æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
          const memoField = document.getElementById("memo");
          const oceanInfo = `æ°—æ¸©:${temp}Â°C æ°´æ¸©:${waterTemp}Â°C é¢¨:${wind}m/s(${getWindDirStr(
            windDir,
          )}) æ°—åœ§:${pressure}hPa æ½®ä½:${tideHeight} æ³¢:${waveHeight} å‘¨æœŸ:${wavePeriod}`;
          memoField.value =
            (memoField.value ? memoField.value + " / " : "") + oceanInfo;

          // è¡¨ç¤ºã‚’æ›´æ–°
          displayText.innerHTML = `
            <strong>å–å¾—æ¸ˆã¿æµ·æ³ãƒ‡ãƒ¼ã‚¿ (${dateStr} ${timeStr}):</strong><br>
            æ°—æ¸©: ${temp}Â°C | æ°´æ¸©: ${waterTemp}Â°C | é¢¨é€Ÿ: ${wind}m/s (${getWindDirStr(
              windDir,
            )}) | æ°—åœ§: ${pressure}hPa<br>
            æ½®ä½: ${tideHeight} | æ³¢é«˜: ${waveHeight} | å‘¨æœŸ: ${wavePeriod}
          `;

          // æ½®ä½ã‚°ãƒ©ãƒ•ã‚’æç”»
          await drawTideGraphForLocation(lat, lon, dateStr, timeStr);
        } catch (err) {
          console.error("Ocean data fetch error:", err);
          displayText.textContent =
            "æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message;
        }
      }

      // æ½®ä½ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
      async function drawTideGraphForLocation(lat, lon, dateStr, timeStr) {
        const svg = document.getElementById("tideGraphSvg");

        if (!svg) {
          console.error("SVGè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          return;
        }

        try {
          // Open-Meteo Marine API ã‹ã‚‰1æ—¥é–“ã®æ½®ä½ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const api = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=sea_level_height_msl&timezone=Asia/Tokyo&forecast_days=1`;

          console.log("æ½®ä½ã‚°ãƒ©ãƒ•APIã‚’å‘¼ã³å‡ºã—:", api);
          const response = await fetch(api);
          if (!response.ok) throw new Error("æ½®ä½ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼");

          const json = await response.json();
          const tideData = json.hourly.sea_level_height_msl;

          console.log("æ½®ä½ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:", tideData.length, "ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ");

          if (!tideData || tideData.length === 0) {
            console.warn("æ½®ä½ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");
            return;
          }

          // ã‚°ãƒ©ãƒ•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
          const width = 340;
          const height = 160;
          const padding = { top: 30, right: 15, bottom: 25, left: 35 };
          const graphWidth = width - padding.left - padding.right;
          const graphHeight = height - padding.top - padding.bottom;

          // æ½®ä½ã®æœ€å¤§ãƒ»æœ€å°ã‚’è¨ˆç®—
          const minTide = Math.min(...tideData);
          const maxTide = Math.max(...tideData);
          const rangeTide = maxTide - minTide || 1;

          console.log(`æ½®ä½ç¯„å›²: ${minTide}m - ${maxTide}m`);

          // SVGåˆæœŸåŒ–
          svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
          svg.innerHTML = "";

          // èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰
          const gridGroup = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "g",
          );
          gridGroup.setAttribute("stroke", "#6b5d3f");
          gridGroup.setAttribute("stroke-width", "0.5");

          for (let i = 0; i <= 4; i++) {
            const y = padding.top + (graphHeight / 4) * i;
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line",
            );
            line.setAttribute("x1", padding.left);
            line.setAttribute("x2", width - padding.right);
            line.setAttribute("y1", y);
            line.setAttribute("y2", y);
            gridGroup.appendChild(line);
          }
          svg.appendChild(gridGroup);

          // æ½®ä½æ›²ç·šã‚’æç”»
          let pathData = `M ${padding.left} ${padding.top + graphHeight}`;
          for (let i = 0; i < tideData.length; i++) {
            const x = padding.left + (graphWidth / (tideData.length - 1)) * i;
            const normalizedHeight = (tideData[i] - minTide) / rangeTide;
            const y =
              padding.top + graphHeight - normalizedHeight * graphHeight;
            pathData += ` L ${x} ${y}`;
          }

          const path = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "path",
          );
          path.setAttribute("d", pathData);
          path.setAttribute("fill", "none");
          path.setAttribute("stroke", "#d4af8c");
          path.setAttribute("stroke-width", "2");
          svg.appendChild(path);

          // ç™»éŒ²æ™‚åˆ»ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”»
          if (dateStr && timeStr) {
            // APIã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç›´æ¥ãƒ‘ãƒ¼ã‚¹ã—ã¦æ™‚åˆ»ã‚’æŠ½å‡º
            const apiStartStr = json.hourly.time[0]; // "2025-12-13T00:00"å½¢å¼
            const apiStartMatch = apiStartStr.match(/T(\d{2}):(\d{2})/);
            const apiStartHour = parseInt(apiStartMatch[1], 10);
            const apiStartMinute = parseInt(apiStartMatch[2], 10);
            const apiStartHours = apiStartHour + apiStartMinute / 60;

            // ç™»éŒ²æ™‚åˆ»ã‚’æ™‚é–“å€¤ã«å¤‰æ›
            const [hourStr, minuteStr] = timeStr.split(":");
            const captureHours =
              parseInt(hourStr, 10) + parseInt(minuteStr, 10) / 60;

            // æ™‚é–“å·®ã‚’è¨ˆç®—
            let hoursDiff = captureHours - apiStartHours;
            if (hoursDiff < 0) {
              hoursDiff += 24;
            }

            console.log(
              "ãƒãƒ¼ã‚«ãƒ¼è¨ˆç®— - ç™»éŒ²æ™‚åˆ»:",
              timeStr,
              "| APIé–‹å§‹:",
              apiStartStr,
              "| è¨ˆç®—æ™‚é–“å·®:",
              hoursDiff,
              "| ãƒ‡ãƒ¼ã‚¿é•·:",
              tideData.length,
            );

            if (hoursDiff >= 0 && hoursDiff < tideData.length) {
              const idx = Math.round(hoursDiff);
              console.log("ãƒãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:", idx, "Xä½ç½®è¨ˆç®—...");
              if (idx >= 0 && idx < tideData.length) {
                const x =
                  padding.left + (graphWidth / (tideData.length - 1)) * idx;
                const normalizedHeight = (tideData[idx] - minTide) / rangeTide;
                const y =
                  padding.top + graphHeight - normalizedHeight * graphHeight;

                const circle = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "circle",
                );
                circle.setAttribute("cx", x);
                circle.setAttribute("cy", y);
                circle.setAttribute("r", "4");
                circle.setAttribute("fill", "#ff6f00");
                circle.setAttribute("stroke", "#fff");
                circle.setAttribute("stroke-width", "2");
                svg.appendChild(circle);

                // æ™‚åˆ»ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                const timeLabel = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "text",
                );
                timeLabel.setAttribute("x", x);
                timeLabel.setAttribute("y", y - 10);
                timeLabel.setAttribute("font-size", "10");
                timeLabel.setAttribute("fill", "#ff6f00");
                timeLabel.setAttribute("font-weight", "bold");
                timeLabel.setAttribute("text-anchor", "middle");
                timeLabel.textContent = timeStr;
                svg.appendChild(timeLabel);
              }
            }
          }

          // Yè»¸ãƒ©ãƒ™ãƒ«
          const minLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          minLabel.setAttribute("x", "2");
          minLabel.setAttribute("y", padding.top + graphHeight + 4);
          minLabel.setAttribute("font-size", "10");
          minLabel.setAttribute("fill", "#a89560");
          minLabel.setAttribute("text-anchor", "start");
          minLabel.textContent = `${minTide.toFixed(1)}m`;
          svg.appendChild(minLabel);

          const maxLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          maxLabel.setAttribute("x", "2");
          maxLabel.setAttribute("y", padding.top + 12);
          maxLabel.setAttribute("font-size", "10");
          maxLabel.setAttribute("fill", "#a89560");
          maxLabel.setAttribute("text-anchor", "start");
          maxLabel.textContent = `${maxTide.toFixed(1)}m`;
          svg.appendChild(maxLabel);

          // Xè»¸ãƒ©ãƒ™ãƒ«ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ï¼‰
          const startLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          startLabel.setAttribute("x", padding.left);
          startLabel.setAttribute("y", height - 8);
          startLabel.setAttribute("font-size", "11");
          startLabel.setAttribute("fill", "#a89560");
          startLabel.setAttribute("text-anchor", "middle");
          startLabel.textContent = "0h";
          svg.appendChild(startLabel);

          const endLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          endLabel.setAttribute("x", width - padding.right);
          endLabel.setAttribute("y", height - 8);
          endLabel.setAttribute("font-size", "11");
          endLabel.setAttribute("fill", "#a89560");
          endLabel.setAttribute("text-anchor", "middle");
          endLabel.textContent = "24h";
          svg.appendChild(endLabel);

          console.log("æ½®ä½ã‚°ãƒ©ãƒ•æç”»å®Œäº†");
        } catch (error) {
          console.error("æ½®ä½ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒ©ãƒ¼:", error);
        }
      }

      // é¢¨å‘ã‚’æ—¥æœ¬èªã«å¤‰æ›
      function getWindDirStr(degree) {
        const dirs = [
          "åŒ—",
          "åŒ—åŒ—æ±",
          "åŒ—æ±",
          "æ±åŒ—æ±",
          "æ±",
          "æ±å—æ±",
          "å—æ±",
          "å—å—æ±",
          "å—",
          "å—å—è¥¿",
          "å—è¥¿",
          "è¥¿å—è¥¿",
          "è¥¿",
          "è¥¿åŒ—è¥¿",
          "åŒ—è¥¿",
          "åŒ—åŒ—è¥¿",
        ];
        const idx = Math.round(degree / 22.5) % 16;
        return dirs[idx] || "ä¸å®š";
      }

      // ç¾åœ¨åœ°ã‹ã‚‰å³åº§ç™»éŒ²
      document
        .getElementById("quickCapture")
        .addEventListener("click", async (e) => {
          e.preventDefault();

          if (!navigator.geolocation) {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±å–å¾—ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            return;
          }

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;

              // æœ€ã‚‚è¿‘ã„é‡£ã‚Šå ´ã‚’ç‰¹å®š
              const nearestLoc = findNearestLocation(lat, lon);
              document.getElementById("location").value = nearestLoc.name;

              // ç¾åœ¨æ™‚åˆ»ã‚’å…¥åŠ›
              const now = new Date();
              const dateStr = now.toISOString().split("T")[0];
              const timeStr = `${String(now.getHours()).padStart(
                2,
                "0",
              )}:${String(now.getMinutes()).padStart(2, "0")}`;

              document.getElementById("date").value = dateStr;

              // æµ·æ³ãƒ‡ãƒ¼ã‚¿å–å¾—
              await fetchAndDisplayOceanData(
                nearestLoc.lat,
                nearestLoc.lon,
                dateStr,
                timeStr,
              );
            },
            (error) => {
              alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            },
          );
        });

      // åœ°ç‚¹ã¨æ™‚åˆ»ã‚’é¸ã‚“ã§å–å¾—
      document
        .getElementById("selectCapture")
        .addEventListener("click", (e) => {
          e.preventDefault();

          // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
          const modal = document.createElement("div");
          modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
          z-index: 9999;
        `;

          const content = document.createElement("div");
          content.style.cssText = `
          background: linear-gradient(135deg, rgba(15, 20, 35, 0.95), rgba(10, 25, 45, 0.95));
          padding: 24px; border-radius: 2px; max-width: 400px;
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8);
          border: 2px solid #3a4d6b;
        `;

          content.innerHTML = `
          <h3 style="margin-top: 0; color: #c4d8f0;">æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</h3>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; color: #a89560; font-weight: 500;">é‡£ã‚Šå ´:</label>
            <select id="modalLocation" style="width: 100%; padding: 8px; border: 1px solid #506080; border-radius: 2px; background: rgba(5, 4, 4, 0.6); color: #c4d8f0;">
              ${fishingLocations
                .map(
                  (loc) =>
                    `<option value="${loc.lat},${loc.lon}">${loc.name}</option>`,
                )
                .join("")}
            </select>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; color: #a89560; font-weight: 500;">æ—¥ä»˜:</label>
            <input type="date" id="modalDate" style="width: 100%; padding: 8px; border: 1px solid #506080; border-radius: 2px; background: rgba(5, 4, 4, 0.6); color: #c4d8f0;">
          </div>
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; color: #a89560; font-weight: 500;">æ™‚åˆ» (HH:MM):</label>
            <input type="time" id="modalTime" style="width: 100%; padding: 8px; border: 1px solid #506080; border-radius: 2px; background: rgba(5, 4, 4, 0.6); color: #c4d8f0;">
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="modalSubmit" class="btn" style="flex: 1;">å–å¾—</button>
            <button id="modalCancel" class="btn secondary" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        `;

          modal.appendChild(content);
          document.body.appendChild(modal);

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
          const now = new Date();
          document.getElementById("modalDate").value = now
            .toISOString()
            .split("T")[0];
          document.getElementById("modalTime").value = `${String(
            now.getHours(),
          ).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

          // å–å¾—ãƒœã‚¿ãƒ³
          document
            .getElementById("modalSubmit")
            .addEventListener("click", async () => {
              const locValue = document.getElementById("modalLocation").value;
              const dateStr = document.getElementById("modalDate").value;
              const timeStr = document.getElementById("modalTime").value;

              if (!locValue || !dateStr || !timeStr) {
                alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
              }

              const [lat, lon] = locValue.split(",").map(Number);
              const locationName =
                fishingLocations.find((l) => l.lat === lat && l.lon === lon)
                  ?.name || "";

              document.getElementById("location").value = locationName;
              document.getElementById("date").value = dateStr;

              await fetchAndDisplayOceanData(lat, lon, dateStr, timeStr);

              modal.remove();
            });

          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
          document
            .getElementById("modalCancel")
            .addEventListener("click", () => {
              modal.remove();
            });
        });

      // ================== Googleãƒãƒƒãƒ—çµ±åˆ ==================

      let googleMap = null;
      let mapMarker = null;

      // Googleãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
      async function initGoogleMap() {
        try {
          const response = await fetch("/api/google-maps-key");
          if (!response.ok) {
            console.warn(
              "Google Maps API key not available, map functionality disabled",
            );
            return;
          }
          const { apiKey } = await response.json();

          return new Promise((resolve) => {
            window.initGoogleMapsCallback = () => {
              const container = document.getElementById("oceanMapContainer");
              googleMap = new google.maps.Map(container, {
                zoom: 10,
                center: { lat: 34.73, lng: 135.03 }, // å‚æ°´ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¸­å¿ƒ
                mapTypeId: "roadmap",
                styles: [
                  { elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
                  {
                    elementType: "labels.text.stroke",
                    stylers: [{ color: "#1a1a1a" }],
                  },
                  {
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#8099b8" }],
                  },
                  {
                    featureType: "water",
                    elementType: "geometry",
                    stylers: [{ color: "#0b1b2f" }],
                  },
                  {
                    featureType: "road",
                    elementType: "geometry",
                    stylers: [{ color: "#2a3a4a" }],
                  },
                ],
              });

              // ã‚¯ãƒªãƒƒã‚¯ã§åœ°ç‚¹ã‚’é¸æŠ
              googleMap.addListener("click", async (event) => {
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();

                // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­ç½®
                if (mapMarker) {
                  mapMarker.setMap(null);
                }
                mapMarker = new google.maps.Marker({
                  position: { lat, lng },
                  map: googleMap,
                  title: `${lat.toFixed(3)}, ${lng.toFixed(3)}`,
                });

                // ç·¯åº¦çµŒåº¦ã‚’è¡¨ç¤º
                const nearestLoc = findNearestLocation(lat, lng);
                document.getElementById("location").value =
                  `${nearestLoc.name} (${lat.toFixed(3)}, ${lng.toFixed(3)})`;

                // ç¾åœ¨æ—¥æ™‚ã‚’å…¥åŠ›
                const now = new Date();
                const dateStr = now.toISOString().split("T")[0];
                const timeStr = `${String(now.getHours()).padStart(
                  2,
                  "0",
                )}:${String(now.getMinutes()).padStart(2, "0")}`;
                document.getElementById("date").value = dateStr;

                // æµ·æ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                await fetchAndDisplayOceanData(lat, lng, dateStr, timeStr);
              });

              resolve(googleMap);
            };

            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=maps,marker&language=ja&loading=async&callback=initGoogleMapsCallback`;
            script.async = true;
            document.head.appendChild(script);
          });
        } catch (error) {
          console.error("Google Maps initialization failed:", error);
        }
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        await initGoogleMap();

        // ocean-checkerã‹ã‚‰ã®é·ç§»ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
        const oceanDataStr = sessionStorage.getItem("oceanData");
        if (oceanDataStr) {
          try {
            const oceanData = JSON.parse(oceanDataStr);
            sessionStorage.removeItem("oceanData"); // ä¸€åº¦é™ã‚Šä½¿ç”¨

            // ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•åæ˜ 
            if (oceanData.location) {
              const nearestLoc = findNearestLocation(
                oceanData.location.lat,
                oceanData.location.lng,
              );
              document.getElementById("location").value = nearestLoc.name;

              // ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’ãã“ã«ç§»å‹•
              if (googleMap) {
                googleMap.setCenter({
                  lat: oceanData.location.lat,
                  lng: oceanData.location.lng,
                });
                if (mapMarker) mapMarker.setMap(null);
                mapMarker = new google.maps.Marker({
                  position: {
                    lat: oceanData.location.lat,
                    lng: oceanData.location.lng,
                  },
                  map: googleMap,
                });
              }
            }

            if (oceanData.date) {
              document.getElementById("date").value = oceanData.date;
            }

            // ãƒ¡ãƒ¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æµ·æ³æƒ…å ±ã‚’è¿½åŠ 
            const oceanInfo = `æ°—æ¸©:${oceanData.temperature}Â°C æ°´æ¸©:${
              oceanData.waterTemperature
            }Â°C é¢¨:${oceanData.windSpeed}m/s(${getWindDirStr(
              oceanData.windDirection,
            )}) æ°—åœ§:${oceanData.pressure}hPa æ½®ä½:${
              oceanData.tideHeight
                ? (oceanData.tideHeight * 100).toFixed(0) + " cm"
                : "-"
            } æ³¢:${oceanData.waveHeight} å‘¨æœŸ:${oceanData.wavePeriod}`;

            const memoField = document.getElementById("memo");
            memoField.value = oceanInfo;

            currentOceanData = oceanData;
          } catch (error) {
            console.error("Failed to restore ocean data:", error);
          }
        }
      });
    </script>
  </body>
</html>
