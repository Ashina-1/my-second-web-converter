<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>é‡£æœè¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #a2d4f7 0%, #0e6ba8 100%);
        position: relative;
        overflow-x: hidden;
      }
      h1 {
        color: #fff;
        text-align: center;
        margin-top: 40px;
        text-shadow: 0 2px 8px #0e6ba8cc;
        letter-spacing: 2px;
      }
      #catchForm {
        margin: 32px auto 0 auto;
        display: none;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 18px 18px 30px 30px;
        padding: 24px 18px 32px 18px;
        max-width: 500px;
        box-shadow: 0 4px 16px 0 #0e6ba84d;
        border-bottom: 8px solid #4fc3f7;
        border-top: 2px solid #b3e5fc;
        position: relative;
        z-index: 1;
      }
      #catchForm label {
        display: block;
        margin-bottom: 10px;
      }
      #catchForm input[type="text"],
      #catchForm input[type="number"],
      #catchForm input[type="date"] {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        box-sizing: border-box;
        border-radius: 6px;
        border: 1px solid #b3e5fc;
        background: #e1f5fe;
      }
      #catchForm button {
        margin-top: 10px;
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
      }
      #catchForm button:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #loginBtn {
        display: block;
        margin: 32px auto 0 auto;
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
      }
      #loginBtn:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 18px 18px 30px 30px;
        max-width: 500px;
        box-shadow: 0 4px 16px 0 #0e6ba84d;
        border-bottom: 8px solid #4fc3f7;
        border-top: 2px solid #b3e5fc;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        z-index: 1;
      }
      #footer button {
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
      }
      #footer button:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #footer p {
        margin-top: 10px;
        color: #555;
      }
      /* æ³¢ã®è£…é£¾ */
      .wave {
        position: absolute;
        left: 0;
        width: 100%;
        height: 120px;
        pointer-events: none;
        z-index: 0;
      }
      .wave.top {
        top: 0;
        transform: rotate(180deg);
      }
      .wave.bottom {
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <h1>é‡£æœè¨˜éŒ²ã‚¢ãƒ—ãƒª</h1>
    <button id="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>

    <form id="catchForm">
      <h2
        style="
          text-align: center;
          color: #0288d1;
          text-shadow: 0 2px 8px #b3e5fc;
        "
      >
        é‡£æœå…¥åŠ›
      </h2>
      <label>é­šã®åç§°ï¼š<input type="text" id="fish" /></label><br />
      <label>ã‚µã‚¤ã‚º(cm)ï¼š<input type="number" id="size" /></label><br />
      <label>å ´æ‰€ï¼š<input type="text" id="location" /></label><br />
      <label>æ—¥ä»˜ï¼š<input type="date" id="date" /></label><br />
      <input type="file" id="catch-image" accept="image/*" /><br />
      <label>ä½¿ç”¨ã—ãŸã‚¿ãƒƒã‚¯ãƒ«</label><br />
      <label
        >ãƒ­ãƒƒãƒ‰ï¼š<input
          type="text"
          id="rod"
          placeholder="ä¾‹ï¼šã‚·ãƒãƒ ã‚³ãƒ«ãƒˆã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼S100MH" /></label
      ><br />
      <label
        >ãƒªãƒ¼ãƒ«ï¼š<input
          type="text"
          id="reel"
          placeholder="ä¾‹ï¼šã‚·ãƒãƒ ã‚¹ãƒ†ãƒ©4000XG" /></label
      ><br />
      <label
        >ãƒ©ã‚¤ãƒ³ï¼š<input
          type="text"
          id="line"
          placeholder="ä¾‹ï¼šPE 1.5å·" /></label
      ><br />
      <label
        >ä»•æ›ã‘ or ãƒ«ã‚¢ãƒ¼ç­‰ï¼š<input
          type="text"
          id="lure"
          placeholder="ä¾‹ï¼šãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¯ãƒ©ãƒ•ãƒˆ ã‚¸ã‚°ãƒ‘ãƒ©40g" /></label
      ><br />
      <label
        >ãƒ¡ãƒ¢ï¼š<input
          type="text"
          id="memo"
          placeholder="ä¾‹ï¼šæ™´ã‚Œã€é¢¨å¼±ã€æ½®æ­¢ã¾ã‚Š" /></label
      ><br />
      <button type="submit">è¨˜éŒ²</button>
    </form>
    <footer id="footer">
      <button>é‡£æœä¸€è¦§ã¸</button><br />
      <p>&copy; 2025 é‡£æœè¨˜éŒ²ã‚¢ãƒ—ãƒª</p>
    </footer>
    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <!-- ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="homeBtn" class="home-btn" title="ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹">ğŸ </button>
    <style>
      .home-btn {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 9999;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        cursor: pointer;
      }
      .home-btn:hover {
        filter: brightness(1.05);
      }
    </style>
    <script>
      document.getElementById("homeBtn").addEventListener("click", () => {
        window.location.href = "index.html";
      });
    </script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        doc,
        setDoc,
        deleteDoc,
        updateDoc,
        getDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBk4qQ8E0qDUHcsLXcvjIVtJCAruSUuOwM",
        authDomain: "fishing-log-app-5bea9.firebaseapp.com",
        projectId: "fishing-log-app-5bea9",
        storageBucket: "fishing-log-app-5bea9.firebasestorage.app",
        messagingSenderId: "730868295976",
        appId: "1:730868295976:web:430b3435d68ad122c7c81d",
        measurementId: "G-GT36TCEJPM",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const provider = new GoogleAuthProvider();
      const auth = getAuth();
      //
      const loginBtn = document.getElementById("loginBtn");
      const catchForm = document.getElementById("catchForm");
      const db = getFirestore(app);
      const storage = getStorage(app);
      //ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", user);
          loginBtn.textContent = "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ";
          catchForm.style.display = "block"; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜/æ›´æ–°ï¼ˆupsertï¼‰
          (async () => {
            try {
              await setDoc(
                doc(db, "users", user.uid),
                {
                  uid: user.uid,
                  email: user.email || "",
                  displayName: user.displayName || "",
                  photoURL: user.photoURL || "",
                  lastSeen: serverTimestamp(),
                },
                { merge: true }
              );
            } catch (err) {
              console.error("users collection upsert failed:", err);
            }
          })();
          loadMyCatches(user.uid); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡£æœã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        } else {
          console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­");
          loginBtn.textContent = "Googleã§ãƒ­ã‚°ã‚¤ãƒ³";
          catchForm.style.display = "none"; // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
        }
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        loginBtn.addEventListener("click", async () => {
          if (auth.currentUser) {
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            await signOut(auth);
            alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
          } else {
            // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
            try {
              const result = await signInWithPopup(auth, provider);
              const user = result.user;
              alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: " + user.displayName);
            } catch (error) {
              console.error("Error during sign-in:", error);
              alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
          }
        });
      });
      //é‡£æœã‚’ç™»éŒ²ã™ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document
        .getElementById("catchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const user = auth.currentUser; // ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
          if (!user) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            return;
          }
          const fish = document.getElementById("fish").value;
          const sizeRaw = document.getElementById("size").value;
          const size = Number(sizeRaw);
          if (Number.isNaN(size) || size < 0 || size > 2000) {
            alert("ã‚µã‚¤ã‚ºã¯0ã€œ2000ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          const location = document.getElementById("location").value;
          const date = document.getElementById("date").value;
          //ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠæ™‚ã®å‡¦ç†
          const imageFile = document.getElementById("catch-image").files[0];
          if (!imageFile) {
            alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
          }
          let imageUrl = "";

          if (imageFile) {
            // ç”»åƒã‚’Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const storageRef = ref(
              storage,
              `catch-images/${user.uid}/${Date.now()}_${imageFile.name}`
            );
            await uploadBytes(storageRef, imageFile);
            imageUrl = await getDownloadURL(storageRef);
            try {
              await addDoc(collection(db, "fishinglogs"), {
                uid: user.uid,
                catch: {
                  fish: fish,
                  size: size,
                  location: location,
                  date: date,
                  imageUrl: imageUrl,
                  rod: document.getElementById("rod").value,
                  reel: document.getElementById("reel").value,
                  line: document.getElementById("line").value,
                  lure: document.getElementById("lure").value,
                  memo: "", // ãƒ¡ãƒ¢æ¬„ã¯ç©ºã§åˆæœŸåŒ–
                },
              });
              alert("é‡£æœãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
              // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
              catchForm.reset();
            } catch (error) {
              console.error("Error adding document: ", error);
              alert("é‡£æœã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
          }
        });

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡£æœã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      async function loadMyCatches(uid) {
        const querySnapshot = await getDocs(collection(db, "fishinglogs"));
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.uid === uid) {
            console.log("é‡£æœ:", data.catch);
            // ã“ã“ã§é‡£æœã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ å¯èƒ½
          }
        });
      }
      // é‡£æœä¸€è¦§ã¸ãƒœã‚¿ãƒ³ã§ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸é·ç§»
      document.querySelector("#footer button").addEventListener("click", () => {
        window.location.href = "fishing-log2.html";
      });
    </script>
  </body>
</html>
