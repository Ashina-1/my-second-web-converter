<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>釣果一覧</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="stylesheet.css" />
    <script type="module">
      import {
        auth,
        db,
        configValid,
        collection,
        getDocs,
        query,
        where,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        arrayUnion,
        arrayRemove,
        onAuthStateChanged,
      } from "./firebase-init.js";

      // If firebase isn't configured, show a friendly message and stop.
      if (!configValid) {
        const el = document.getElementById("catchList");
        if (el) {
          el.innerHTML = `<div class="site-card">Firebase が未構成のためデータは読み込めません。firebase-config.js を設定してください。</div>`;
        }
      }

      // helper to set owner header (name + optional back-to-me button)
      function setOwnerHeader(name, uid, isSelf) {
        const hdr = document.getElementById("ownerHeader");
        if (!hdr) return;
        const backBtn = isSelf
          ? ""
          : `<button id='backToMeBtn' style='margin-right:8px;'>自分に戻る</button>`;
        hdr.innerHTML = `<div style='display:flex;align-items:center;gap:12px;justify-content:space-between'><div><strong style='color:#0288d1'>${escapeHtml(
          name
        )}</strong></div><div>${backBtn}</div></div>`;
        const btn = document.getElementById("backToMeBtn");
        if (btn) {
          btn.addEventListener("click", () => {
            if (window.currentUserUid) {
              setOwnerHeader("自分", window.currentUserUid, true);
              loadMyCatches(window.currentUserUid);
            }
          });
        }
      }

      // auth state: set global uid and trigger initial load when DOM is ready
      if (onAuthStateChanged && auth) {
        onAuthStateChanged(auth, (user) => {
          window.currentUserUid = user ? user.uid : null;
          // ensure DOM is parsed before attempting to render
          const start = () => {
            if (user) {
              // try to resolve displayName for header
              loadOwnerAndSetHeader(user.uid, true);
              loadMyCatches(user.uid);
              loadFriends(user.uid);
            } else {
              // clear owner header and show login hint
              const hdr = document.getElementById("ownerHeader");
              if (hdr)
                hdr.innerHTML = `<div class='subtle'>ログインして自分の釣果を表示してください</div>`;
              const catchList = document.getElementById("catchList");
              if (catchList)
                catchList.innerHTML = `<p>ログインすると自分と友だちの釣果を閲覧できます。</p>`;
            }
          };
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", start);
          } else {
            start();
          }
        });
      }

      // fetch user's displayName from users collection and set owner header
      async function loadOwnerAndSetHeader(uid, isSelf) {
        try {
          const udoc = await getDoc(doc(db, "users", uid));
          const d = udoc.exists() ? udoc.data() : {};
          const name = d.displayName || d.email || (isSelf ? "自分" : uid);
          setOwnerHeader(name, uid, isSelf);
        } catch (err) {
          console.warn("loadOwnerAndSetHeader failed", err);
          setOwnerHeader(isSelf ? "自分" : uid, uid, isSelf);
        }
      }

      // small utility to avoid XSS in simple strings
      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      // --- 釣果を読み込む関数 ---
      async function loadMyCatches(uid) {
        const catchList = document.getElementById("catchList");
        catchList.innerHTML = "読み込み中...";
        // Firestoreから現在のユーザーの釣果のみを取得（最適化）
        const q = query(collection(db, "fishinglogs"), where("uid", "==", uid));
        const querySnapshot = await getDocs(q);
        let html = "";
        querySnapshot.forEach((snap) => {
          const data = snap.data();
          const docId = snap.id;
          const fish = escapeHtml(
            (data && data.catch && data.catch.fish) || ""
          );
          const date = escapeHtml(
            (data && data.catch && data.catch.date) || ""
          );
          const size = escapeHtml(
            String((data && data.catch && data.catch.size) || "")
          );
          const location = escapeHtml(
            (data && data.catch && data.catch.location) || ""
          );

          // image thumbnail (use placeholder SVG when missing/invalid)
          const placeholderSvg = `
            <svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
              <rect width='100%' height='100%' fill='#e0e0e0'/>
              <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='32' fill='#666'>No Image</text>
            </svg>`;
          const placeholder =
            "data:image/svg+xml;utf8," + encodeURIComponent(placeholderSvg);
          const rawUrl = (data && data.catch && data.catch.imageUrl) || "";
          const isValidUrl =
            typeof rawUrl === "string" &&
            (rawUrl.startsWith("http://") ||
              rawUrl.startsWith("https://") ||
              rawUrl.startsWith("data:") ||
              rawUrl.startsWith("blob:"));
          const imgTag = isValidUrl
            ? `<img src="${rawUrl}" alt="Catch Image" class="thumb-img" onerror="this.onerror=null;this.src='${placeholder}'"/>`
            : `<img src="${placeholder}" alt="No Image" class="thumb-img"/>`;

          // simplified card with thumbnail on left and meta on right
          html += `<div class="catch-item" data-id="${docId}" tabindex="0" role="button">
            <div class="img-thumb">${imgTag}</div>
             <div class="meta compact">
              <p class="title"><strong>${fish}</strong> <small class="date">${date}</small></p>
              <p class="summary"><span class="label">サイズ:</span> ${size} cm</p>
              <p class="summary"><span class="label">場所:</span> ${location}</p>
            </div>
          </div>`;
        });
        if (html === "") {
          html = "<p>まだ釣果がありません。</p>";
        }
        catchList.innerHTML = html;
      }

      // --- friends 管理 ---
      async function loadFriends(uid) {
        const friendsPanel = document.getElementById("friendsPanel");
        const friendsList = document.getElementById("friendsList");
        const input = document.getElementById("friendUidInput");
        friendsList.innerHTML = "読み込み中...";
        try {
          const userDocRef = doc(db, "users", uid);
          const userSnap = await getDoc(userDocRef);
          const friends = (userSnap.exists() && userSnap.data().friends) || [];
          if (friends.length === 0) {
            friendsList.innerHTML = "<p>友だちがいません。</p>";
          } else {
            friendsList.innerHTML = "";
            // fetch each friend's public profile to show displayName/shortId
            for (const f of friends) {
              try {
                const friendDoc = await getDoc(doc(db, "users", f));
                const fd = friendDoc.exists() ? friendDoc.data() : {};
                const display = fd.displayName || fd.email || f;
                const short = fd.shortId ? ` (${fd.shortId})` : "";
                const el = document.createElement("div");
                el.className = "friend-item";
                el.innerHTML = `<span style="cursor:pointer;">${escapeHtml(
                  display
                )}${short} <small style="color:#777; margin-left:8px;">${f}</small></span> <button data-view="${f}" class="view-friend" style="margin-left:8px;padding:6px 8px;border-radius:6px;border:none;background:#0288d1;color:#fff;display:inline-flex;align-items:center;gap:6px;"><svg width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>表示</button> <button data-uid="${f}" class="remove-friend" style="margin-left:6px;padding:6px 8px;border-radius:6px;border:none;background:#e53935;color:#fff;display:inline-flex;align-items:center;gap:6px;"><svg width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>削除</button>`;
                friendsList.appendChild(el);
              } catch (err) {
                const el = document.createElement("div");
                el.className = "friend-item";
                el.innerHTML = `<span style="cursor:pointer;">${f}</span> <button data-view="${f}" class="view-friend" style="margin-left:8px;padding:6px 8px;border-radius:6px;border:none;background:#0288d1;color:#fff;display:inline-flex;align-items:center;gap:6px;"><svg width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>表示</button> <button data-uid="${f}" class="remove-friend" style="margin-left:6px;padding:6px 8px;border-radius:6px;border:none;background:#e53935;color:#fff;display:inline-flex;align-items:center;gap:6px;"><svg width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>削除</button>`;
                friendsList.appendChild(el);
              }
            }
            // attach remove handlers
            friendsList.querySelectorAll(".remove-friend").forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                const friendUid = e.target.getAttribute("data-uid");
                await removeFriend(uid, friendUid);
                await loadFriends(uid);
              });
            });
            // attach view handlers
            friendsList.querySelectorAll(".view-friend").forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                const friendUid = e.target.getAttribute("data-view");
                if (!friendUid) return;
                await loadFriendCatches(friendUid);
              });
            });
          }
        } catch (err) {
          console.error("loadFriends error", err);
          friendsList.innerHTML = "<p>友だちの読み込みに失敗しました</p>";
        }
        // add handler for add button
        const addBtn = document.getElementById("addFriendBtn");
        addBtn.onclick = async () => {
          let target = document.getElementById("friendUidInput").value.trim();
          if (!target)
            return alert("追加するユーザーのUIDまたは短いIDを入力してください");
          // if user inputs a 10-digit numeric shortId, resolve it to uid
          if (/^\d{10}$/.test(target)) {
            try {
              const q = query(
                collection(db, "users"),
                where("shortId", "==", target)
              );
              const snaps = await getDocs(q);
              if (snaps.empty) {
                alert("該当する短いIDのユーザーが見つかりません");
                return;
              }
              // take first match
              target = snaps.docs[0].id;
            } catch (err) {
              console.error("shortId lookup error", err);
              alert("短いIDの照会でエラーが発生しました");
              return;
            }
          }
          if (target === uid) return alert("自分を追加できません");
          await addFriend(uid, target);
          input.value = "";
          await loadFriends(uid);
        };
      }

      async function addFriend(uid, friendUid) {
        try {
          const userDocRef = doc(db, "users", uid);
          await setDoc(
            userDocRef,
            { friends: arrayUnion(friendUid) },
            { merge: true }
          );
        } catch (err) {
          console.error("addFriend error", err);
          alert("友だち追加に失敗しました");
        }
      }

      async function removeFriend(uid, friendUid) {
        try {
          const userDocRef = doc(db, "users", uid);
          await updateDoc(userDocRef, { friends: arrayRemove(friendUid) });
        } catch (err) {
          console.error("removeFriend error", err);
          alert("友だち削除に失敗しました");
        }
      }

      // --- 他ユーザー（フレンド）の釣果を読み込む関数 ---
      async function loadFriendCatches(friendUid) {
        const catchList = document.getElementById("catchList");
        catchList.innerHTML = "読み込み中...";
        try {
          // fetch friend's profile for display name
          let display = friendUid;
          try {
            const friendDoc = await getDoc(doc(db, "users", friendUid));
            if (friendDoc.exists()) {
              const fd = friendDoc.data();
              display = fd.displayName || fd.email || friendUid;
            }
          } catch (e) {
            console.warn("friend profile fetch failed", e);
          }
          setOwnerHeader(display, friendUid, false);

          const q = query(
            collection(db, "fishinglogs"),
            where("uid", "==", friendUid)
          );
          const querySnapshot = await getDocs(q);
          let html = "";
          querySnapshot.forEach((snap) => {
            const data = snap.data();
            const docId = snap.id;
            const fish = escapeHtml(
              (data && data.catch && data.catch.fish) || ""
            );
            const date = escapeHtml(
              (data && data.catch && data.catch.date) || ""
            );
            const size = escapeHtml(
              String((data && data.catch && data.catch.size) || "")
            );
            const location = escapeHtml(
              (data && data.catch && data.catch.location) || ""
            );

            const placeholderSvg = `
            <svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
              <rect width='100%' height='100%' fill='#e0e0e0'/>
              <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='32' fill='#666'>No Image</text>
            </svg>`;
            const placeholder =
              "data:image/svg+xml;utf8," + encodeURIComponent(placeholderSvg);
            const rawUrl = (data && data.catch && data.catch.imageUrl) || "";
            const isValidUrl =
              typeof rawUrl === "string" &&
              (rawUrl.startsWith("http://") ||
                rawUrl.startsWith("https://") ||
                rawUrl.startsWith("data:") ||
                rawUrl.startsWith("blob:"));
            const imgTag = isValidUrl
              ? `<img src="${rawUrl}" alt="Catch Image" class="thumb-img" onerror="this.onerror=null;this.src='${placeholder}'"/>`
              : `<img src="${placeholder}" alt="No Image" class="thumb-img"/>`;

            html += `<div class="catch-item" data-id="${docId}" tabindex="0" role="button">
              <div class="img-thumb">${imgTag}</div>
              <div class="meta compact">
                <p class="title"><strong>${fish}</strong> <small class="date">${date}</small></p>
                <p class="summary"><span class="label">サイズ:</span> ${size} cm</p>
                <p class="summary"><span class="label">場所:</span> ${location}</p>
              </div>
            </div>`;
          });
          if (html === "") html = "<p>釣果がありません。</p>";
          catchList.innerHTML = html;
        } catch (err) {
          console.error("loadFriendCatches error", err);
          catchList.innerHTML = "<p>釣果の読み込みに失敗しました</p>";
        }
      }
      // 全体をクリックしたら詳細ページへ遷移する（画像限定ではなくカード全体）
      document.getElementById("catchList").addEventListener("click", (e) => {
        const item =
          e.target && e.target.closest ? e.target.closest(".catch-item") : null;
        if (item) {
          const id = item.getAttribute("data-id");
          if (id) {
            window.location.href = `fishing-log2-detail.html?id=${encodeURIComponent(
              id
            )}`;
          }
        }
      });
      // 釣果登録ボタンから登録ページへ遷移
      document.getElementById("toRegister").addEventListener("click", () => {
        window.location.href = "fishing-log.html";
      });
    </script>

    <!-- page-specific styles moved to stylesheet.css -->
  </head>

  <body>
    <header>
      <div class="container">
        <div class="header-left">
          <a class="logo" href="index.html" aria-label="ホーム">
            <svg
              width="40"
              height="28"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true"
              focusable="false"
            >
              <path
                d="M22 12c0 0-4-2-8-2s-8 2-8 2S2 14 2 18s3 4 7 4 6-2 8-4 5-4 5-6-1-2-1-2z"
                fill="none"
                stroke="currentColor"
                stroke-width="1.2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <circle cx="7" cy="12" r="1" fill="currentColor" />
            </svg>
          </a>
        </div>
        <div class="header-right">
          <a href="index.html">ホーム</a>
          <a href="fishing-log2.html">釣果一覧</a>
          <a href="fishing-log.html">登録</a>
          <div class="nav-tools">
            <button
              class="tools-btn"
              aria-haspopup="true"
              aria-expanded="false"
            >
              ツール ▾
            </button>
            <div class="submenu" role="menu">
              <a role="menuitem" href="pe-converter.html">PE変換</a>
              <a role="menuitem" href="pe(tanatoru4)-converter.html"
                >タナトル4</a
              >
              <a role="menuitem" href="index.html">その他</a>
            </div>
          </div>
          <a href="profile.html">プロフィール</a>
        </div>
        <button class="menu-icon" id="menuIcon" aria-label="メニュー">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M4 6h16M4 12h16M4 18h16"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"
            />
          </svg>
        </button>
      </div>
    </header>
    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <h2>
      <svg
        class="icon icon-fish"
        width="28"
        height="28"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        focusable="false"
      >
        <path
          d="M22 12c0 0-4-2-8-2s-8 2-8 2S2 14 2 18s3 4 7 4 6-2 8-4 5-4 5-6-1-2-1-2z"
          fill="none"
          stroke="currentColor"
          stroke-width="1.2"
          stroke-linecap="round"
          stroke-linejoin="round"
        ></path>
        <circle cx="7" cy="12" r="1" fill="currentColor"></circle>
      </svg>
      釣果リスト
    </h2>
    <div id="ownerHeader" class="ownerHeader"></div>
    <div id="catchList" class="catch-list" role="list">
      <div class="empty-state">読み込み中...</div>
    </div>

    <!-- Friends panel -->
    <section id="friendsPanel" class="friends-panel">
      <h3 style="color: #0288d1">友だち管理</h3>
      <div
        style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px"
      >
        <input
          id="friendUidInput"
          placeholder="友だちのUIDを入力"
          style="
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #b3e5fc;
          "
        />
        <button
          id="addFriendBtn"
          style="
            padding: 8px 12px;
            border-radius: 6px;
            background: #66bb6a;
            color: #fff;
            border: none;
          "
        >
          追加
        </button>
      </div>
      <div id="friendsList">読み込み中...</div>
    </section>
    <div class="action-row">
      <button id="toRegister">釣果登録へ</button>
      <button id="logout">ログアウト</button>
    </div>
    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <!-- ホームへ戻るボタン -->
    <button
      id="homeBtn"
      class="home-btn"
      title="ホームへ戻る"
      aria-label="ホームへ戻る"
    >
      <svg
        width="22"
        height="22"
        viewBox="0 0 24 24"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        focusable="false"
      >
        <path
          d="M3 10.5L12 4l9 6.5"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M5 10.5v7a1 1 0 0 0 1 1h3v-5h6v5h3a1 1 0 0 0 1-1v-7"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
    <!-- home button styling moved to stylesheet.css -->
    <script>
      document.getElementById("homeBtn").addEventListener("click", () => {
        window.location.href = "index.html";
      });
    </script>
    <script src="scripts/header.js"></script>
  </body>
</html>
