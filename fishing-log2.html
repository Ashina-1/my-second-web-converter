<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>é‡£æœãƒªã‚¹ãƒˆ | Fishing Log</title>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBk4qQ8E0qDUHcsLXcvjIVtJCAruSUuOwM",
        authDomain: "fishing-log-app-5bea9.firebaseapp.com",
        projectId: "fishing-log-app-5bea9",
        storageBucket: "fishing-log-app-5bea9.firebasestorage.app",
        messagingSenderId: "730868295976",
        appId: "1:730868295976:web:c745939c9f9b3936c7c81d",
        measurementId: "G-5XT73YG2RP",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      // --- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç›£è¦– ---
      import {
        getAuth,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        arrayUnion,
        arrayRemove,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
      const auth = getAuth();
      const db = getFirestore(app);
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", user);
          loadMyCatches(user.uid); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡£æœã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ã‚’å‘¼ã³å‡ºã—
          loadFriends(user.uid); // ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        } else {
          console.log("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­");
          // æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³å°ç·šï¼ˆfishing-log.htmlï¼‰ã¸èª˜å°
          window.location.href = "fishing-log.html";
        }
      });
      // --- é‡£æœã‚’èª­ã¿è¾¼ã‚€é–¢æ•° ---
      async function loadMyCatches(uid) {
        const catchList = document.getElementById("catchList");
        catchList.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
        // Firestoreã‹ã‚‰ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡£æœã®ã¿ã‚’å–å¾—ï¼ˆæœ€é©åŒ–ï¼‰
        const q = query(collection(db, "fishinglogs"), where("uid", "==", uid));
        const querySnapshot = await getDocs(q);
        let html = "";
        querySnapshot.forEach((snap) => {
          const data = snap.data();
          const docId = snap.id;
          // DNS ã‚„å¤–éƒ¨ä¾å­˜ã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯ data URI ã® SVG ã‚’ä½¿ç”¨
          const placeholderSvg = `
            <svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
              <rect width='100%' height='100%' fill='#e0e0e0'/>
              <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='32' fill='#666'>No Image</text>
            </svg>`;
          const placeholder =
            "data:image/svg+xml;utf8," + encodeURIComponent(placeholderSvg);
          const rawUrl = (data && data.catch && data.catch.imageUrl) || "";
          const isValidUrl =
            typeof rawUrl === "string" &&
            (rawUrl.startsWith("http://") ||
              rawUrl.startsWith("https://") ||
              rawUrl.startsWith("data:") ||
              rawUrl.startsWith("blob:"));
          const imgTag = isValidUrl
            ? `<img src="${rawUrl}"
                   alt="Catch Image"
                   style="max-width:100%; border-radius:8px;"
                   onerror="this.onerror=null;this.src='${placeholder}';"/>`
            : `<img src="${placeholder}" alt="No Image" style="max-width:100%; border-radius:8px;"/>`;

          html += `<div class="catch-item" data-id="${docId}">
          <p><strong>é­šç¨®:</strong> ${data.catch.fish}</p>
          <p><strong>ã‚µã‚¤ã‚º:</strong> ${data.catch.size} cm</p>
          <p><strong>å ´æ‰€:</strong> ${data.catch.location}</p>
          <p><strong>æ—¥ä»˜:</strong> ${data.catch.date}</p>
          <p><strong>ãƒ¡ãƒ¢:</strong> ${data.catch.memo}</p>
          <p><strong>ãƒ­ãƒƒãƒ‰:</strong> ${data.catch.rod}</p>
          <p><strong>ãƒªãƒ¼ãƒ«:</strong> ${data.catch.reel}</p>
          <p><strong>ãƒ©ã‚¤ãƒ³:</strong> ${data.catch.line}</p>
          <p><strong>ä»•æ›ã‘ or ãƒ«ã‚¢ãƒ¼ç­‰:</strong> ${data.catch.lure}</p>
          ${imgTag}
          </div>`;
        });
        if (html === "") {
          html = "<p>ã¾ã é‡£æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        }
        catchList.innerHTML = html;
      }

      // --- friends ç®¡ç† ---
      async function loadFriends(uid) {
        const friendsPanel = document.getElementById("friendsPanel");
        const friendsList = document.getElementById("friendsList");
        const input = document.getElementById("friendUidInput");
        friendsList.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
        try {
          const userDocRef = doc(db, "users", uid);
          const userSnap = await getDoc(userDocRef);
          const friends = (userSnap.exists() && userSnap.data().friends) || [];
          if (friends.length === 0) {
            friendsList.innerHTML = "<p>å‹ã ã¡ãŒã„ã¾ã›ã‚“ã€‚</p>";
          } else {
            friendsList.innerHTML = "";
            // fetch each friend's public profile to show displayName/shortId
            for (const f of friends) {
              try {
                const friendDoc = await getDoc(doc(db, "users", f));
                const fd = friendDoc.exists() ? friendDoc.data() : {};
                const display = fd.displayName || fd.email || f;
                const short = fd.shortId ? ` (${fd.shortId})` : "";
                const el = document.createElement("div");
                el.className = "friend-item";
                el.innerHTML = `<span>${display}${short} <small style="color:#777; margin-left:8px;">${f}</small></span> <button data-uid="${f}" class="remove-friend">å‰Šé™¤</button>`;
                friendsList.appendChild(el);
              } catch (err) {
                const el = document.createElement("div");
                el.className = "friend-item";
                el.innerHTML = `<span>${f}</span> <button data-uid="${f}" class="remove-friend">å‰Šé™¤</button>`;
                friendsList.appendChild(el);
              }
            }
            // attach remove handlers
            friendsList.querySelectorAll(".remove-friend").forEach((btn) => {
              btn.addEventListener("click", async (e) => {
                const friendUid = e.target.getAttribute("data-uid");
                await removeFriend(uid, friendUid);
                await loadFriends(uid);
              });
            });
          }
        } catch (err) {
          console.error("loadFriends error", err);
          friendsList.innerHTML = "<p>å‹ã ã¡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>";
        }
        // add handler for add button
        const addBtn = document.getElementById("addFriendBtn");
        addBtn.onclick = async () => {
          let target = document.getElementById("friendUidInput").value.trim();
          if (!target)
            return alert("è¿½åŠ ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã¾ãŸã¯çŸ­ã„IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          // if user inputs a 10-digit numeric shortId, resolve it to uid
          if (/^\d{10}$/.test(target)) {
            try {
              const q = query(
                collection(db, "users"),
                where("shortId", "==", target)
              );
              const snaps = await getDocs(q);
              if (snaps.empty) {
                alert("è©²å½“ã™ã‚‹çŸ­ã„IDã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
              }
              // take first match
              target = snaps.docs[0].id;
            } catch (err) {
              console.error("shortId lookup error", err);
              alert("çŸ­ã„IDã®ç…§ä¼šã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
              return;
            }
          }
          if (target === uid) return alert("è‡ªåˆ†ã‚’è¿½åŠ ã§ãã¾ã›ã‚“");
          await addFriend(uid, target);
          input.value = "";
          await loadFriends(uid);
        };
      }

      async function addFriend(uid, friendUid) {
        try {
          const userDocRef = doc(db, "users", uid);
          await setDoc(
            userDocRef,
            { friends: arrayUnion(friendUid) },
            { merge: true }
          );
        } catch (err) {
          console.error("addFriend error", err);
          alert("å‹ã ã¡è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      }

      async function removeFriend(uid, friendUid) {
        try {
          const userDocRef = doc(db, "users", uid);
          await updateDoc(userDocRef, { friends: arrayRemove(friendUid) });
        } catch (err) {
          console.error("removeFriend error", err);
          alert("å‹ã ã¡å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      }
      //ã€€è©³ç´°ãƒšãƒ¼ã‚¸ã¸
      document.getElementById("catchList").addEventListener("click", (e) => {
        const item =
          e.target && e.target.closest ? e.target.closest(".catch-item") : null;
        const clickedImg =
          e.target && e.target.matches && e.target.matches(".catch-item img");
        if (item && clickedImg) {
          const id = item.getAttribute("data-id");
          if (id) {
            window.location.href = `fishing-log2-detail.html?id=${encodeURIComponent(
              id
            )}`;
          }
        }
      });
      // é‡£æœç™»éŒ²ãƒœã‚¿ãƒ³ã‹ã‚‰ç™»éŒ²ãƒšãƒ¼ã‚¸ã¸é·ç§»
      document.getElementById("toRegister").addEventListener("click", () => {
        window.location.href = "fishing-log.html";
      });
    </script>

    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #a2d4f7 0%, #0e6ba8 100%);
        position: relative;
        overflow-x: hidden;
      }
      h2 {
        text-align: center;
        color: #fff;
        margin-top: 40px;
        text-shadow: 0 2px 8px #0e6ba8cc;
        letter-spacing: 2px;
      }
      .catch-item {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 18px 18px 30px 30px;
        padding: 18px 18px 28px 18px;
        margin: 24px auto 32px auto;
        max-width: 500px;
        box-shadow: 0 4px 16px 0 #0e6ba84d;
        border-bottom: 8px solid #4fc3f7;
        border-top: 2px solid #b3e5fc;
        position: relative;
      }
      .catch-item img {
        box-shadow: 0 4px 16px #4fc3f7aa;
        border: 3px solid #b3e5fc;
        background: #e1f5fe;
      }
      #logout,
      #toRegister {
        padding: 10px 24px;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        box-shadow: 0 2px 8px #0288d166;
        transition: background 0.3s;
        flex: 1;
        margin: 0 8px;
      }
      #logout:hover {
        background: linear-gradient(90deg, #26c6da 0%, #0288d1 100%);
      }
      #toRegister {
        background: linear-gradient(90deg, #66bb6a 0%, #a5d6a7 100%);
      }
      #toRegister:hover {
        background: linear-gradient(90deg, #a5d6a7 0%, #66bb6a 100%);
      }
      .action-row {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin: 24px 0 0 0;
        z-index: 2;
        position: relative;
      }
      /* æ³¢ã®è£…é£¾ */
      .wave {
        position: absolute;
        left: 0;
        width: 100%;
        height: 120px;
        pointer-events: none;
        z-index: 0;
      }
      .wave.top {
        top: 0;
        transform: rotate(180deg);
      }
      .wave.bottom {
        bottom: 0;
      }
    </style>
  </head>

  <body>
    <div class="wave top">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <h2>ï¿½ é‡£æœãƒªã‚¹ãƒˆ</h2>
    <div id="catchList">èª­ã¿è¾¼ã¿ä¸­...</div>

    <!-- Friends panel -->
    <section
      id="friendsPanel"
      style="
        max-width: 500px;
        margin: 16px auto;
        padding: 12px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
      "
    >
      <h3 style="color: #0288d1">å‹ã ã¡ç®¡ç†</h3>
      <div
        style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px"
      >
        <input
          id="friendUidInput"
          placeholder="å‹ã ã¡ã®UIDã‚’å…¥åŠ›"
          style="
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #b3e5fc;
          "
        />
        <button
          id="addFriendBtn"
          style="
            padding: 8px 12px;
            border-radius: 6px;
            background: #66bb6a;
            color: #fff;
            border: none;
          "
        >
          è¿½åŠ 
        </button>
      </div>
      <div id="friendsList">èª­ã¿è¾¼ã¿ä¸­...</div>
    </section>
    <div class="action-row">
      <button id="toRegister">é‡£æœç™»éŒ²ã¸</button>
      <button id="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div class="wave bottom">
      <svg
        viewBox="0 0 1440 120"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill="#4fc3f7"
          fill-opacity="0.5"
          d="M0,80 C360,160 1080,0 1440,80 L1440,120 L0,120 Z"
        ></path>
      </svg>
    </div>
    <!-- ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="homeBtn" class="home-btn" title="ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹">ğŸ </button>
    <style>
      .home-btn {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 9999;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(90deg, #0288d1 0%, #26c6da 100%);
        color: #fff;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        cursor: pointer;
      }
      .home-btn:hover {
        filter: brightness(1.05);
      }
    </style>
    <script>
      document.getElementById("homeBtn").addEventListener("click", () => {
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
